<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #141821;
            --bg-card: #1a1f2e;
            --border-color: #2a3142;
            --text-primary: #e4e8f0;
            --text-secondary: #8892a6;
            --accent-green: #00ff88;
            --accent-blue: #00b4ff;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --accent-purple: #a55eea;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            color: var(--bg-primary);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* Sidebar Navigation (YouTube Style) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: var(--sidebar-width);
            height: calc(100vh - 70px);
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
            z-index: 900;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(0, 180, 255, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: var(--accent-green);
            color: var(--accent-green);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 15px 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .col-3 { grid-column: span 3; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-8 { grid-column: span 8; }
        .col-12 { grid-column: span 12; }

        /* KPI Cards */
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .kpi-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .kpi-change {
            font-size: 12px;
            color: var(--accent-green);
            margin-top: 8px;
        }

        /* Date Navigator */
        .date-navigator {
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .date-display {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 700;
            flex: 1;
            text-align: center;
            color: var(--accent-green);
        }

        .btn-nav {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-nav:hover {
            border-color: var(--accent-blue);
            background: rgba(0, 180, 255, 0.1);
        }

        /* Improved Tables */
        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .table-title {
            background: var(--bg-secondary);
            padding: 20px 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border-color);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--bg-secondary);
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-primary);
        }

        .table tr:hover {
            background: rgba(0, 180, 255, 0.05);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            height: 400px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: rgba(0, 255, 136, 0.15); color: var(--accent-green); }
        .badge.warning { background: rgba(255, 217, 61, 0.15); color: var(--accent-yellow); }
        .badge.error { background: rgba(255, 71, 87, 0.15); color: var(--accent-red); }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Setup Panel */
        .setup-panel {
            background: var(--bg-card);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 40px;
            margin: 100px auto;
            max-width: 800px;
        }

        .setup-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-yellow);
        }

        .setup-instructions {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-blue);
            padding: 16px;
            margin: 20px 0;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        @media (max-width: 1200px) {
            .col-3, .col-4 { grid-column: span 6; }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .col-3, .col-4, .col-6, .col-8 {
                grid-column: span 12;
            }
        }

        /* Batch Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 180, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--accent-red);
            transform: rotate(90deg);
        }

        .batch-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .batch-info-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-green);
        }

        .batch-info-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .batch-info-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .batch-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s ease;
        }

        .batch-link:hover {
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        /* Batch Input Form */
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 180, 255, 0.1);
        }

        .form-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #00cc70);
            color: var(--bg-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .calculated-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-yellow);
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 2px solid var(--accent-yellow);
        }
        .palantir-page.active {
            padding: 0 !important;
            height: calc(100vh - 60px) !important;
            display: flex !important;
            flex-direction: column !important;
        }
        @keyframes palantir-pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(123,47,247,0.6), 0 0 60px rgba(0,198,255,0.2); }
            50%       { box-shadow: 0 0 50px rgba(123,47,247,0.9), 0 0 100px rgba(0,198,255,0.4); }
        }
        @keyframes palantir-shimmer {
            0%   { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        @keyframes palantir-blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.3; }
        }
        @keyframes palantir-fadein {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes palantir-typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40%            { transform: scale(1);   opacity: 1; }
        }
        #palantir-messages::-webkit-scrollbar { width: 4px; }
        #palantir-messages::-webkit-scrollbar-track { background: transparent; }
        #palantir-messages::-webkit-scrollbar-thumb { background: rgba(123,47,247,0.4); border-radius: 2px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">PRODUCTION ANALYTICS</div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="status-text">LIVE</span>
            </div>
            <div class="status-indicator">
                <span id="last-update">--:--</span>
            </div>
            <div class="status-indicator" id="refresh-countdown" style="color: var(--accent-green); font-size: 12px;">
                üîÑ 15s
            </div>
            <button class="btn" onclick="openSettings()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); margin-right: 8px;">‚öôÔ∏è Settings</button>
            <button class="btn" onclick="loadAllData()">REFRESH</button>
        </div>
    </div>

    <!-- Sidebar Navigation (YouTube Style) -->
    <div class="sidebar">
        <div class="nav-item active" onclick="showPage('daily-view')">
            <div class="nav-icon">üìÖ</div>
            <div>Daily Production</div>
        </div>
        <div class="nav-item" onclick="showPage('vessel-tracker')">
            <div class="nav-icon">üè∫</div>
            <div>Vessel Tracker</div>
        </div>
        <div class="nav-item" onclick="showPage('live-monitor')">
            <div class="nav-icon">üî¥</div>
            <div>Live Monitor</div>
        </div>
        <div class="nav-item" onclick="showPage('quality-control')">
            <div class="nav-icon">üéØ</div>
            <div>Quality Control</div>
        </div>
        <div class="nav-item" onclick="showPage('equipment-analysis')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>Equipment Analysis</div>
        </div>
        <div class="nav-item" onclick="showPage('daily-report')">
            <div class="nav-icon">üìä</div>
            <div>Daily Report</div>
        </div>
        <div class="nav-item" onclick="showPage('product-search')">
            <div class="nav-icon">üîç</div>
            <div>Product Analysis</div>
        </div>
        <div class="nav-item" onclick="showPage('batch-search')">
            <div class="nav-icon">üóÇÔ∏è</div>
            <div>Batch Search</div>
        </div>
        <div class="nav-item" onclick="showPage('attendance')">
            <div class="nav-icon">üë∑</div>
            <div>Attendance</div>
        </div>
        <div class="nav-item" onclick="showPage('operator-performance')">
            <div class="nav-icon">üèÜ</div>
            <div>Operator Performance</div>
        </div>
        <div class="nav-item" onclick="showPage('palantir')">
            <div class="nav-icon" style="font-size:20px;">üîÆ</div>
            <div style="background: linear-gradient(90deg, #00c6ff, #7b2ff7); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700;">Palantir</div>
        </div>
        
        <div class="nav-divider"></div>
        
        <div class="nav-item" onclick="showPage('auto-reports')">
            <div class="nav-icon">üìà</div>
            <div>Weekly/Monthly Reports</div>
        </div>
        <div class="nav-item" onclick="showPage('category-reports')">
            <div class="nav-icon">üìë</div>
            <div>Category Reports</div>
        </div>
        <div class="nav-item" onclick="showPage('category-range')">
            <div class="nav-icon">üìÜ</div>
            <div>Category by Date Range</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:var(--bg-primary); border:1px solid var(--border-color); border-radius:12px; padding:35px; width:600px; max-width:95vw; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="color:var(--accent-green); margin:0;">‚öôÔ∏è Dashboard Settings</h2>
                <button onclick="closeSettings()" style="background:none; border:none; color:var(--text-secondary); font-size:24px; cursor:pointer;">‚úï</button>
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-primary);">Google Sheet ID</label>
                <input id="settings-sheet-id" class="form-input" type="text" placeholder="Your Sheet ID">
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--text-primary);">Google Sheets API Key</label>
                <input id="settings-api-key" class="form-input" type="text" placeholder="AIzaSy...">
            </div>

            <div style="margin-bottom:25px;">
                <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--accent-green);">üîë Apps Script URL <span style="font-size:12px; color:var(--text-secondary);">(for saving batch details)</span></label>
                <input id="settings-script-url" class="form-input" type="text" placeholder="https://script.google.com/macros/s/.../exec">
                <div style="margin-top:10px; padding:12px; background:var(--bg-secondary); border-radius:8px; font-size:13px; color:var(--text-secondary); line-height:1.6;">
                    <strong style="color:var(--text-primary);">Don't have this URL yet?</strong><br>
                    1. Open your Google Sheet ‚Üí <strong>Extensions ‚Üí Apps Script</strong><br>
                    2. Delete all code, paste the Apps Script code<br>
                    3. <strong>Deploy ‚Üí New deployment ‚Üí Web app ‚Üí Anyone ‚Üí Deploy</strong><br>
                    4. Copy the URL and paste it above
                </div>
            </div>

            <div style="display:flex; gap:12px;">
                <button class="btn-success" onclick="saveSettings()" style="flex:1; padding:14px;">‚úÖ Save Settings</button>
                <button class="btn" onclick="closeSettings()" style="padding:14px 24px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Batch Detail Modal -->
    <div id="batch-modal" class="modal-overlay" onclick="closeBatchModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Batch Details</div>
                <button class="modal-close" onclick="closeBatchModal()">√ó</button>
            </div>
            <div id="batch-modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div id="setup-container"></div>

        <div id="main-dashboard" style="display: none;">
            
            <!-- PAGE 1: Daily Production View -->
            <div id="daily-view" class="page-content active">
                <h1 class="page-title">Daily Production View</h1>
                
                <div class="date-navigator">
                    <button class="btn-nav" onclick="changeDate(-1)">‚óÄ Previous Day</button>
                    <div class="date-display" id="current-date-display">Today</div>
                    <button class="btn-nav" onclick="changeDate(1)">Next Day ‚ñ∂</button>
                    <button class="btn-nav" onclick="setToday()">Today</button>
                </div>

                <!-- Summary KPIs -->
                <div class="grid">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Weight Produced (All Time)</div>
                        <div class="kpi-value" id="total-weight-alltime">-</div>
                        <div class="kpi-change" id="total-entries">-- entries</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Products Filled (All Time)</div>
                        <div class="kpi-value" id="total-products-filled">-</div>
                        <div class="kpi-change">unique batches</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Today's Production</div>
                        <div class="kpi-value" id="today-production">-</div>
                        <div class="kpi-change" id="today-entries">-- entries</div>
                    </div>
                </div>

                <!-- Production Schedule Table -->
                <div class="data-table">
                    <div class="table-title">PRODUCTION SCHEDULE</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Product Name</th>
                                    <th>Batch</th>
                                    <th>Weight</th>
                                    <th>Actual Weight</th>
                                    <th>% Yield</th>
                                    <th>Yield Verdict</th>
                                    <th>Vessel</th>
                                    <th>Suggested Mixers</th>
                                    <th>Suggested Grinders</th>
                                    <th>Equipment</th>
                                </tr>
                            </thead>
                            <tbody id="production-tbody">
                                <tr><td colspan="11" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Filling Operations Table -->
                <div class="data-table">
                    <div class="table-title">FILLING OPERATIONS</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Product Name</th>
                                    <th>Batch</th>
                                    <th>Filling Type</th>
                                    <th>Package Type</th>
                                    <th>Quantity</th>
                                    <th>Types of Boxes Used</th>
                                    <th>Quantity of Boxes</th>
                                    <th>Time per Package</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                </tr>
                            </thead>
                            <tbody id="filling-tbody">
                                <tr><td colspan="11" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAGE: Revolutionary Vessel Tracker -->
            <div id="vessel-tracker" class="page-content">
                <h1 class="page-title">üè∫ Vessel Availability Tracker</h1>
                
                <!-- Real-Time Status Summary -->
                <div class="grid" style="margin-bottom: 30px;">
                    <div class="kpi-card col-4" style="background: linear-gradient(135deg, #00ff88, #00cc6a);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Available Vessels</div>
                        <div class="kpi-value" style="color: white;" id="vessel-available-count">0</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);">Ready for production</div>
                    </div>
                    <div class="kpi-card col-4" style="background: linear-gradient(135deg, #ffc107, #ff9500);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">In Production</div>
                        <div class="kpi-value" style="color: white;" id="vessel-production-count">0</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);">Currently occupied</div>
                    </div>
                    <div class="kpi-card col-4" style="background: linear-gradient(135deg, #00b4ff, #0088cc);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Utilization Rate</div>
                        <div class="kpi-value" style="color: white;" id="vessel-utilization">0%</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);">Today</div>
                    </div>
                </div>

                <!-- Visual Vessel Status Cards -->
                <div id="vessel-cards-container" style="margin-bottom: 30px;">
                    <!-- Vessel cards will be generated here -->
                </div>

                <!-- Timeline View -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent-blue);">üìÖ Today's Vessel Timeline</h3>
                    <div id="vessel-timeline">
                        <!-- Timeline will be generated here -->
                    </div>
                </div>

                <!-- Detailed Vessel Status Table -->
                <div class="card">
                    <h3 style="margin-bottom: 20px; color: var(--accent-green);">üìä Detailed Vessel Status</h3>
                    <div class="data-table">
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Vessel</th>
                                        <th>Status</th>
                                        <th>Current Batch</th>
                                        <th>Product</th>
                                        <th>Started</th>
                                        <th>Expected End</th>
                                        <th>Duration</th>
                                        <th>Color</th>
                                    </tr>
                                </thead>
                                <tbody id="vessel-status-tbody">
                                    <tr><td colspan="8" class="loading">Loading vessel data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vessel History -->
                <div class="card" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent-purple);">üìú Recent Vessel Activity</h3>
                    <div id="vessel-history">
                        <!-- History will be generated here -->
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                    <button class="btn-secondary" onclick="refreshVesselTracker()">üîÑ Refresh Status</button>
                </div>
            </div>

            <!-- PAGE: Real-Time Live Monitor -->
            <div id="live-monitor" class="page-content">
                <h1 class="page-title">üî¥ Live Production Monitor</h1>
                
                <!-- Real-Time Stats -->
                <div class="grid">
                    <div class="kpi-card col-3" style="background: linear-gradient(135deg, var(--accent-green), #00cc6a);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Today's Progress</div>
                        <div class="kpi-value" style="color: white;" id="live-today-production">0 KG</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);" id="live-today-progress">0% of target</div>
                    </div>
                    <div class="kpi-card col-3" style="background: linear-gradient(135deg, var(--accent-blue), #0088cc);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Batches Today</div>
                        <div class="kpi-value" style="color: white;" id="live-batches-count">0</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);" id="live-batches-target">Target: 15</div>
                    </div>
                    <div class="kpi-card col-3" style="background: linear-gradient(135deg, var(--accent-yellow), #ff9500);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Active Issues</div>
                        <div class="kpi-value" style="color: white;" id="live-issues-count">0</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);">Problems today</div>
                    </div>
                    <div class="kpi-card col-3" style="background: linear-gradient(135deg, var(--accent-purple), #9b59b6);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.9);">Avg Yield</div>
                        <div class="kpi-value" style="color: white;" id="live-avg-yield">0%</div>
                        <div class="kpi-change" style="color: rgba(255,255,255,0.8);">Today's average</div>
                    </div>
                </div>

                <!-- Alert Panel -->
                <div class="card" id="live-alerts-panel" style="background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,193,7,0.1)); border: 2px solid var(--accent-red);">
                    <h3 style="color: var(--accent-red); margin-bottom: 15px;">üö® Active Alerts</h3>
                    <div id="live-alerts-list">
                        <p style="color: var(--text-secondary);">No alerts - All systems running smoothly</p>
                    </div>
                </div>

                <!-- Current Batches in Progress -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">‚è±Ô∏è Recent Batches (Last 5)</h3>
                    <div class="data-table">
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Batch #</th>
                                        <th>Product</th>
                                        <th>Status</th>
                                        <th>Yield</th>
                                        <th>Problems</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="live-batches-tbody">
                                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Equipment Status -->
                <div class="grid">
                    <div class="card col-6">
                        <h3 style="color: var(--accent-green); margin-bottom: 15px;">üîß Mixers Status</h3>
                        <div id="live-mixers-status">Loading...</div>
                    </div>
                    <div class="card col-6">
                        <h3 style="color: var(--accent-blue); margin-bottom: 15px;">‚öôÔ∏è Grinders Status</h3>
                        <div id="live-grinders-status">Loading...</div>
                    </div>
                </div>

                <!-- Hourly Production Chart -->
                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Hourly Production Today</div>
                            <canvas id="hourly-production-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                    <p>Auto-refreshing every 30 seconds | Last updated: <span id="live-last-update">--:--</span></p>
                    <button class="btn-secondary" onclick="refreshLiveData()">üîÑ Refresh Now</button>
                </div>
            </div>

            <!-- PAGE: Advanced Quality Control -->
            <div id="quality-control" class="page-content">
                <h1 class="page-title">üéØ Advanced Quality Control</h1>

                <!-- Date Range Selector -->
                <div class="grid">
                    <div class="card col-6">
                        <div class="form-group">
                            <label class="form-label">Analysis Period</label>
                            <select id="quality-period" class="form-input" onchange="loadQualityData()">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="quality-custom-dates" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="quality-start-date" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="date" id="quality-end-date" class="form-input">
                                </div>
                            </div>
                            <button class="btn" onclick="loadQualityData()">ANALYZE</button>
                        </div>
                    </div>
                </div>

                <!-- Quality Summary KPIs -->
                <div class="grid">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Overall Quality Score</div>
                        <div class="kpi-value" id="quality-overall-score">--</div>
                        <div class="kpi-change" id="quality-score-change">--</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Problem-Free Batches</div>
                        <div class="kpi-value" id="quality-clean-batches">--</div>
                        <div class="kpi-change" id="quality-clean-percent">--</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Avg Yield Performance</div>
                        <div class="kpi-value" id="quality-avg-yield">--</div>
                        <div class="kpi-change" id="quality-yield-trend">--</div>
                    </div>
                </div>

                <!-- Problem Frequency Analysis -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üìä Problem Frequency Analysis</h3>
                    <div class="grid">
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Problems by Type</div>
                                <canvas id="problem-frequency-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Problem Trend Over Time</div>
                                <canvas id="problem-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Problem Details Table -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üîç Detailed Problem Log</h3>
                    <div class="data-table">
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Batch #</th>
                                        <th>Product</th>
                                        <th>Problem Type</th>
                                        <th>Details</th>
                                        <th>Resolution</th>
                                        <th>Downtime</th>
                                    </tr>
                                </thead>
                                <tbody id="quality-problems-tbody">
                                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Yield Distribution -->
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Yield Distribution</div>
                            <canvas id="yield-distribution-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Quality Score by Product Category</div>
                            <canvas id="category-quality-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Operator Performance (if operator data available) -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üë• Top Issue-Prone Products</h3>
                    <div id="quality-problem-products">Loading...</div>
                </div>

                <!-- Statistical Process Control -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üìà Quality Trends (Statistical Process Control)</h3>
                    <div class="chart-container">
                        <div class="chart-title">Daily Quality Score with Control Limits</div>
                        <canvas id="spc-chart"></canvas>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9em;">
                        Green zone (80-100): Excellent | Yellow zone (60-80): Acceptable | Red zone (<60): Needs Attention
                    </p>
                </div>

                <!-- Root Cause Analysis -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üî¨ Root Cause Analysis</h3>
                    <div id="quality-root-cause">
                        <p style="color: var(--text-secondary);">Analyzing problem patterns...</p>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: Equipment Analysis -->
            <div id="equipment-analysis" class="page-content">
                <h1 class="page-title">Equipment Usage Analysis</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="equip-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="equip-end-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Equipment Code</label>
                            <input type="text" id="equip-code" class="form-input" placeholder="e.g., MX05 or GR01">
                        </div>
                        <button class="btn" onclick="runEquipmentAnalysis()">ANALYZE</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Analysis Results</h3>
                    <div id="equipment-results">
                        <p style="color: var(--text-secondary);">Enter parameters above and click "ANALYZE"</p>
                    </div>
                </div>

                <div class="grid" style="margin-top: 20px;">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Equipment Usage by Category</div>
                            <canvas id="equipment-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: Daily Report -->
            <div id="daily-report" class="page-content">
                <h1 class="page-title">Daily Production Report</h1>
                
                <div class="grid">
                    <div class="card col-6">
                        <div class="form-group">
                            <label class="form-label">Select Report Date</label>
                            <input type="date" id="daily-report-date" class="form-input">
                        </div>
                        <button class="btn" onclick="generateDailyReport()">GENERATE REPORT</button>
                    </div>
                </div>

                <div id="daily-report-content"></div>

                <!-- Trend Charts for Daily Report -->
                <div id="daily-trend-charts" style="display: none;">
                    <h3 style="margin: 30px 0 20px;">Performance Trends (Last 30 Days)</h3>
                    <div class="grid">
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">KPI Score Over Time</div>
                                <canvas id="kpi-trend-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Products Filled Over Time</div>
                                <canvas id="products-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Daily Production Weight (Last 30 Days)</div>
                                <canvas id="weight-trend-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Filling Hours Over Time</div>
                                <canvas id="hours-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart containers for daily report -->
                <div id="daily-charts-section" style="display: none;">
                    <h3 style="margin: 30px 0 20px;">Equipment Usage Today</h3>
                    <div class="grid">
                        <div class="col-12">
                            <div class="chart-container">
                                <div class="chart-title">Equipment Sessions</div>
                                <canvas id="daily-equipment-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 4: Product Search -->
            <div id="product-search" class="page-content">
                <h1 class="page-title">Product Analysis</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Product Name</label>
                            <input type="text" id="product-name" class="form-input" placeholder="Enter product name">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="product-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="product-end-date" class="form-input">
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="analyzeProduct()">ANALYZE PRODUCT</button>

                <div class="grid" style="margin-top: 25px;">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Weight</div>
                        <div class="kpi-value" id="product-total-weight">-</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Batches</div>
                        <div class="kpi-value" id="product-total-batches">-</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Average Batch Size</div>
                        <div class="kpi-value" id="product-avg-batch">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production Weight</div>
                            <canvas id="product-timeline-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: OPERATOR PERFORMANCE -->
            <div id="operator-performance" class="page-content">
                <h1 class="page-title">üèÜ Operator Performance</h1>

                <!-- End of month notice -->
                <div id="op-month-notice" style="margin-bottom:20px; padding:14px 18px; border-radius:10px; font-size:13px; display:flex; align-items:center; gap:10px;"></div>

                <!-- Tab switcher -->
                <div style="display:flex; gap:8px; margin-bottom:24px;">
                    <button id="op-tab-grade"  onclick="switchOpTab('grade')"  class="btn-success"   style="padding:10px 24px;">‚úèÔ∏è Grade Workers</button>
                    <button id="op-tab-scores" onclick="switchOpTab('scores')" class="btn-secondary" style="padding:10px 24px;">üèÖ Scoreboard</button>
                </div>

                <!-- GRADE TAB -->
                <div id="op-grade">
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">SELECT WORKER</label>
                                <select id="op-grade-worker" class="form-input" style="width:240px;" onchange="loadWorkerGradeForm()">
                                    <option value="">-- Choose Worker --</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">EVALUATION MONTH</label>
                                <select id="op-grade-month" class="form-input" style="width:220px;" onchange="loadWorkerGradeForm()">
                                </select>
                            </div>
                            <div id="op-grade-status" style="font-size:13px; padding:8px 14px; border-radius:8px;"></div>
                        </div>
                    </div>
                    <div id="op-grade-form"></div>
                </div>

                <!-- SCOREBOARD TAB -->
                <div id="op-scores" style="display:none;">
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">PERIOD</label>
                                <select id="op-scores-month" class="form-input" style="width:220px;"></select>
                            </div>
                            <button class="btn-success" onclick="loadScoreboard()" style="padding:12px 24px;">üìä Load Scoreboard</button>
                            <button onclick="loadTrendReport()" style="padding:12px 20px; background:rgba(255,193,7,0.15); border:1px solid #ffc107; color:#ffc107; border-radius:8px; cursor:pointer; font-size:13px; font-weight:700;">üìà Score Trend Report</button>
                        </div>
                    </div>
                    <div id="op-scoreboard-results"></div>
                </div>
            </div>

            <!-- PAGE: ATTENDANCE -->
            <div id="attendance" class="page-content">
                <h1 class="page-title">üë∑ Worker Attendance</h1>

                <!-- Tab Switcher -->
                <div style="display:flex; gap:8px; margin-bottom:25px;">
                    <button id="att-tab-today" onclick="switchAttTab('today')" class="btn-success" style="padding:10px 24px;">üìã Today</button>
                    <button id="att-tab-history" onclick="switchAttTab('history')" class="btn-secondary" style="padding:10px 24px;">üìÖ History</button>
                    <button id="att-tab-stats" onclick="switchAttTab('stats')" class="btn-secondary" style="padding:10px 24px;">üìä Worker Stats</button>
                </div>

                <!-- TODAY TAB -->
                <div id="att-today">
                    <!-- KPI Cards -->
                    <div class="grid" style="margin-bottom:25px;">
                        <div class="card col-3" style="text-align:center; border-left:4px solid var(--accent-green);">
                            <div style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">PRESENT</div>
                            <div id="att-present-count" style="font-size:42px; font-weight:800; color:var(--accent-green);">0</div>
                        </div>
                        <div class="card col-3" style="text-align:center; border-left:4px solid #ff4444;">
                            <div style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">ABSENT</div>
                            <div id="att-absent-count" style="font-size:42px; font-weight:800; color:#ff4444;">0</div>
                        </div>
                        <div class="card col-3" style="text-align:center; border-left:4px solid #ffc107;">
                            <div style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">LATE</div>
                            <div id="att-late-count" style="font-size:42px; font-weight:800; color:#ffc107;">0</div>
                        </div>
                        <div class="card col-3" style="text-align:center; border-left:4px solid var(--accent-blue);">
                            <div style="font-size:13px; color:var(--text-secondary); margin-bottom:8px;">ATTENDANCE RATE</div>
                            <div id="att-rate" style="font-size:42px; font-weight:800; color:var(--accent-blue);">0%</div>
                        </div>
                    </div>

                    <!-- Date selector + Save -->
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">DATE</label>
                                <input type="date" id="att-date" class="form-input" style="width:180px;" onchange="loadAttendanceForDate()">
                            </div>
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">SHIFT START ¬∑ LATE AFTER 07:40</label>
                                <input type="time" id="att-shift-start" class="form-input" style="width:140px;" value="07:30">
                            </div>
                            <div style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn-success" onclick="saveAttendance()" style="padding:12px 28px; font-size:14px;">üíæ Save</button>
                                <button class="btn-secondary" onclick="markAllPresent()" style="padding:12px 16px;">‚úÖ All Present</button>
                                <button class="btn-secondary" onclick="markAllAbsent()" style="padding:12px 16px;">‚ùå All Absent</button>
                                <button onclick="addNewWorkerPrompt()" style="padding:12px 16px; background:rgba(0,198,255,0.15); border:1px solid var(--accent-blue); color:var(--accent-blue); border-radius:8px; cursor:pointer; font-size:13px; font-weight:700;">‚ûï Add Worker</button>
                                <button onclick="generateAttendancePDF()" style="padding:12px 16px; background:rgba(255,193,7,0.15); border:1px solid #ffc107; color:#ffc107; border-radius:8px; cursor:pointer; font-size:13px; font-weight:700;">üìÑ Export PDF</button>
                            </div>
                        </div>
                        <div style="margin-top:12px; padding:10px 14px; background:rgba(0,255,136,0.05); border-radius:8px; font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:8px;">
                            <span style="color:var(--accent-green);">üïó</span>
                            Auto-PDF downloads every morning at <strong style="color:var(--accent-green);">08:00 AM</strong> ‚Äî keep the dashboard open overnight
                        </div>
                    </div>

                    <!-- Worker Grid -->
                    <div id="att-worker-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:14px;"></div>
                </div>

                <!-- HISTORY TAB -->
                <div id="att-history" style="display:none;">
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">FROM</label>
                                <input type="date" id="att-from" class="form-input" style="width:170px;">
                            </div>
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">TO</label>
                                <input type="date" id="att-to" class="form-input" style="width:170px;">
                            </div>
                            <button class="btn-success" onclick="loadAttendanceHistory()" style="padding:12px 24px;">üîç Search</button>
                        </div>
                    </div>
                    <div id="att-history-results"></div>
                </div>

                <!-- STATS TAB -->
                <div id="att-stats" style="display:none;">
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">FROM</label>
                                <input type="date" id="att-stats-from" class="form-input" style="width:170px;">
                            </div>
                            <div>
                                <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">TO</label>
                                <input type="date" id="att-stats-to" class="form-input" style="width:170px;">
                            </div>
                            <button class="btn-success" onclick="loadWorkerStats()" style="padding:12px 24px;">üìä Load Stats</button>
                        </div>
                    </div>
                    <div id="att-stats-results"></div>
                </div>
            </div>

            <!-- PAGE: PALANTIR AI -->
            <div id="palantir" class="page-content palantir-page">

                <!-- Palantir Header -->
                <div style="padding: 28px 32px 20px; background: linear-gradient(135deg, #0a0a1a 0%, #0d1117 100%); border-bottom: 1px solid #1a1a2e; flex-shrink:0;">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="position:relative;">
                            <div style="width:52px; height:52px; border-radius:50%; background: radial-gradient(circle at 35% 35%, #7b2ff7, #00c6ff 60%, #0d1117); box-shadow: 0 0 30px rgba(123,47,247,0.6), 0 0 60px rgba(0,198,255,0.2); animation: palantir-pulse 3s ease-in-out infinite;"></div>
                            <div style="position:absolute; inset:0; border-radius:50%; border:1px solid rgba(123,47,247,0.4);"></div>
                        </div>
                        <div>
                            <div style="font-size:26px; font-weight:800; letter-spacing:3px; background: linear-gradient(90deg, #00c6ff, #7b2ff7, #00c6ff); background-size:200%; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation: palantir-shimmer 4s linear infinite;">PALANTIR</div>
                            <div style="font-size:12px; color:#5a6a8a; letter-spacing:2px; margin-top:2px;">PAINTS & COATINGS INTELLIGENCE</div>
                        </div>
                        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                            <div style="width:8px; height:8px; border-radius:50%; background:#00c6ff; box-shadow:0 0 8px #00c6ff; animation: palantir-blink 2s infinite;"></div>
                            <span style="font-size:12px; color:#5a6a8a; letter-spacing:1px;">ONLINE</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages Area -->
                <div id="palantir-messages" style="flex:1; overflow-y:auto; padding:24px 32px; display:flex; flex-direction:column; gap:20px; background: radial-gradient(ellipse at 20% 50%, rgba(123,47,247,0.03) 0%, transparent 60%), radial-gradient(ellipse at 80% 20%, rgba(0,198,255,0.03) 0%, transparent 60%), #0d1117;">

                    <!-- Welcome message -->
                    <div class="palantir-msg palantir-ai" style="display:flex; gap:14px; align-items:flex-start; animation: palantir-fadein 0.5s ease;">
                        <div style="width:36px; height:36px; border-radius:50%; background: radial-gradient(circle at 35% 35%, #7b2ff7, #00c6ff); flex-shrink:0; box-shadow:0 0 15px rgba(123,47,247,0.5);"></div>
                        <div style="background: linear-gradient(135deg, #0f0f2a, #12122a); border:1px solid rgba(123,47,247,0.3); border-radius:4px 16px 16px 16px; padding:18px 22px; max-width:680px; line-height:1.7;">
                            <div style="font-size:13px; font-weight:700; color:#7b2ff7; letter-spacing:2px; margin-bottom:10px;">PALANTIR</div>
                            <div style="color:#c8d0e0; font-size:14px;">Hey!! Welcome! I am <strong style="color:#00c6ff;">Palantir</strong> ‚Äî 30 years in paints and coatings and still loving every day of it. What can I help you with today?</div>
                            <div style="color:#c8d0e0; font-size:14px; margin-top:8px;">Ask me anything about formulation, raw materials, troubleshooting, quality control, and more.</div>
                            <div style="margin-top:16px; display:flex; flex-wrap:wrap; gap:8px;">
                                <span onclick="useSuggestion('What causes paint to yellow over time?')" style="cursor:pointer; background:rgba(123,47,247,0.15); border:1px solid rgba(123,47,247,0.3); color:#a78bfa; padding:6px 12px; border-radius:20px; font-size:12px;">What causes paint to yellow over time?</span>
                                <span onclick="useSuggestion('Explain viscosity in coatings')" style="cursor:pointer; background:rgba(123,47,247,0.15); border:1px solid rgba(123,47,247,0.3); color:#a78bfa; padding:6px 12px; border-radius:20px; font-size:12px;">Explain viscosity in coatings</span>
                                <span onclick="useSuggestion('What is a good TiO2 loading for white paint?')" style="cursor:pointer; background:rgba(123,47,247,0.15); border:1px solid rgba(123,47,247,0.3); color:#a78bfa; padding:6px 12px; border-radius:20px; font-size:12px;">Good TiO2 loading for white paint?</span>
                                <span onclick="useSuggestion('How do I fix poor hiding power?')" style="cursor:pointer; background:rgba(123,47,247,0.15); border:1px solid rgba(123,47,247,0.3); color:#a78bfa; padding:6px 12px; border-radius:20px; font-size:12px;">How do I fix poor hiding power?</span>
                                <span onclick="useSuggestion('Difference between alkyd and epoxy?')" style="cursor:pointer; background:rgba(123,47,247,0.15); border:1px solid rgba(123,47,247,0.3); color:#a78bfa; padding:6px 12px; border-radius:20px; font-size:12px;">Difference between alkyd and epoxy?</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div style="padding:20px 32px 24px; background:#0a0a1a; border-top:1px solid #1a1a2e; flex-shrink:0;">
                    <div style="display:flex; gap:12px; align-items:flex-end; max-width:900px; margin:0 auto;">
                        <div style="flex:1; position:relative;">
                            <textarea id="palantir-input"
                                placeholder="Ask anything about paints, coatings, formulation, raw materials..."
                                style="width:100%; background:#0f0f2a; border:1px solid rgba(123,47,247,0.3); border-radius:14px; padding:14px 18px; color:#e0e8f0; font-size:14px; font-family:inherit; resize:none; min-height:52px; max-height:160px; line-height:1.5; outline:none; transition:border-color 0.2s; box-sizing:border-box;"
                                rows="1"
                                onfocus="this.style.borderColor='rgba(123,47,247,0.7)'"
                                onblur="this.style.borderColor='rgba(123,47,247,0.3)'"
                                onkeydown="palantirKeyDown(event)"
                                oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,160)+'px'">
                            </textarea>
                        </div>
                        <button id="palantir-send-btn" onclick="sendPalantirMessage()"
                            style="width:52px; height:52px; border-radius:50%; background: linear-gradient(135deg, #7b2ff7, #00c6ff); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all 0.2s; box-shadow:0 0 20px rgba(123,47,247,0.4); flex-shrink:0;"
                            onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 0 30px rgba(123,47,247,0.7)'"
                            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0 20px rgba(123,47,247,0.4)'">
                            ‚û§
                        </button>
                    </div>
                    <div style="text-align:center; margin-top:10px; font-size:11px; color:#3a4a6a; letter-spacing:1px;">
                        PALANTIR ¬∑ SPECIALIZED IN PAINTS & COATINGS INDUSTRY ¬∑ PRESS ENTER TO SEND
                    </div>
                </div>
            </div>

            <!-- PAGE: Batch Search -->
            <div id="batch-search" class="page-content">
                <h1 class="page-title">üóÇÔ∏è Batch Search</h1>

                <!-- Search Bar -->
                <div class="card" style="margin-bottom: 25px;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="batch-search-input" class="form-input"
                            placeholder="Enter batch number... e.g. 123"
                            style="flex: 1; min-width: 200px; font-size: 18px; padding: 14px 18px;"
                            oninput="searchBatch()"
                            onkeydown="if(event.key==='Enter') searchBatch()">
                        <button class="btn-success" onclick="searchBatch()" style="padding: 14px 30px; font-size: 16px; white-space: nowrap;">
                            üîç Search
                        </button>
                        <button class="btn-secondary" onclick="clearBatchSearch()" style="padding: 14px 20px;">
                            ‚úï Clear
                        </button>
                    </div>
                    <div id="batch-search-hint" style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">
                        Type a batch number to see all production details and saved edits
                    </div>
                </div>

                <!-- Results -->
                <div id="batch-search-results">
                    <!-- Populated by searchBatch() -->
                </div>
            </div>

            <!-- PAGE 5: Auto Reports -->
            <div id="auto-reports" class="page-content">
                <h1 class="page-title">Weekly & Monthly Reports</h1>
                
                <!-- Custom Date Range Selector -->
                <div class="grid" style="margin-bottom: 30px;">
                    <div class="card col-12">
                        <h3 style="margin-bottom: 20px; color: var(--accent-green);">Custom Timeframe Analysis</h3>
                        <div class="grid">
                            <div class="col-3">
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="custom-report-start" class="form-input">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="date" id="custom-report-end" class="form-input">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label class="form-label">Quick Select</label>
                                    <select id="quick-select-range" class="form-input" onchange="applyQuickSelect()">
                                        <option value="">Choose timeframe...</option>
                                        <option value="this-week">This Week</option>
                                        <option value="last-week">Last Week</option>
                                        <option value="this-month">This Month</option>
                                        <option value="last-month">Last Month</option>
                                        <option value="last-7-days">Last 7 Days</option>
                                        <option value="last-30-days">Last 30 Days</option>
                                        <option value="this-quarter">This Quarter</option>
                                        <option value="this-year">This Year</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <button class="btn" onclick="generateCustomReport()" style="margin-top: 28px; width: 100%;">GENERATE REPORT</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Report Results -->
                <div id="custom-report-section" style="display: none;">
                    <h2 style="margin: 30px 0 20px; color: var(--accent-purple);">Custom Period Report</h2>
                    <div class="grid">
                        <div class="kpi-card col-3">
                            <div class="kpi-label">Total Production</div>
                            <div class="kpi-value" id="custom-total">-</div>
                        </div>
                        <div class="kpi-card col-3">
                            <div class="kpi-label">Unique Products</div>
                            <div class="kpi-value" id="custom-products">-</div>
                        </div>
                        <div class="kpi-card col-3">
                            <div class="kpi-label">Daily Average</div>
                            <div class="kpi-value" id="custom-avg">-</div>
                        </div>
                        <div class="kpi-card col-3">
                            <div class="kpi-label">Period</div>
                            <div class="kpi-value" id="custom-period" style="font-size: 16px;">-</div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="col-12">
                            <div class="chart-container">
                                <div class="chart-title">Daily Production (Custom Period)</div>
                                <canvas id="custom-period-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Category Breakdown</div>
                                <canvas id="custom-category-pie"></canvas>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="chart-container">
                                <div class="chart-title">Category Weights</div>
                                <canvas id="custom-category-bar"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products Table -->
                    <div class="data-table" style="margin-top: 30px;">
                        <div class="table-title">TOP 20 PRODUCTS (CUSTOM PERIOD)</div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Product Name</th>
                                        <th>Total Weight (KG)</th>
                                        <th>Percentage</th>
                                        <th>Batches</th>
                                    </tr>
                                </thead>
                                <tbody id="custom-products-tbody">
                                    <tr><td colspan="5" class="loading">Generate report to see data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="border-top: 2px solid var(--border-color); margin: 40px 0;"></div>
                
                <h2 style="margin: 30px 0 20px; color: var(--accent-green); font-size: 20px;">This Week</h2>
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Week Total</div>
                        <div class="kpi-value" id="week-total">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products</div>
                        <div class="kpi-value" id="week-products">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Daily Average</div>
                        <div class="kpi-value" id="week-avg">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Week Range</div>
                        <div class="kpi-value" id="week-dates" style="font-size: 14px;">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production This Week</div>
                            <canvas id="weekly-chart"></canvas>
                        </div>
                    </div>
                </div>

                <h2 style="margin: 30px 0 20px; color: var(--accent-blue); font-size: 20px;">This Month</h2>
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Month Total</div>
                        <div class="kpi-value" id="month-total">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products</div>
                        <div class="kpi-value" id="month-products">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Daily Average</div>
                        <div class="kpi-value" id="month-avg">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Current Month</div>
                        <div class="kpi-value" id="month-name" style="font-size: 16px;">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production This Month</div>
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 6: Category Reports -->
            <div id="category-reports" class="page-content">
                <h1 class="page-title">Category Production Reports</h1>
                
                <h2 style="margin: 30px 0 20px; color: var(--accent-green); font-size: 20px;">This Week by Category</h2>
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Weekly Category Breakdown</div>
                            <canvas id="week-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Weekly Category Weights</div>
                            <canvas id="week-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <h2 style="margin: 30px 0 20px; color: var(--accent-blue); font-size: 20px;">This Month by Category</h2>
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Monthly Category Breakdown</div>
                            <canvas id="month-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Monthly Category Weights</div>
                            <canvas id="month-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-title">CATEGORY COMPARISON</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>This Week (KG)</th>
                                    <th>This Month (KG)</th>
                                    <th>% of Week</th>
                                    <th>% of Month</th>
                                </tr>
                            </thead>
                            <tbody id="category-tbody">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAGE 7: Category by Date Range -->
            <div id="category-range" class="page-content">
                <h1 class="page-title">Category Production by Date Range</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="category-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="category-end-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <button class="btn" onclick="analyzeCategoryRange()" style="margin-top: 28px;">GENERATE REPORT</button>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Distribution</div>
                            <canvas id="range-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Weights</div>
                            <canvas id="range-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-title">CATEGORY BREAKDOWN</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Weight (KG)</th>
                                    <th>Percentage</th>
                                    <th>Number of Entries</th>
                                </tr>
                            </thead>
                            <tbody id="category-range-tbody">
                                <tr><td colspan="4" class="loading">Select date range and click "GENERATE REPORT"</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        console.log('‚úÖ JavaScript is loading...');
        console.log('Current URL:', window.location.href);
        
        // Global variables
        let SHEET_ID = '';
        let API_KEY = '';
        let SCRIPT_URL = ''; // Google Apps Script Web App URL for writing data
        let currentViewDate = new Date();
        let allProductionData = [];
        let allFillingData = [];
        let allBatchData = {};  // NEW: Store batch detail data (key = batch number)
        let currentReportData = null;  // Store current daily report data for PDF export
        let allVesselData = [];  // Vessel information from Mixer Map
        let chartInstances = {};

        // ==================== EMERGENCY STORAGE TEST ====================
        function emergencyStorageTest() {
            console.clear();
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            console.log('‚ïë  üö® EMERGENCY LOCALSTORAGE DIAGNOSTIC TEST üö®       ‚ïë');
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            
            let hasErrors = false;
            
            // TEST 1: Check if localStorage exists
            console.log('\n[TEST 1] Checking if localStorage exists...');
            if (typeof localStorage === 'undefined') {
                console.error('‚ùå FATAL: localStorage is not defined!');
                console.error('   Your browser does not support localStorage');
                hasErrors = true;
            } else {
                console.log('‚úÖ localStorage object exists');
            }
            
            // TEST 2: Try to write a test value
            console.log('\n[TEST 2] Trying to write test data...');
            try {
                const testKey = 'emergency_test_' + Date.now();
                const testValue = 'test_data_12345';
                localStorage.setItem(testKey, testValue);
                console.log('‚úÖ Write successful');
                
                // TEST 3: Try to read it back
                console.log('\n[TEST 3] Trying to read test data...');
                const readValue = localStorage.getItem(testKey);
                if (readValue === testValue) {
                    console.log('‚úÖ Read successful, data matches!');
                } else {
                    console.error('‚ùå Read failed, data does not match!');
                    console.error('   Expected:', testValue);
                    console.error('   Got:', readValue);
                    hasErrors = true;
                }
                
                // TEST 4: Try to delete it
                console.log('\n[TEST 4] Trying to delete test data...');
                localStorage.removeItem(testKey);
                const checkDeleted = localStorage.getItem(testKey);
                if (checkDeleted === null) {
                    console.log('‚úÖ Delete successful');
                } else {
                    console.error('‚ùå Delete failed, data still exists');
                    hasErrors = true;
                }
                
            } catch (e) {
                console.error('‚ùå FATAL ERROR during write/read:', e);
                console.error('   Error message:', e.message);
                console.error('   Error name:', e.name);
                hasErrors = true;
            }
            
            // TEST 5: Check current batch data
            console.log('\n[TEST 5] Checking current batchDetailsData...');
            try {
                const currentData = localStorage.getItem('batchDetailsData');
                if (currentData) {
                    console.log('‚úÖ batchDetailsData EXISTS in localStorage');
                    console.log('   Size:', currentData.length, 'characters');
                    const parsed = JSON.parse(currentData);
                    console.log('   Batches saved:', Object.keys(parsed));
                    console.log('   Full data:', parsed);
                } else {
                    console.log('‚ö†Ô∏è batchDetailsData does NOT exist in localStorage');
                    console.log('   This is normal if you haven\'t saved any batches yet');
                }
            } catch (e) {
                console.error('‚ùå Error reading batchDetailsData:', e);
                hasErrors = true;
            }
            
            // TEST 6: Check if in private mode
            console.log('\n[TEST 6] Checking for private/incognito mode...');
            try {
                localStorage.setItem('private_test', '1');
                localStorage.removeItem('private_test');
                console.log('‚úÖ Not in private mode (or private mode allows storage)');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('‚ùå LIKELY IN PRIVATE/INCOGNITO MODE!');
                    console.error('   localStorage is blocked in this mode');
                    console.error('   SOLUTION: Use normal browser window');
                    hasErrors = true;
                }
            }
            
            // TEST 7: Test with actual batch-like data
            console.log('\n[TEST 7] Testing with batch-like data structure...');
            try {
                const testBatchData = {
                    '111': {
                        'Vessel Used': 'V1',
                        'Mixer Used (Actual)': 'MX05',
                        'Test': true
                    }
                };
                const jsonStr = JSON.stringify(testBatchData);
                localStorage.setItem('test_batch_structure', jsonStr);
                const readBack = localStorage.getItem('test_batch_structure');
                const parsed = JSON.parse(readBack);
                
                if (parsed['111']['Vessel Used'] === 'V1') {
                    console.log('‚úÖ Complex data structure works!');
                    console.log('   Saved and retrieved:', parsed);
                } else {
                    console.error('‚ùå Data corruption detected');
                    hasErrors = true;
                }
                
                localStorage.removeItem('test_batch_structure');
            } catch (e) {
                console.error('‚ùå Failed with batch-like structure:', e);
                hasErrors = true;
            }
            
            // TEST 8: DIRECT SAVE TO ACTUAL batchDetailsData
            console.log('\n[TEST 8] DIRECTLY SAVING TO batchDetailsData...');
            try {
                const directTestData = {
                    'TEST_BATCH_999': {
                        'Vessel Used': 'V1_TEST',
                        'Mixer Used (Actual)': 'MX99_TEST',
                        'Grinder Used (Actual)': 'N/A',
                        'Mixer/Grinder Operators': '2',
                        'Filling Operators': '1',
                        'Total Manpower': '3',
                        'Time on Mixer (min)': '60',
                        'Time on Grinder (min)': '0',
                        'Problems': '[]',
                        'Downtime (min)': '0',
                        'Reason of Downtime': 'N/A',
                        'TOTAL PROCESS TIME (min)': 60,
                        'EMERGENCY_TEST': true
                    }
                };
                
                // Load existing data
                let existingData = {};
                const existing = localStorage.getItem('batchDetailsData');
                if (existing) {
                    existingData = JSON.parse(existing);
                }
                
                // Merge with test data
                const merged = {...existingData, ...directTestData};
                
                // Save
                localStorage.setItem('batchDetailsData', JSON.stringify(merged));
                console.log('‚úÖ Directly saved test batch to batchDetailsData');
                
                // Verify
                const verify = localStorage.getItem('batchDetailsData');
                const verifyParsed = JSON.parse(verify);
                if (verifyParsed['TEST_BATCH_999']) {
                    console.log('‚úÖ VERIFICATION PASSED!');
                    console.log('   Test batch exists in storage');
                    console.log('   Vessel:', verifyParsed['TEST_BATCH_999']['Vessel Used']);
                    
                    // Update allBatchData in memory
                    allBatchData = verifyParsed;
                    console.log('‚úÖ Updated allBatchData in memory');
                    console.log('   allBatchData now contains:', Object.keys(allBatchData));
                    
                } else {
                    console.error('‚ùå VERIFICATION FAILED - Test batch not found!');
                    hasErrors = true;
                }
                
            } catch (e) {
                console.error('‚ùå Direct save failed:', e);
                hasErrors = true;
            }
            
            // FINAL RESULT
            console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            if (hasErrors) {
                console.log('‚ïë  ‚ùå STORAGE TEST FAILED - ISSUES DETECTED           ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                alert('‚ùå STORAGE TEST FAILED!\n\n' +
                      'localStorage is NOT working properly.\n\n' +
                      'Common causes:\n' +
                      '‚Ä¢ Browser in Private/Incognito mode\n' +
                      '‚Ä¢ Browser storage disabled in settings\n' +
                      '‚Ä¢ Browser extension blocking storage\n' +
                      '‚Ä¢ Storage quota exceeded\n\n' +
                      'SOLUTIONS:\n' +
                      '1. Close private/incognito window\n' +
                      '2. Open in normal browser window\n' +
                      '3. Try different browser (Chrome/Firefox)\n' +
                      '4. Check browser privacy settings\n\n' +
                      'Check Console (F12) for detailed errors.');
            } else {
                console.log('‚ïë  ‚úÖ ALL TESTS PASSED - STORAGE WORKS!               ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                console.log('\nüéâ TEST BATCH SAVED SUCCESSFULLY!');
                console.log('Now refresh the page and look for TEST_BATCH_999');
                
                alert('‚úÖ ALL TESTS PASSED!\n\n' +
                      'üéâ I JUST SAVED A TEST BATCH DIRECTLY!\n\n' +
                      'Test batch "TEST_BATCH_999" with Vessel "V1_TEST" was saved.\n\n' +
                      'NOW:\n' +
                      '1. Click OK\n' +
                      '2. Refresh the page (F5)\n' +
                      '3. Check console - you should see TEST_BATCH_999 loaded\n' +
                      '4. If you see it, storage WORKS and the form is the problem\n' +
                      '5. If you DON\'T see it, something is clearing the data');
            }
        }

        // Initialize
        function init() {
            console.log('üöÄ Initializing dashboard...');
            
            SHEET_ID = localStorage.getItem('sheetId') || '';
            API_KEY = localStorage.getItem('apiKey') || '';
            SCRIPT_URL = localStorage.getItem('scriptUrl') || '';

            console.log('Sheet ID:', SHEET_ID ? 'Found' : 'Not found');
            console.log('API Key:', API_KEY ? 'Found' : 'Not found');

            if (!SHEET_ID || !API_KEY) {
                console.log('Showing setup panel...');
                showSetupPanel();
            } else {
                console.log('Credentials found, loading dashboard...');
                document.getElementById('setup-container').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                loadAllData();
                
                // Auto-refresh every 15 seconds
                setInterval(loadAllData, 15000);
                
                // Countdown timer display
                let countdown = 15;
                setInterval(() => {
                    countdown--;
                    if (countdown <= 0) countdown = 15;
                    const el = document.getElementById('refresh-countdown');
                    if (el) {
                        el.textContent = 'üîÑ ' + countdown + 's';
                        el.style.color = countdown <= 5 ? '#ffc107' : 'var(--accent-green)';
                    }
                }, 1000);
            }

            // Set default dates
            const today = new Date();
            document.getElementById('daily-report-date').valueAsDate = today;
            document.getElementById('equip-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('equip-end-date').valueAsDate = today;
            document.getElementById('product-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('product-end-date').valueAsDate = today;
            document.getElementById('category-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('category-end-date').valueAsDate = today;
            document.getElementById('custom-report-start').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('custom-report-end').valueAsDate = today;
            
            console.log('‚úÖ Initialization complete');
        }

        function showSetupPanel() {
            document.getElementById('setup-container').innerHTML = `
                <div class="setup-panel">
                    <div class="setup-title">üìä Dashboard Setup</div>
                    <p style="color: var(--text-secondary); margin-bottom: 30px;">
                        Connect your Google Sheet to start viewing real-time production analytics.
                    </p>

                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">
                        Google Sheet ID
                    </label>
                    <input type="text" id="input-sheet-id" class="form-input" 
                           placeholder="1V_2Cv61m2WSgZYUpCPAHJYdD9t_UKMJ-" value="${SHEET_ID}">

                    <label style="display: block; margin-bottom: 8px; margin-top: 20px; color: var(--text-primary); font-weight: 600;">
                        Google Sheets API Key
                    </label>
                    <input type="text" id="input-api-key" class="form-input" placeholder="AIzaSy..." value="${API_KEY}">

                    <label style="display: block; margin-bottom: 8px; margin-top: 20px; color: var(--text-primary); font-weight: 600;">
                        üîë Apps Script URL <span style="color:var(--accent-green)">(Required for saving batch details)</span>
                    </label>
                    <input type="text" id="input-script-url" class="form-input" placeholder="https://script.google.com/macros/s/.../exec" value="${SCRIPT_URL}">

                    <div class="setup-instructions" style="margin-top:20px;">
                        <strong>üìã How to set up batch data saving (one-time, 3 minutes):</strong><br><br>
                        
                        <strong>Step 1 ‚Äì Create the sheet:</strong><br>
                        In your Google Sheet, create a new tab named exactly: <code>Batch Details</code><br><br>

                        <strong>Step 2 ‚Äì Open Apps Script:</strong><br>
                        In your Google Sheet ‚Üí click <strong>Extensions</strong> ‚Üí <strong>Apps Script</strong><br><br>

                        <strong>Step 3 ‚Äì Paste this code</strong> (delete everything first, then paste):<br>
                        <textarea readonly style="width:100%;height:320px;background:#0d1117;color:#00ff88;padding:10px;border:1px solid #333;border-radius:4px;font-size:11px;font-family:monospace;resize:none;margin-top:8px;">var CLAUDE_API_KEY = 'YOUR_ANTHROPIC_API_KEY_HERE';

function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var action = e.parameter.action;

    // PALANTIR AI
    if (action === 'palantir') {
      var messages = JSON.parse(e.parameter.messages || '[]');
      var system = e.parameter.system || '';
      var url = 'https://api.anthropic.com/v1/messages';
      var payload = JSON.stringify({
        model: 'claude-opus-4-5-20251101',
        max_tokens: 1024,
        system: system,
        messages: messages
      });
      var options = {
        method: 'post',
        contentType: 'application/json',
        headers: {
          'x-api-key': CLAUDE_API_KEY,
          'anthropic-version': '2023-06-01'
        },
        payload: payload,
        muteHttpExceptions: true
      };
      var response = UrlFetchApp.fetch(url, options);
      var result = JSON.parse(response.getContentText());
      var reply = result.content && result.content[0] ? result.content[0].text : 'No response';
      return ContentService.createTextOutput(JSON.stringify({status:'ok', reply:reply}))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // BATCH DATA
    var sheet = ss.getSheetByName('Batch Details');
    if (!sheet) sheet = ss.insertSheet('Batch Details');

    if (action === 'save') {
      var batchNum = e.parameter.batch;
      var batchData = e.parameter.data;
      var values = sheet.getDataRange().getValues();
      var rowIndex = -1;
      for (var i = 1; i < values.length; i++) {
        if (values[i][0] == batchNum) { rowIndex = i + 1; break; }
      }
      var row = [batchNum, batchData, new Date().toISOString()];
      if (rowIndex > 0) {
        sheet.getRange(rowIndex, 1, 1, 3).setValues([row]);
      } else {
        sheet.appendRow(row);
      }
      return ContentService.createTextOutput(JSON.stringify({status:'ok'}))
        .setMimeType(ContentService.MimeType.JSON);
    }

    var values = sheet.getDataRange().getValues();
    var result = {};
    for (var i = 1; i < values.length; i++) {
      if (values[i][0]) {
        try { result[String(values[i][0])] = JSON.parse(values[i][1]); } catch(err) {}
      }
    }
    return ContentService.createTextOutput(JSON.stringify({status:'ok', data:result}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({status:'error', message:err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</textarea>

                        <div style="margin-top:12px; padding:12px; background:rgba(255,193,7,0.1); border:1px solid rgba(255,193,7,0.3); border-radius:8px; font-size:12px; color:#ffc107;">
                            ‚ö†Ô∏è <strong>Important:</strong> Replace <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:3px;">YOUR_ANTHROPIC_API_KEY_HERE</code> with your actual Anthropic API key from <strong>console.anthropic.com</strong>
                        </div>

                        <strong>Step 4 ‚Äì Deploy:</strong><br>
                        Click <strong>Deploy</strong> ‚Üí <strong>New deployment</strong> ‚Üí Type: <strong>Web app</strong><br>
                        Set <strong>"Execute as"</strong>: Me<br>
                        Set <strong>"Who has access"</strong>: Anyone<br>
                        Click <strong>Deploy</strong> ‚Üí Copy the URL ‚Üí Paste above<br><br>

                        <strong>Step 5:</strong> Paste the URL in the field above and click CONNECT.
                    </div>

                    <button class="btn" onclick="saveSetup()" style="margin-top:20px;">CONNECT DASHBOARD</button>
                    <button class="btn-nav" onclick="testConnection()" style="margin-left: 10px;">TEST CONNECTION</button>
                </div>
            `;
        }

        function saveSetup() {
            const sheetId   = document.getElementById('input-sheet-id').value.trim();
            const apiKey    = document.getElementById('input-api-key').value.trim();
            const scriptUrl = document.getElementById('input-script-url').value.trim();

            if (!sheetId || !apiKey) {
                alert('Please fill in Sheet ID and API Key');
                return;
            }

            localStorage.setItem('sheetId',    sheetId);
            localStorage.setItem('apiKey',     apiKey);
            localStorage.setItem('scriptUrl',  scriptUrl);

            SHEET_ID   = sheetId;
            API_KEY    = apiKey;
            SCRIPT_URL = scriptUrl;

            init();
        }

        async function testConnection() {
            const sheetId = document.getElementById('input-sheet-id').value.trim();
            const apiKey = document.getElementById('input-api-key').value.trim();

            if (!sheetId || !apiKey) {
                alert('Please fill in both fields');
                return;
            }

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Production Schedule!A1:D10?key=${apiKey}`
                );
                
                if (response.ok) {
                    alert('‚úÖ Connection successful! Click "CONNECT DASHBOARD" to continue.');
                } else {
                    const error = await response.json();
                    alert('‚ùå Connection failed: ' + (error.error?.message || 'Unknown error'));
                }
            } catch (err) {
                alert('‚ùå Connection failed: ' + err.message);
            }
        }

        // Navigation
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            // Stop live monitor if leaving that page
            if (pageId !== 'live-monitor') {
                stopLiveMonitor();
            }

            switch(pageId) {
                case 'attendance':
                    initAttendance();
                    break;
                case 'operator-performance':
                    initOperatorPerformance();
                    break;
                case 'batch-search':
                    initBatchSearch();
                    break;
                case 'palantir':
                    setTimeout(() => document.getElementById('palantir-input')?.focus(), 100);
                    break;
                case 'daily-view':
                    updateDailyView();
                    break;
                case 'vessel-tracker':
                    refreshVesselTracker();
                    break;
                case 'live-monitor':
                    startLiveMonitor();
                    break;
                case 'quality-control':
                    loadQualityData();
                    break;
                case 'auto-reports':
                    generateAutoReports();
                    break;
                case 'category-reports':
                    generateCategoryReports();
                    break;
            }
        }

        // Data Loading
        async function loadAllData() {
            try {
                updateStatus('loading');
                console.log('üîÑ Loading data...');

                // Load production, filling, and vessel data in parallel
                const [productionData, fillingData, vesselData] = await Promise.all([
                    fetchSheetData('Production Schedule!A:Z'),
                    fetchSheetData('Filling!A:Z'),
                    fetchSheetData('Mixer Map!F:I').catch(() => {
                        console.warn('‚ö†Ô∏è Could not load Mixer Map');
                        return [];
                    })
                ]);

                allProductionData = productionData;
                allFillingData    = fillingData;
                allVesselData     = vesselData;

                // Load batch details from Apps Script / Google Sheets
                await loadBatchDataFromSheet();

                console.log('‚úÖ Loaded:', productionData.length, 'production rows,', fillingData.length, 'filling rows,', Object.keys(allBatchData).length, 'batch details');

                updateDailyView();
                updateGlobalMetrics();
                updateStatus('live');
                updateTimestamp();
            } catch (error) {
                console.error('‚ùå Error:', error);
                updateStatus('error');
                alert('Error loading data: ' + error.message);
            }
        }

        // ==================== GOOGLE SHEETS BATCH DATA ====================

        async function loadBatchDataFromSheet() {
            if (!SCRIPT_URL) return;
            try {
                console.log('üì• Loading batch data...');
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const url = SCRIPT_URL + '?action=getAll&t=' + Date.now();
                const response = await fetch(url, { method: 'GET', redirect: 'follow', signal: controller.signal });
                clearTimeout(timeout);
                
                const text = await response.text();
                let json;
                try { json = JSON.parse(text); } catch(e) {
                    console.error('‚ùå Could not parse response:', text.substring(0, 200));
                    return;
                }
                if (json.status === 'ok') {
                    allBatchData = json.data || {};
                    console.log('‚úÖ Loaded', Object.keys(allBatchData).length, 'batches');
                    updateDailyView();
                }
            } catch (e) {
                if (e.name === 'AbortError') console.warn('‚ö†Ô∏è Batch data load timed out');
                else console.error('‚ùå Failed to load batch data:', e.message);
            }
        }

        async function saveBatchToSheet(batchNumber, batchData) {
            if (!SCRIPT_URL) {
                alert('‚ùå No Apps Script URL.\n\nClick ‚öôÔ∏è Settings and add your Apps Script URL.');
                return false;
            }
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const params = new URLSearchParams({
                    action: 'save',
                    batch: batchNumber,
                    data: JSON.stringify(batchData),
                    t: Date.now()
                });
                const response = await fetch(SCRIPT_URL + '?' + params.toString(), {
                    method: 'GET', redirect: 'follow', signal: controller.signal
                });
                clearTimeout(timeout);
                
                const text = await response.text();
                let json;
                try { json = JSON.parse(text); } catch(e) { return false; }
                
                if (json.status === 'ok') {
                    console.log('‚úÖ Saved batch', batchNumber);
                    return true;
                }
                return false;
            } catch (e) {
                if (e.name === 'AbortError') console.warn('‚ö†Ô∏è Save timed out');
                else console.error('‚ùå Save failed:', e.message);
                return false;
            }
        }

        async function saveBatchDetails(event, batchNumber) {
            event.preventDefault();

            const normalizedBatch = batchNumber.toString().trim();

            const vesselUsed    = document.getElementById('vessel-used')?.value.trim() || '';
            const mixerUsed     = document.getElementById('mixer-used')?.value.trim() || '';
            const grinderUsed   = document.getElementById('grinder-used')?.value.trim() || '';
            const mixerGrinderOps = document.getElementById('mixer-grinder-ops')?.value || '';
            const fillingOps    = document.getElementById('filling-ops')?.value || '';
            const totalManpower = document.getElementById('total-manpower')?.value || '';
            const timeMixer     = document.getElementById('time-mixer')?.value || '';
            const timeGrinder   = document.getElementById('time-grinder')?.value || '';
            const downtime      = document.getElementById('downtime')?.value || '0';
            const downtimeReason = document.getElementById('downtime-reason')?.value.trim() || '';



            // Collect problems
            const problems = [];
            document.querySelectorAll('#problems-container > div').forEach(container => {
                const select = container.querySelector('.problem-type-select');
                const problemType = select?.value;
                if (!problemType) return;
                const pd = { type: problemType };
                switch(problemType) {
                    case 'Viscosity':
                        pd.initialViscosity = container.querySelector('[name="initial-viscosity"]')?.value || '';
                        pd.finalViscosity   = container.querySelector('[name="final-viscosity"]')?.value || '';
                        const solvents = [];
                        container.querySelectorAll('[name="solvent-type"]').forEach((st, i) => {
                            const sw = container.querySelectorAll('[name="solvent-weight"]')[i];
                            if (st.value && sw?.value) solvents.push({ type: st.value, weight: sw.value });
                        });
                        pd.solvents = solvents;
                        break;
                    case 'Color':
                        pd.expectedColor    = container.querySelector('[name="expected-color"]')?.value || '';
                        pd.actualColor      = container.querySelector('[name="actual-color"]')?.value || '';
                        pd.correctionAction = container.querySelector('[name="correction-action"]')?.value || '';
                        break;
                    case 'Drying Time':
                        pd.expectedDrying   = container.querySelector('[name="expected-drying"]')?.value || '';
                        pd.actualDrying     = container.querySelector('[name="actual-drying"]')?.value || '';
                        pd.dryingSolution   = container.querySelector('[name="drying-solution"]')?.value || '';
                        break;
                    case 'Too much Grinding':
                        pd.targetFineness   = container.querySelector('[name="target-fineness"]')?.value || '';
                        pd.actualFineness   = container.querySelector('[name="actual-fineness"]')?.value || '';
                        pd.grindingAction   = container.querySelector('[name="grinding-action"]')?.value || '';
                        break;
                    case 'Dispersing Problem':
                        pd.dispersingIssue    = container.querySelector('[name="dispersing-issue"]')?.value || '';
                        pd.dispersingSolution = container.querySelector('[name="dispersing-solution"]')?.value || '';
                        break;
                    case 'Complete batch damaged':
                        pd.damageCause = container.querySelector('[name="damage-cause"]')?.value || '';
                        pd.batchStatus = container.querySelector('[name="batch-status"]')?.value || '';
                        pd.lossAmount  = container.querySelector('[name="loss-amount"]')?.value || '';
                        break;
                }
                problems.push(pd);
            });

            const totalProcessTime = (parseInt(timeMixer)||0) + (parseInt(timeGrinder)||0) + (parseInt(downtime)||0);

            const batchData = {
                'Vessel Used':              vesselUsed,
                'Mixer Used (Actual)':      mixerUsed,
                'Grinder Used (Actual)':    grinderUsed || 'N/A',
                'Mixer/Grinder Operators':  mixerGrinderOps,
                'Filling Operators':        fillingOps,
                'Total Manpower':           totalManpower,
                'Time on Mixer (min)':      timeMixer,
                'Time on Grinder (min)':    timeGrinder || '0',
                'Problems':                 JSON.stringify(problems),
                'Downtime (min)':           downtime,
                'Reason of Downtime':       downtimeReason || 'N/A',
                'TOTAL PROCESS TIME (min)': totalProcessTime
            };

            // Show saving spinner
            document.getElementById('batch-modal-body').innerHTML = `
                <div style="text-align:center; padding:80px 20px;">
                    <div style="width:60px;height:60px;border:5px solid var(--accent-green);border-top-color:transparent;border-radius:50%;margin:0 auto 30px;animation:spin 1s linear infinite;"></div>
                    <h2 style="color:var(--accent-green);">üíæ Saving to Google Sheets...</h2>
                    <p style="color:var(--text-secondary);margin-top:10px;">Batch #${normalizedBatch}</p>
                </div>
            `;

            const saved = await saveBatchToSheet(normalizedBatch, batchData);

            if (saved) {
                // Update local memory too
                allBatchData[normalizedBatch] = batchData;
                updateDailyView();

                document.getElementById('batch-modal-body').innerHTML = `
                    <div style="text-align:center; padding:80px 20px;">
                        <div style="font-size:80px;margin-bottom:20px;">‚úÖ</div>
                        <h2 style="color:var(--accent-green);margin-bottom:10px;">Saved to Google Sheets!</h2>
                        <p style="color:var(--text-secondary);">Batch #${normalizedBatch} is stored permanently</p>
                        <p style="color:var(--accent-green);margin-top:10px;font-size:14px;">‚úÖ Survives page refresh, browser close, and new devices</p>
                        <button class="btn-success" onclick="closeBatchModal()" style="margin-top:25px;">CLOSE</button>
                    </div>
                `;
                setTimeout(() => closeBatchModal(), 2500);
            } else {
                document.getElementById('batch-modal-body').innerHTML = `
                    <div style="text-align:center; padding:80px 20px;">
                        <div style="font-size:80px;margin-bottom:20px;">‚ùå</div>
                        <h2 style="color:#ff4444;margin-bottom:10px;">Save Failed</h2>
                        <p style="color:var(--text-secondary);">Could not connect to Google Sheets.</p>
                        <p style="color:var(--text-secondary);margin-top:10px;">Check your Apps Script URL in setup.</p>
                        <button class="btn" onclick="closeBatchModal()" style="margin-top:25px;">CLOSE</button>
                    </div>
                `;
            }
        }

        async function fetchSheetData(range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Failed to fetch ${range}: ${error.error?.message || 'Unknown error'}`);
            }
            
            const data = await response.json();
            const values = data.values || [];
            
            // Debug: Show first 5 data rows (skip header)
            console.log(`üì• Fetched ${range}: ${values.length} rows`);
            if (values.length > 1) {
                console.log('First 5 data rows (raw from Google Sheets):');
                values.slice(1, 6).forEach((row, idx) => {
                    console.log(`  Row ${idx + 2}: Date="${row[0]}" (type: ${typeof row[0]}), Product="${row[1]}", Weight="${row[3]}"`);
                });
            }
            
            return values;
        }

        // Helper function to get all sheet names
        async function getAvailableSheets() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Could not fetch spreadsheet metadata');
                }
                
                const data = await response.json();
                const sheetNames = data.sheets.map(sheet => sheet.properties.title);
                
                console.log('üìã Available sheets in your Google Sheets:');
                sheetNames.forEach((name, idx) => {
                    console.log(`   ${idx + 1}. "${name}"`);
                });
                
                return sheetNames;
            } catch (error) {
                console.error('‚ùå Could not get sheet names:', error);
                return [];
            }
        }

        // Call this to see all your sheet names
        window.listSheets = async function() {
            const sheets = await getAvailableSheets();
            return sheets;
        };
        
        console.log('üí° TIP: Run listSheets() in console to see all your sheet names');

        function updateStatus(status) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.querySelector('.status-dot');
            
            if (status === 'loading') {
                statusText.textContent = 'LOADING';
                statusDot.style.background = '#ffd93d';
            } else if (status === 'error') {
                statusText.textContent = 'ERROR';
                statusDot.style.background = '#ff4757';
            } else {
                statusText.textContent = 'LIVE';
                statusDot.style.background = '#00ff88';
            }
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
        }

        // Date Navigation
        function changeDate(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            updateDailyView();
        }

        function setToday() {
            currentViewDate = new Date();
            updateDailyView();
        }

        // Global Metrics (All-Time)
        function updateGlobalMetrics() {
            let totalWeight = 0;
            let totalEntries = 0;
            const uniqueProducts = new Set();

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const weight = parseWeight(row[3]);
                totalWeight += weight;
                totalEntries++;
            });

            allFillingData.slice(1).forEach(row => {
                if (!row[0] || !row[1]) return;
                const product = row[1];
                const batch = row[2];
                uniqueProducts.add(`${product}|${batch}`);
            });

            document.getElementById('total-weight-alltime').textContent = formatNumber(totalWeight) + ' KG';
            document.getElementById('total-entries').textContent = formatNumber(totalEntries) + ' entries';
            document.getElementById('total-products-filled').textContent = formatNumber(uniqueProducts.size);
        }

        function addNewWorkerPrompt() {
            const name = prompt('Enter the new worker\'s name:');
            if (!name || !name.trim()) return;
            const trimmed = name.trim();
            if (WORKERS.includes(trimmed)) {
                alert('Worker "' + trimmed + '" already exists!');
                return;
            }
            WORKERS.push(trimmed);
            const date = document.getElementById('att-date').value;
            if (!attendanceData[date]) attendanceData[date] = {};
            attendanceData[date][trimmed] = { status: 'present', time: '' };
            renderWorkerGrid(date);
            updateAttKPIs(date);
            alert('‚úÖ "' + trimmed + '" added successfully!');
        }

        function generateAttendancePDF(silent) {
            const date = document.getElementById('att-date').value || new Date().toISOString().split('T')[0];
            const dayData = attendanceData[date] || {};

            let present = [], late = [], absent = [];
            WORKERS.forEach(w => {
                const rec = dayData[w] || { status: 'present', time: '' };
                if (rec.status === 'present') present.push({ name: w, time: rec.time });
                else if (rec.status === 'late')    late.push({ name: w, time: rec.time });
                else                               absent.push({ name: w, time: '' });
            });

            const total = WORKERS.length;
            const rate  = Math.round((present.length + late.length) / total * 100);
            const now   = new Date();
            const generatedAt = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const dateFormatted = new Date(date).toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

            const rows = (list, status, color, icon) => list.map((w, i) => `
                <tr style="background:${i%2===0?'#ffffff':'#f9f9f9'}">
                    <td style="padding:9px 14px; border-bottom:1px solid #eee;">${w.name}</td>
                    <td style="padding:9px 14px; border-bottom:1px solid #eee; color:${color}; font-weight:700;">${icon} ${status}</td>
                    <td style="padding:9px 14px; border-bottom:1px solid #eee; color:#666;">${w.time || '‚Äî'}</td>
                </tr>`).join('');

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 30px; color: #1a1a2e; }
                .header { background: linear-gradient(135deg, #0a0e17, #1a1a3a); color: white; padding: 28px 32px; border-radius: 12px; margin-bottom: 28px; }
                .header h1 { margin:0; font-size:26px; letter-spacing:2px; }
                .header p  { margin:6px 0 0; opacity:0.7; font-size:13px; letter-spacing:1px; }
                .kpis { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
                .kpi  { padding:18px; border-radius:10px; text-align:center; }
                .kpi .num { font-size:36px; font-weight:800; }
                .kpi .lbl { font-size:11px; letter-spacing:1px; margin-top:4px; opacity:0.8; }
                table { width:100%; border-collapse:collapse; margin-bottom:24px; }
                th    { background:#0a0e17; color:white; padding:10px 14px; text-align:left; font-size:12px; letter-spacing:1px; }
                .section-title { font-size:14px; font-weight:800; letter-spacing:2px; margin:20px 0 10px; text-transform:uppercase; }
                .footer { text-align:center; margin-top:30px; font-size:11px; color:#999; border-top:1px solid #eee; padding-top:16px; }
            </style></head><body>
            <div class="header">
                <h1>üë∑ ATTENDANCE REPORT</h1>
                <p>${dateFormatted.toUpperCase()} &nbsp;¬∑&nbsp; GENERATED AT ${generatedAt}</p>
            </div>
            <div class="kpis">
                <div class="kpi" style="background:#e8fff4; color:#00a854;">
                    <div class="num">${present.length}</div><div class="lbl">PRESENT</div>
                </div>
                <div class="kpi" style="background:#fff8e0; color:#d48806;">
                    <div class="num">${late.length}</div><div class="lbl">LATE</div>
                </div>
                <div class="kpi" style="background:#fff1f0; color:#cf1322;">
                    <div class="num">${absent.length}</div><div class="lbl">ABSENT</div>
                </div>
                <div class="kpi" style="background:#e6f4ff; color:#0958d9;">
                    <div class="num">${rate}%</div><div class="lbl">ATTENDANCE RATE</div>
                </div>
            </div>

            ${present.length > 0 ? `
            <div class="section-title" style="color:#00a854;">‚úÖ Present (${present.length})</div>
            <table><thead><tr><th>NAME</th><th>STATUS</th><th>TIME IN</th></tr></thead>
            <tbody>${rows(present,'Present','#00a854','‚úÖ')}</tbody></table>` : ''}

            ${late.length > 0 ? `
            <div class="section-title" style="color:#d48806;">‚è∞ Late (${late.length})</div>
            <table><thead><tr><th>NAME</th><th>STATUS</th><th>TIME IN</th></tr></thead>
            <tbody>${rows(late,'Late','#d48806','‚è∞')}</tbody></table>` : ''}

            ${absent.length > 0 ? `
            <div class="section-title" style="color:#cf1322;">‚ùå Absent (${absent.length})</div>
            <table><thead><tr><th>NAME</th><th>STATUS</th><th>TIME IN</th></tr></thead>
            <tbody>${rows(absent,'Absent','#cf1322','‚ùå')}</tbody></table>` : ''}

            <div class="footer">Production Analytics Dashboard &nbsp;¬∑&nbsp; Attendance Report &nbsp;¬∑&nbsp; ${dateFormatted}</div>
            </body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.focus();
            setTimeout(() => {
                win.print();
                if (silent) win.close();
            }, 600);
        }

        // ‚îÄ‚îÄ Auto PDF at 08:00 every morning ‚îÄ‚îÄ
        function scheduleAutoPDF() {
            const now   = new Date();
            const target = new Date();
            target.setHours(8, 0, 0, 0);
            if (now >= target) target.setDate(target.getDate() + 1); // already past 8am, schedule tomorrow
            const msUntil = target - now;
            console.log('üìÑ Auto-PDF scheduled in', Math.round(msUntil/60000), 'minutes');
            setTimeout(() => {
                generateAttendancePDF(true); // silent = auto-close after print
                scheduleAutoPDF();           // reschedule for next day
            }, msUntil);
        }
        scheduleAutoPDF();

        // ==================== OPERATOR PERFORMANCE ====================

        const OP_COMPONENTS = [
            { key: 'attendance',      label: 'Attendance',         icon: 'üìÖ', desc: 'Punctuality and presence' },
            { key: 'teamwork',        label: 'Teamwork',           icon: 'ü§ù', desc: 'Collaboration with colleagues' },
            { key: 'ppe',             label: 'PPE Correctly Used', icon: 'ü¶∫', desc: 'Safety equipment compliance' },
            { key: 'speed',           label: 'Speed',              icon: '‚ö°', desc: 'Work pace and efficiency' },
            { key: 'problem_solving', label: 'Problem Solving',    icon: 'üß†', desc: 'Handling issues independently' },
            { key: 'attitude',        label: 'Attitude at Work',   icon: 'üòä', desc: 'Positive mindset and behaviour' },
            { key: 'fast_learning',   label: 'Fast Learning',      icon: 'üìö', desc: 'Picking up new skills quickly' },
            { key: 'accountability',  label: 'Accountability',     icon: '‚úÖ', desc: 'Owning tasks and results' },
            { key: 'respect',         label: 'Respect',            icon: 'üôè', desc: 'Treating others with dignity' }
        ];

        let opGrades = {};
        let opInitialized = false; // run heavy setup only once

        function initOperatorPerformance() {
            const now      = new Date();
            const month    = now.getMonth();
            const year     = now.getFullYear();
            const day      = now.getDate();
            const lastDay  = new Date(year, month + 1, 0).getDate();
            const daysLeft = lastDay - day;

            // ‚îÄ‚îÄ One-time setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (!opInitialized) {
                opInitialized = true;

                // Build month options
                const monthOptions = [];
                for (let i = 0; i < 12; i++) {
                    const d   = new Date(year, month - i, 1);
                    const val = d.toISOString().slice(0, 7);
                    const lbl = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    const tag = i === 0 ? ' (Current Month)' : ' ‚úÖ';
                    monthOptions.push(`<option value="${val}">${lbl}${tag}</option>`);
                }
                const optHtml = monthOptions.join('');
                document.getElementById('op-grade-month').innerHTML  = optHtml;
                document.getElementById('op-scores-month').innerHTML = optHtml;

                // Populate worker dropdown
                document.getElementById('op-grade-worker').innerHTML =
                    '<option value="">-- Choose Worker --</option>' +
                    WORKERS.map(w => `<option value="${w}">${w}</option>`).join('');

                // End of month notice
                const notice = document.getElementById('op-month-notice');
                if (daysLeft <= 5) {
                    notice.style.cssText = 'margin-bottom:20px;padding:14px 18px;border-radius:10px;font-size:13px;display:flex;align-items:center;gap:10px;background:rgba(255,68,68,0.12);border:1px solid rgba(255,68,68,0.4);color:#ff6b6b;';
                    notice.innerHTML = `üö® <strong>End of month approaching!</strong> Only <strong>${daysLeft} day${daysLeft===1?'':'s'}</strong> left. Please complete all evaluations.`;
                } else if (daysLeft <= 10) {
                    notice.style.cssText = 'margin-bottom:20px;padding:14px 18px;border-radius:10px;font-size:13px;display:flex;align-items:center;gap:10px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);color:#ffc107;';
                    notice.innerHTML = `‚ö†Ô∏è <strong>${daysLeft} days left</strong> in ${now.toLocaleDateString('en-GB',{month:'long'})}. Remember to evaluate all workers before month end.`;
                } else {
                    notice.style.cssText = 'margin-bottom:20px;padding:14px 18px;border-radius:10px;font-size:13px;display:flex;align-items:center;gap:10px;background:rgba(0,198,255,0.07);border:1px solid rgba(0,198,255,0.2);color:#5a6a8a;';
                    notice.innerHTML = `üìÖ Evaluations are done <strong>once per month, at the end of the month.</strong> Current month: <strong style="color:var(--accent-blue)">${now.toLocaleDateString('en-GB',{month:'long',year:'numeric'})}</strong> ‚Äî ${daysLeft} days remaining.`;
                }

                // Load grades once (from localStorage then Apps Script)
                loadOpGradesFromStorage();
            }
            // ‚îÄ‚îÄ Every visit: nothing extra needed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        }

        function switchOpTab(tab) {
            document.getElementById('op-grade').style.display  = tab === 'grade'  ? 'block' : 'none';
            document.getElementById('op-scores').style.display = tab === 'scores' ? 'block' : 'none';
            document.getElementById('op-tab-grade').className  = tab === 'grade'  ? 'btn-success' : 'btn-secondary';
            document.getElementById('op-tab-scores').className = tab === 'scores' ? 'btn-success' : 'btn-secondary';
            document.getElementById('op-tab-grade').style.padding  = '10px 24px';
            document.getElementById('op-tab-scores').style.padding = '10px 24px';
        }

        function opKey(worker, month) { return worker + '|' + month; }

        function loadOpGradesFromStorage() {
            // Load from localStorage immediately (instant, no loop)
            try {
                const local = localStorage.getItem('opGradesBackup');
                if (local) { opGrades = JSON.parse(local); refreshOpDropdowns(); }
            } catch(e) {}

            // Then sync from Apps Script in background (fire and forget)
            if (!SCRIPT_URL) return;
            fetch(SCRIPT_URL + '?action=getOpGrades&t=' + Date.now(), { method:'GET', redirect:'follow' })
                .then(r => r.text()).then(text => {
                    try {
                        const json = JSON.parse(text);
                        if (json.status === 'ok' && json.data && Object.keys(json.data).length > 0) {
                            opGrades = json.data;
                            try { localStorage.setItem('opGradesBackup', JSON.stringify(opGrades)); } catch(e) {}
                            refreshOpDropdowns(); // only refresh dropdowns, not full init
                        }
                    } catch(e) {}
                }).catch(() => {});
        }

        // Lightweight refresh ‚Äî only updates month dropdown labels (no full re-init)
        function refreshOpDropdowns() {
            const now   = new Date();
            const month = now.getMonth();
            const year  = now.getFullYear();
            const gradeEl  = document.getElementById('op-grade-month');
            const scoresEl = document.getElementById('op-scores-month');
            if (!gradeEl || !scoresEl) return;
            const currentVal = gradeEl.value;

            const monthOptions = [];
            for (let i = 0; i < 12; i++) {
                const d     = new Date(year, month - i, 1);
                const val   = d.toISOString().slice(0, 7);
                const label = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                const tag   = i === 0 ? ' (Current Month)' : ' ‚úÖ';
                const graded = WORKERS.filter(w => {
                    const k = opKey(w, val);
                    return opGrades[k] && OP_COMPONENTS.every(c => opGrades[k][c.key] !== undefined);
                }).length;
                const gradedTag = graded > 0 ? ` ‚Äî ${graded}/${WORKERS.length} graded` : '';
                monthOptions.push(`<option value="${val}">${label}${tag}${gradedTag}</option>`);
            }
            const optHtml = monthOptions.join('');
            gradeEl.innerHTML  = optHtml;
            scoresEl.innerHTML = optHtml;
            // Restore previously selected value
            if (currentVal) gradeEl.value = currentVal;
        }

        async function saveOpGradesToStorage() {
            // Always save to localStorage first
            try { localStorage.setItem('opGradesBackup', JSON.stringify(opGrades)); } catch(e) {}
            if (!SCRIPT_URL) return true; // localStorage saved successfully

            try {
                const params = new URLSearchParams({
                    action: 'saveOpGrades',
                    data:   JSON.stringify(opGrades),
                    t:      Date.now()
                });
                const r    = await fetch(SCRIPT_URL + '?' + params.toString(), { method:'GET', redirect:'follow' });
                const json = JSON.parse(await r.text());
                return json.status === 'ok';
            } catch(e) {
                console.error('Apps Script save failed:', e);
                return false; // localStorage already saved above
            }
        }

        function loadWorkerGradeForm() {
            const worker    = document.getElementById('op-grade-worker').value;
            const month     = document.getElementById('op-grade-month').value;
            const formDiv   = document.getElementById('op-grade-form');
            const statusDiv = document.getElementById('op-grade-status');
            if (!worker || !month) { formDiv.innerHTML = ''; statusDiv.innerHTML = ''; return; }

            const now            = new Date();
            const currentMonth   = now.toISOString().slice(0, 7);
            const isPastMonth    = month < currentMonth;
            const isCurrentMonth = month === currentMonth;
            const lastDay        = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const day            = now.getDate();
            const inEvalWindow   = day >= 25;
            const isLocked       = false;  // past months remain editable
            const isEarlyMonth   = isCurrentMonth && !inEvalWindow;
            const isReadOnly     = isEarlyMonth;

            if (isEarlyMonth) {
                statusDiv.style.cssText = 'background:rgba(255,193,7,0.1);color:#ffc107;border:1px solid rgba(255,193,7,0.3);font-size:13px;padding:8px 14px;border-radius:8px;';
                statusDiv.innerHTML = `‚è≥ Opens on the 25th (${lastDay - day} days away)`;
            } else {
                statusDiv.style.cssText = 'background:rgba(0,255,136,0.1);color:var(--accent-green);border:1px solid rgba(0,255,136,0.3);font-size:13px;padding:8px 14px;border-radius:8px;';
                statusDiv.innerHTML = '‚úÖ Evaluation window open';
            }

            const key        = opKey(worker, month);
            const existing   = opGrades[key] || {};
            const monthLabel = new Date(month + '-01').toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

            formDiv.innerHTML = `
                <div class="card" style="${isReadOnly ? 'opacity:0.85;' : ''}">
                    ${isEarlyMonth ? `
                    <div style="padding:16px 18px; margin-bottom:24px; background:rgba(255,193,7,0.08); border:1px solid rgba(255,193,7,0.3); border-radius:10px; color:#ffc107; font-size:13px; line-height:1.8;">
                        ‚è≥ <strong>Evaluation not yet available.</strong><br>
                        Monthly evaluations open from the <strong>25th of each month</strong>, allowing you to assess the full month before it ends.
                        Come back in <strong>${lastDay - day} days</strong>.
                    </div>` : ''}

                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:24px;">
                        <div>
                            <div style="font-size:22px; font-weight:800;">${worker}</div>
                            <div style="font-size:13px; color:var(--text-secondary);">${monthLabel} ‚Äî Monthly Evaluation</div>
                        </div>
                        <div style="text-align:center; background:var(--bg-secondary); padding:12px 24px; border-radius:12px; border:2px solid var(--accent-blue);">
                            <div style="font-size:11px; color:var(--text-secondary); letter-spacing:2px;">TOTAL SCORE</div>
                            <div id="op-total-val" style="font-size:40px; font-weight:900; color:var(--accent-blue); line-height:1;">--</div>
                            <div style="font-size:11px; color:var(--text-secondary);">/ 90</div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(340px,1fr)); gap:16px; margin-bottom:24px;">
                        ${OP_COMPONENTS.map(c => {
                            const val = existing[c.key] !== undefined ? existing[c.key] : '';
                            return `
                            <div style="background:var(--bg-secondary); padding:16px; border-radius:10px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <div><span style="font-size:18px;">${c.icon}</span><span style="font-weight:700; margin-left:8px;">${c.label}</span></div>
                                    <div id="score-display-${c.key}" style="font-size:22px; font-weight:900; color:${val !== '' ? getScoreColor(val) : 'var(--text-secondary)'}; min-width:48px; text-align:right;">
                                        ${val !== '' ? val + '/10' : '‚Äî'}
                                    </div>
                                </div>
                                <div style="font-size:11px; color:var(--text-secondary); margin-bottom:10px;">${c.desc}</div>
                                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                    ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <button onclick="${isReadOnly ? '' : `setGrade('${c.key}', ${n})`}"
                                            id="grade-btn-${c.key}-${n}"
                                            style="width:32px; height:32px; border-radius:6px; border:1px solid var(--border-color); font-size:13px; font-weight:700;
                                            cursor:${isReadOnly ? 'default' : 'pointer'};
                                            background:${val == n ? getScoreColor(n) : 'var(--bg-primary)'};
                                            color:${val == n ? (n <= 4 ? '#fff' : '#000') : 'var(--text-primary)'};
                                            ${isReadOnly ? 'pointer-events:none;' : ''}">
                                            ${n}
                                        </button>`).join('')}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                    <div style="margin-bottom:20px;">
                        <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:6px;">MANAGER NOTES (optional)</label>
                        <textarea id="op-notes" class="form-input" rows="3"
                            placeholder="Add observations, highlights, or areas of improvement..."
                            style="resize:vertical;" ${isReadOnly ? 'readonly' : ''}>${existing.notes || ''}</textarea>
                    </div>

                    ${!isReadOnly ? `
                    <div style="display:flex; gap:12px;">
                        <button class="btn-success" onclick="saveWorkerGrade()" style="padding:14px 32px; font-size:15px;">üíæ Save Evaluation</button>
                        <button class="btn-secondary" onclick="clearWorkerGrade()" style="padding:14px 20px;">üóëÔ∏è Clear</button>
                    </div>` : ''}
                </div>`;

            updateLiveTotal();
        }

        function getScoreColor(n) {
            n = parseInt(n);
            if (n >= 9) return '#00ff88';
            if (n >= 7) return '#00c6ff';
            if (n >= 5) return '#ffc107';
            return '#ff4444';
        }

        function setGrade(componentKey, value) {
            const worker = document.getElementById('op-grade-worker').value;
            const month  = document.getElementById('op-grade-month').value;
            const key    = opKey(worker, month);
            if (!opGrades[key]) opGrades[key] = {};
            opGrades[key][componentKey] = parseInt(value); // always store as integer

            // Update button styles
            [1,2,3,4,5,6,7,8,9,10].forEach(n => {
                const btn = document.getElementById(`grade-btn-${componentKey}-${n}`);
                if (!btn) return;
                btn.style.background = n === parseInt(value) ? getScoreColor(n) : 'var(--bg-primary)';
                btn.style.color      = n === parseInt(value) ? (n <= 4 ? '#fff' : '#000') : 'var(--text-primary)';
            });

            // Update score display
            const disp = document.getElementById(`score-display-${componentKey}`);
            if (disp) { disp.textContent = value + '/10'; disp.style.color = getScoreColor(parseInt(value)); }

            updateLiveTotal();
        }

        function updateLiveTotal() {
            const worker = document.getElementById('op-grade-worker').value;
            const month  = document.getElementById('op-grade-month').value;
            const key    = opKey(worker, month);
            const grades = opGrades[key] || {};
            let total = 0;
            let count = 0;
            // Only sum the 9 defined component keys ‚Äî skip internal _ fields
            OP_COMPONENTS.forEach(c => {
                const v = grades[c.key];
                if (v !== undefined && v !== null) {
                    total += parseInt(v);
                    count++;
                }
            });
            const el = document.getElementById('op-total-val');
            if (!el) return;
            if (count === 0) {
                el.textContent = '-- / 90';
                el.style.color = 'var(--accent-blue)';
                el.style.fontSize = '28px';
                return;
            }
            el.textContent = total + ' / 90';
            el.style.fontSize = '28px';
            el.style.color = total >= 75 ? 'var(--accent-green)' : total >= 55 ? '#00c6ff' : total >= 36 ? '#ffc107' : '#ff4444';
        }

        async function saveWorkerGrade() {
            const worker = document.getElementById('op-grade-worker').value;
            const month  = document.getElementById('op-grade-month').value;
            if (!worker || !month) return;
            const key = opKey(worker, month);
            if (!opGrades[key]) opGrades[key] = {};

            // Save notes
            opGrades[key].notes = document.getElementById('op-notes')?.value || '';

            // Check if all 9 components are graded
            const missing = OP_COMPONENTS.filter(c => opGrades[key][c.key] === undefined).map(c => c.label);
            if (missing.length > 0) {
                if (!confirm(`‚ö†Ô∏è ${missing.length} component(s) not graded yet:\n‚Ä¢ ${missing.join('\n‚Ä¢ ')}\n\nSave anyway?`)) return;
            }

            if (SCRIPT_URL) {
                const ok = await saveOpGradesToStorage();
                const btn = document.querySelector('[onclick="saveWorkerGrade()"]');
                if (ok) {
                    if (btn) { const orig = btn.innerHTML; btn.innerHTML = '‚úÖ Saved!'; btn.style.background='var(--accent-green)'; setTimeout(() => { btn.innerHTML = orig; btn.style.background=''; }, 2000); }
                } else {
                    alert('‚ö†Ô∏è Could not connect to server. Check Apps Script.');
                }
            } else {
                const btn = document.querySelector('[onclick="saveWorkerGrade()"]');
                if (btn) { const orig = btn.innerHTML; btn.innerHTML = '‚úÖ Saved!'; btn.style.background='var(--accent-green)'; setTimeout(() => { btn.innerHTML = orig; btn.style.background=''; }, 2000); }
            }
        }

        function clearWorkerGrade() {
            const worker = document.getElementById('op-grade-worker').value;
            const month  = document.getElementById('op-grade-month').value;
            if (!confirm(`Clear all grades for ${worker} ‚Äî ${month}?`)) return;
            const key = opKey(worker, month);
            delete opGrades[key];
            loadWorkerGradeForm();
        }

        function loadScoreboard() {
            const month = document.getElementById('op-scores-month').value;
            if (!month) return;
            const monthLabel = new Date(month + '-01').toLocaleDateString('en-GB', { month:'long', year:'numeric' });
            const resultsDiv = document.getElementById('op-scoreboard-results');

            const scores = WORKERS.map(worker => {
                const key    = opKey(worker, month);
                const grades = opGrades[key] || {};
                let total = 0; let graded = 0;
                OP_COMPONENTS.forEach(c => { if (grades[c.key] !== undefined) { total += parseInt(grades[c.key]); graded++; } });
                const maxPossible = OP_COMPONENTS.length * 10;
                const pct = graded === OP_COMPONENTS.length ? Math.round(total / maxPossible * 100) : null;
                return { worker, grades, total, graded, pct, notes: grades.notes || '' };
            }).filter(s => s.graded > 0);

            if (scores.length === 0) {
                resultsDiv.innerHTML = `<div class="card" style="text-align:center; padding:60px; color:var(--text-secondary);">
                    No evaluations found for ${monthLabel}.<br><br>
                    Go to <strong>‚úèÔ∏è Grade Workers</strong> tab to add evaluations first.
                </div>`;
                return;
            }

            scores.sort((a, b) => (b.total || 0) - (a.total || 0));

            // Podium for top 3
            let podiumHtml = '';
            if (scores.filter(s => s.graded === OP_COMPONENTS.length).length >= 3) {
                const complete = scores.filter(s => s.pct !== null);
                const [gold, silver, bronze] = [complete[0], complete[1], complete[2]];
                if (gold && silver && bronze) {
                    podiumHtml = `
                    <div class="card" style="margin-bottom:28px; text-align:center;">
                        <div style="font-size:16px; font-weight:800; letter-spacing:2px; color:var(--accent-blue); margin-bottom:24px;">üèÜ ${monthLabel.toUpperCase()} LEADERBOARD</div>
                        <div style="display:flex; justify-content:center; align-items:flex-end; gap:20px; padding-bottom:10px;">
                            ${[[silver,'#adb5bd','2nd','120px'],[gold,'#ffc107','1st','160px'],[bronze,'#cd7f32','3rd','100px']]
                              .map(([s,col,pos,h]) => `
                                <div style="flex:1; max-width:200px;">
                                    <div style="font-size:32px;">${s.total >= 75 ? 'ü•á' : s.total >= 60 ? 'ü•à' : 'ü•â'}</div>
                                    <div style="font-weight:800; font-size:14px; margin:6px 0 2px;">${s.worker}</div>
                                    <div style="font-size:26px; font-weight:900; color:${col}; margin-bottom:8px;">${s.total}<span style="font-size:13px;">/90</span></div>
                                    <div style="background:${col}; height:${h}; border-radius:8px 8px 0 0; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:800; color:${pos==='1st'?'#000':'#fff'};">${pos}</div>
                                </div>`).join('')}
                        </div>
                    </div>`;
                }
            }

            // Individual cards
            const cards = scores.map((s, i) => {
                const maxPossible = OP_COMPONENTS.length * 10;
                const fillPct = s.pct !== null ? s.pct : Math.round(s.total / maxPossible * 100);
                const grade   = s.total >= 81 ? 'Excellent' : s.total >= 63 ? 'Good' : s.total >= 45 ? 'Average' : 'Needs Improvement';
                const gcolor  = s.total >= 81 ? 'var(--accent-green)' : s.total >= 63 ? '#00c6ff' : s.total >= 45 ? '#ffc107' : '#ff4444';
                const medal   = s.total >= 81 ? 'ü•á' : s.total >= 63 ? 'ü•à' : s.total >= 45 ? 'ü•â' : 'üìä';

                return `
                <div class="card" style="margin-bottom:18px; border-left:5px solid ${gcolor};">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:14px;">
                            <div style="font-size:32px;">${medal}</div>
                            <div>
                                <div style="font-size:20px; font-weight:800;">#${i+1} ${s.worker}</div>
                                <div style="font-size:13px; color:${gcolor}; font-weight:700; margin-top:2px;">${grade} ${s.graded < OP_COMPONENTS.length ? `<span style="color:#ffc107;">(${s.graded}/${OP_COMPONENTS.length} components graded)</span>` : ''}</div>
                            </div>
                        </div>
                        <div style="text-align:center; background:var(--bg-secondary); padding:12px 22px; border-radius:12px; border:2px solid ${gcolor};">
                            <div style="font-size:11px; color:var(--text-secondary); letter-spacing:1px;">TOTAL</div>
                            <div style="font-size:38px; font-weight:900; color:${gcolor}; line-height:1;">${s.total}</div>
                            <div style="font-size:11px; color:var(--text-secondary);">/ ${maxPossible}</div>
                        </div>
                    </div>

                    <!-- Overall bar -->
                    <div style="margin-bottom:20px;">
                        <div style="background:var(--bg-secondary); border-radius:6px; height:12px;">
                            <div style="width:${fillPct}%; background:linear-gradient(90deg,${gcolor},${gcolor}88); height:100%; border-radius:6px; transition:width 0.6s;"></div>
                        </div>
                    </div>

                    <!-- Component breakdown -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:10px; margin-bottom:${s.notes?'16px':'0'};">
                        ${OP_COMPONENTS.map(c => {
                            const v = s.grades[c.key];
                            const col = v !== undefined ? getScoreColor(v) : 'var(--text-secondary)';
                            return `
                            <div style="background:var(--bg-secondary); padding:10px 12px; border-radius:8px; border-left:3px solid ${col};">
                                <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">${c.icon} ${c.label}</div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <div style="font-size:22px; font-weight:800; color:${col};">${v !== undefined ? v : '‚Äî'}</div>
                                    <div style="font-size:11px; color:var(--text-secondary);">/10</div>
                                    <div style="flex:1; background:var(--bg-primary); border-radius:3px; height:4px;">
                                        <div style="width:${v !== undefined ? v*10 : 0}%; background:${col}; height:100%; border-radius:3px;"></div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                    ${s.notes ? `<div style="padding:10px 14px; background:var(--bg-secondary); border-radius:8px; font-size:13px; color:var(--text-secondary);"><strong style="color:var(--text-primary);">üìù Notes:</strong> ${s.notes}</div>` : ''}
                </div>`;
            }).join('');

            resultsDiv.innerHTML = podiumHtml + cards;
        }

        function loadTrendReport() {
            const resultsDiv = document.getElementById('op-scoreboard-results');

            // Collect all months that have any data
            const allMonths = [...new Set(Object.keys(opGrades).map(k => k.split('|')[1]))].sort();
            if (allMonths.length === 0) {
                resultsDiv.innerHTML = `<div class="card" style="text-align:center;padding:60px;color:var(--text-secondary);">No evaluation data found. Grade some workers first.</div>`;
                return;
            }

            const maxScore = OP_COMPONENTS.length * 10; // 90

            // Build data per worker per month
            const workerTrends = WORKERS.map(worker => {
                const monthData = allMonths.map(month => {
                    const key    = opKey(worker, month);
                    const grades = opGrades[key];
                    if (!grades) return { month, total: null, graded: 0 };
                    let total = 0; let count = 0;
                    OP_COMPONENTS.forEach(c => { if (grades[c.key] !== undefined) { total += parseInt(grades[c.key]); count++; } });
                    return { month, total: count > 0 ? total : null, graded: count };
                });
                const scored    = monthData.filter(m => m.total !== null);
                const avgScore  = scored.length > 0 ? Math.round(scored.reduce((s, m) => s + m.total, 0) / scored.length) : null;
                const lastScore = scored.length > 0 ? scored[scored.length - 1].total : null;
                const prevScore = scored.length > 1 ? scored[scored.length - 2].total : null;
                const trend     = lastScore !== null && prevScore !== null ? lastScore - prevScore : null;
                return { worker, monthData, avgScore, lastScore, prevScore, trend };
            }).filter(w => w.avgScore !== null);

            if (workerTrends.length === 0) {
                resultsDiv.innerHTML = `<div class="card" style="text-align:center;padding:60px;color:var(--text-secondary);">No complete evaluations found yet.</div>`;
                return;
            }

            // Month label helper
            const mLabel = m => new Date(m + '-01').toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });

            // Sort by avg score desc
            workerTrends.sort((a, b) => b.avgScore - a.avgScore);

            const trendHtml = workerTrends.map(w => {
                const trendIcon  = w.trend === null ? '‚ûñ' : w.trend > 0 ? 'üìà' : w.trend < 0 ? 'üìâ' : '‚ûñ';
                const trendColor = w.trend === null ? '#5a6a8a' : w.trend > 0 ? 'var(--accent-green)' : w.trend < 0 ? '#ff4444' : '#ffc107';
                const trendText  = w.trend === null ? 'No comparison yet' : w.trend > 0 ? `+${w.trend} vs last month` : w.trend < 0 ? `${w.trend} vs last month` : 'No change';
                const avgColor   = w.avgScore >= 75 ? 'var(--accent-green)' : w.avgScore >= 55 ? '#00c6ff' : w.avgScore >= 36 ? '#ffc107' : '#ff4444';

                // Mini bar chart per month
                const bars = allMonths.map(month => {
                    const md  = w.monthData.find(m => m.month === month);
                    const val = md?.total;
                    const pct = val !== null ? Math.round(val / maxScore * 100) : 0;
                    const col = val !== null ? (val >= 75 ? 'var(--accent-green)' : val >= 55 ? '#00c6ff' : val >= 36 ? '#ffc107' : '#ff4444') : 'var(--bg-primary)';
                    return `
                        <div style="display:flex; flex-direction:column; align-items:center; gap:4px; flex:1; min-width:40px;">
                            <div style="font-size:11px; font-weight:700; color:${val !== null ? col : 'var(--text-secondary)'};">${val !== null ? val : '‚Äî'}</div>
                            <div style="width:100%; background:var(--bg-primary); border-radius:4px; height:60px; display:flex; align-items:flex-end;">
                                <div style="width:100%; height:${pct}%; background:${col}; border-radius:4px; transition:height 0.5s; min-height:${val !== null ? '4px' : '0'};"></div>
                            </div>
                            <div style="font-size:10px; color:var(--text-secondary); text-align:center;">${mLabel(month)}</div>
                        </div>`;
                }).join('');

                // Component breakdown across all months (averages)
                const compAvgs = OP_COMPONENTS.map(c => {
                    const vals = allMonths.map(month => {
                        const grades = opGrades[opKey(w.worker, month)];
                        return grades && grades[c.key] !== undefined ? parseInt(grades[c.key]) : null;
                    }).filter(v => v !== null);
                    return { ...c, avg: vals.length > 0 ? (vals.reduce((s,v) => s+v, 0) / vals.length).toFixed(1) : null };
                });

                return `
                <div class="card" style="margin-bottom:18px; border-left:5px solid ${avgColor};">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:20px;">
                        <div>
                            <div style="font-size:20px; font-weight:800;">${w.worker}</div>
                            <div style="font-size:13px; color:${trendColor}; font-weight:700; margin-top:4px;">${trendIcon} ${trendText}</div>
                        </div>
                        <div style="display:flex; gap:14px;">
                            <div style="text-align:center; background:var(--bg-secondary); padding:10px 18px; border-radius:10px;">
                                <div style="font-size:11px; color:var(--text-secondary);">AVG SCORE</div>
                                <div style="font-size:28px; font-weight:900; color:${avgColor};">${w.avgScore}<span style="font-size:13px;">/90</span></div>
                            </div>
                            ${w.lastScore !== null ? `
                            <div style="text-align:center; background:var(--bg-secondary); padding:10px 18px; border-radius:10px;">
                                <div style="font-size:11px; color:var(--text-secondary);">LATEST</div>
                                <div style="font-size:28px; font-weight:900; color:${avgColor};">${w.lastScore}<span style="font-size:13px;">/90</span></div>
                            </div>` : ''}
                        </div>
                    </div>

                    <!-- Monthly bar chart -->
                    <div style="margin-bottom:20px;">
                        <div style="font-size:11px; color:var(--text-secondary); letter-spacing:1px; margin-bottom:10px;">MONTHLY SCORES</div>
                        <div style="display:flex; gap:8px; align-items:flex-end;">${bars}</div>
                    </div>

                    <!-- Component averages -->
                    <div style="font-size:11px; color:var(--text-secondary); letter-spacing:1px; margin-bottom:10px;">AVERAGE PER COMPONENT</div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px,1fr)); gap:8px;">
                        ${compAvgs.map(c => {
                            const v   = c.avg;
                            const col = v !== null ? getScoreColor(Math.round(parseFloat(v))) : 'var(--text-secondary)';
                            return `
                            <div style="background:var(--bg-secondary); padding:10px 12px; border-radius:8px; border-left:3px solid ${col}; display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:12px;">${c.icon} ${c.label}</div>
                                <div style="font-size:16px; font-weight:800; color:${col};">${v !== null ? v : '‚Äî'}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');

            const monthRange = `${mLabel(allMonths[0])} ‚Üí ${mLabel(allMonths[allMonths.length - 1])}`;
            resultsDiv.innerHTML = `
                <div class="card" style="margin-bottom:20px; padding:16px 20px; border-left:4px solid #ffc107;">
                    <div style="font-size:16px; font-weight:800; color:#ffc107;">üìà Score Trend Report</div>
                    <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">${monthRange} ¬∑ ${allMonths.length} month${allMonths.length>1?'s':''} ¬∑ ${workerTrends.length} workers evaluated</div>
                </div>
                ${trendHtml}`;
        }

        // ==================== ATTENDANCE SYSTEM ====================

        const WORKERS = [
            'Mohammad Obeid', 'Ahmad Issa', 'Bashar Mhaymed', 'Omar Saho',
            'Ibrahim Mohsen', 'Mohammad Mhaymed', 'Ahmad Abboud', 'Mohammad Abboud',
            'Kabir', 'Sohan'
        ];

        let attendanceData = {}; // { 'YYYY-MM-DD': { 'WorkerName': { status, time } } }

        function initAttendance() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('att-date').value = today;

            // Set default date ranges
            const firstOfMonth = new Date();
            firstOfMonth.setDate(1);
            const fromStr = firstOfMonth.toISOString().split('T')[0];
            document.getElementById('att-from').value = fromStr;
            document.getElementById('att-to').value = today;
            document.getElementById('att-stats-from').value = fromStr;
            document.getElementById('att-stats-to').value = today;

            loadAttendanceFromSheet();
        }

        function switchAttTab(tab) {
            ['today','history','stats'].forEach(t => {
                document.getElementById('att-' + t).style.display = t === tab ? 'block' : 'none';
                const btn = document.getElementById('att-tab-' + t);
                btn.className = t === tab ? 'btn-success' : 'btn-secondary';
                btn.style.padding = '10px 24px';
            });
            if (tab === 'today') loadAttendanceForDate();
        }

        async function loadAttendanceFromSheet() {
            if (!SCRIPT_URL) return;
            try {
                const url = SCRIPT_URL + '?action=getAttendance&t=' + Date.now();
                const response = await fetch(url, { method: 'GET', redirect: 'follow' });
                const text = await response.text();
                const json = JSON.parse(text);
                if (json.status === 'ok' && json.data) {
                    attendanceData = json.data;
                }
            } catch(e) {
                console.log('No attendance data yet');
            }
            loadAttendanceForDate();
        }

        function loadAttendanceForDate() {
            const date = document.getElementById('att-date').value;
            if (!date) return;

            // Auto-mark all present if no data for this date
            if (!attendanceData[date]) {
                attendanceData[date] = {};
                WORKERS.forEach(w => {
                    attendanceData[date][w] = { status: 'present', time: '' };
                });
            }

            renderWorkerGrid(date);
            updateAttKPIs(date);
        }

        function renderWorkerGrid(date) {
            const grid = document.getElementById('att-worker-grid');
            const dayData = attendanceData[date] || {};

            grid.innerHTML = WORKERS.map(worker => {
                const rec = dayData[worker] || { status: 'present', time: '' };
                const statusColor = rec.status === 'present' ? 'var(--accent-green)' :
                                    rec.status === 'late'    ? '#ffc107' : '#ff4444';
                const statusBg    = rec.status === 'present' ? 'rgba(0,255,136,0.08)' :
                                    rec.status === 'late'    ? 'rgba(255,193,7,0.08)' : 'rgba(255,68,68,0.08)';
                const icon = rec.status === 'present' ? '‚úÖ' : rec.status === 'late' ? '‚è∞' : '‚ùå';

                return `
                    <div id="worker-card-${worker.replace(/\s/g,'_')}" style="background:${statusBg}; border:2px solid ${statusColor}; border-radius:12px; padding:16px; transition:all 0.3s;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div style="font-weight:700; font-size:15px;">${worker}</div>
                            <div style="font-size:22px;">${icon}</div>
                        </div>
                        <div style="display:flex; gap:6px; margin-bottom:10px;">
                            <button onclick="setWorkerStatus('${worker}','${date}','present')"
                                style="flex:1; padding:7px; border-radius:8px; border:none; cursor:pointer; font-size:12px; font-weight:700;
                                background:${rec.status==='present' ? 'var(--accent-green)' : 'rgba(0,255,136,0.1)'}; 
                                color:${rec.status==='present' ? '#000' : 'var(--accent-green)'};">
                                ‚úÖ Present
                            </button>
                            <button onclick="setWorkerStatus('${worker}','${date}','late')"
                                style="flex:1; padding:7px; border-radius:8px; border:none; cursor:pointer; font-size:12px; font-weight:700;
                                background:${rec.status==='late' ? '#ffc107' : 'rgba(255,193,7,0.1)'}; 
                                color:${rec.status==='late' ? '#000' : '#ffc107'};">
                                ‚è∞ Late
                            </button>
                            <button onclick="setWorkerStatus('${worker}','${date}','absent')"
                                style="flex:1; padding:7px; border-radius:8px; border:none; cursor:pointer; font-size:12px; font-weight:700;
                                background:${rec.status==='absent' ? '#ff4444' : 'rgba(255,68,68,0.1)'}; 
                                color:${rec.status==='absent' ? '#fff' : '#ff4444'};">
                                ‚ùå Absent
                            </button>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:11px; color:var(--text-secondary);">Time in:</span>
                            <input type="time" value="${rec.time || ''}"
                                onchange="setWorkerTime('${worker}','${date}',this.value)"
                                style="background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:6px; padding:4px 8px; color:var(--text-primary); font-size:12px;">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setWorkerStatus(worker, date, status) {
            if (!attendanceData[date]) attendanceData[date] = {};
            if (!attendanceData[date][worker]) attendanceData[date][worker] = {};
            attendanceData[date][worker].status = status;
            if (status === 'present' && !attendanceData[date][worker].time) {
                const now = new Date();
                attendanceData[date][worker].time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            }
            renderWorkerGrid(date);
            updateAttKPIs(date);
        }

        function setWorkerTime(worker, date, time) {
            if (!attendanceData[date]) attendanceData[date] = {};
            if (!attendanceData[date][worker]) attendanceData[date][worker] = {};
            attendanceData[date][worker].time = time;

            // Late if arrives after 07:40
            const lateThreshold = '07:40';
            if (time && time > lateThreshold) {
                attendanceData[date][worker].status = 'late';
            } else if (time && time <= lateThreshold) {
                attendanceData[date][worker].status = 'present';
            }
            renderWorkerGrid(date);
            updateAttKPIs(date);
        }

        function markAllPresent() {
            const date = document.getElementById('att-date').value;
            if (!attendanceData[date]) attendanceData[date] = {};
            WORKERS.forEach(w => { attendanceData[date][w] = { status: 'present', time: '' }; });
            renderWorkerGrid(date);
            updateAttKPIs(date);
        }

        function markAllAbsent() {
            const date = document.getElementById('att-date').value;
            if (!attendanceData[date]) attendanceData[date] = {};
            WORKERS.forEach(w => { attendanceData[date][w] = { status: 'absent', time: '' }; });
            renderWorkerGrid(date);
            updateAttKPIs(date);
        }

        function updateAttKPIs(date) {
            const dayData = attendanceData[date] || {};
            let present = 0, absent = 0, late = 0;
            WORKERS.forEach(w => {
                const s = (dayData[w] || {}).status || 'present';
                if (s === 'present') present++;
                else if (s === 'absent') absent++;
                else if (s === 'late') late++;
            });
            const total = WORKERS.length;
            document.getElementById('att-present-count').textContent = present;
            document.getElementById('att-absent-count').textContent = absent;
            document.getElementById('att-late-count').textContent = late;
            document.getElementById('att-rate').textContent = Math.round((present + late) / total * 100) + '%';
        }

        async function saveAttendance() {
            if (!SCRIPT_URL) { alert('No Apps Script URL configured.'); return; }
            const date = document.getElementById('att-date').value;
            try {
                const params = new URLSearchParams({
                    action: 'saveAttendance',
                    date: date,
                    data: JSON.stringify(attendanceData[date]),
                    t: Date.now()
                });
                const response = await fetch(SCRIPT_URL + '?' + params.toString(), { method: 'GET', redirect: 'follow' });
                const text = await response.text();
                const json = JSON.parse(text);
                if (json.status === 'ok') {
                    alert('‚úÖ Attendance saved for ' + date);
                } else {
                    alert('‚ùå Save failed: ' + json.message);
                }
            } catch(e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        function loadAttendanceHistory() {
            const from = document.getElementById('att-from').value;
            const to   = document.getElementById('att-to').value;
            if (!from || !to) { alert('Please select date range'); return; }

            const results = document.getElementById('att-history-results');

            // Get all dates in range that have data
            const dates = Object.keys(attendanceData).filter(d => d >= from && d <= to).sort().reverse();

            if (dates.length === 0) {
                results.innerHTML = `<div class="card" style="text-align:center; padding:40px; color:var(--text-secondary);">No attendance records found for this date range</div>`;
                return;
            }

            results.innerHTML = dates.map(date => {
                const dayData = attendanceData[date] || {};
                let present = 0, absent = 0, late = 0;
                WORKERS.forEach(w => {
                    const s = (dayData[w] || {}).status || 'present';
                    if (s === 'present') present++;
                    else if (s === 'absent') absent++;
                    else if (s === 'late') late++;
                });

                const absentWorkers = WORKERS.filter(w => (dayData[w] || {}).status === 'absent');
                const lateWorkers   = WORKERS.filter(w => (dayData[w] || {}).status === 'late');

                return `
                    <div class="card" style="margin-bottom:14px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                            <div style="font-size:17px; font-weight:700;">${formatDate(date)}</div>
                            <div style="display:flex; gap:16px;">
                                <span style="color:var(--accent-green); font-weight:700;">‚úÖ ${present} Present</span>
                                <span style="color:#ffc107; font-weight:700;">‚è∞ ${late} Late</span>
                                <span style="color:#ff4444; font-weight:700;">‚ùå ${absent} Absent</span>
                                <span style="color:var(--accent-blue); font-weight:700;">${Math.round((present+late)/WORKERS.length*100)}%</span>
                            </div>
                        </div>
                        ${absentWorkers.length > 0 ? `<div style="margin-top:10px; font-size:13px; color:#ff4444;">Absent: ${absentWorkers.join(', ')}</div>` : ''}
                        ${lateWorkers.length > 0 ? `<div style="margin-top:4px; font-size:13px; color:#ffc107;">Late: ${lateWorkers.join(', ')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function loadWorkerStats() {
            const from = document.getElementById('att-stats-from').value;
            const to   = document.getElementById('att-stats-to').value;
            if (!from || !to) { alert('Please select date range'); return; }

            const dates = Object.keys(attendanceData).filter(d => d >= from && d <= to);
            const totalDays = dates.length;

            if (totalDays === 0) {
                document.getElementById('att-stats-results').innerHTML =
                    `<div class="card" style="text-align:center; padding:40px; color:var(--text-secondary);">No records found for this period</div>`;
                return;
            }

            // Build stats per worker
            const stats = WORKERS.map(worker => {
                let present = 0, late = 0, absent = 0;
                dates.forEach(date => {
                    const s = (attendanceData[date]?.[worker] || {}).status || 'present';
                    if (s === 'present') present++;
                    else if (s === 'late') late++;
                    else absent++;
                });
                const rate = Math.round((present + late) / totalDays * 100);
                return { worker, present, late, absent, rate, totalDays };
            });

            // Sort by attendance rate ascending (worst first)
            stats.sort((a, b) => a.rate - b.rate);

            document.getElementById('att-stats-results').innerHTML = `
                <div class="card" style="margin-bottom:20px; padding:16px 20px;">
                    <div style="font-size:13px; color:var(--text-secondary); margin-bottom:4px;">PERIOD</div>
                    <div style="font-weight:700;">${formatDate(from)} ‚Üí ${formatDate(to)} &nbsp;¬∑&nbsp; ${totalDays} working days recorded</div>
                </div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:14px;">
                    ${stats.map(s => {
                        const color = s.rate >= 90 ? 'var(--accent-green)' : s.rate >= 75 ? '#ffc107' : '#ff4444';
                        const flag  = s.absent >= 3 ? 'üö® Consistently Absent' : s.late >= 3 ? '‚ö†Ô∏è Often Late' : '‚úÖ Reliable';
                        const flagColor = s.absent >= 3 ? '#ff4444' : s.late >= 3 ? '#ffc107' : 'var(--accent-green)';
                        return `
                            <div class="card" style="border-left:4px solid ${color}; padding:16px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <div style="font-weight:700; font-size:15px;">${s.worker}</div>
                                    <div style="font-size:22px; font-weight:800; color:${color};">${s.rate}%</div>
                                </div>
                                <div style="display:flex; gap:12px; margin-bottom:12px; font-size:13px;">
                                    <span style="color:var(--accent-green);">‚úÖ ${s.present} Present</span>
                                    <span style="color:#ffc107;">‚è∞ ${s.late} Late</span>
                                    <span style="color:#ff4444;">‚ùå ${s.absent} Absent</span>
                                </div>
                                <!-- Progress bar -->
                                <div style="background:var(--bg-secondary); border-radius:4px; height:6px; margin-bottom:10px;">
                                    <div style="width:${s.rate}%; background:${color}; height:100%; border-radius:4px; transition:width 0.5s;"></div>
                                </div>
                                <div style="font-size:12px; font-weight:700; color:${flagColor};">${flag}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ==================== PALANTIR AI ====================

        let palantirHistory = [];

        const PALANTIR_SYSTEM = `You are Palantir ‚Äî a warm, witty, and deeply experienced specialist in the paints and coatings industry with over 30 years of hands-on expertise. You have worked as a formulation chemist, technical sales director, and production consultant across architectural, industrial, automotive, marine, and protective coatings.

Your personality:
- Friendly, approachable, and conversational. You greet people warmly and enthusiastically.
- When someone says hello, hi, or greets you ‚Äî respond warmly like a colleague who is always happy to help. Say things like "Hey!! How are you doing today? Great to have you here!" Be genuinely enthusiastic.
- Use phrases like "Great question!", "In my 30 years I have seen this a hundred times...", "Let me tell you from experience..."
- You are passionate about coatings and it shows. You love talking about your field.
- You can be direct and opinionated ‚Äî you are not just reciting textbook knowledge.
- If someone is just chatting, chat back naturally. Do not force technical info on them.

Your deep expertise:
- Paint formulation chemistry: resins, pigments, solvents, additives, extenders
- All coating types: architectural, industrial, automotive, marine, protective, powder, UV-cure
- Raw materials: TiO2, carbon black, alkyd, epoxy, polyurethane, acrylic, latex, silicone
- Application: spray, brush, roll, dip, electrostatic, airless, HVLP
- Quality control: viscosity, hiding power, gloss, adhesion, hardness, flexibility, drying time, fineness of grind
- Troubleshooting: sagging, cratering, fisheye, orange peel, poor adhesion, color drift, chalking, flocculation, syneresis
- Standards: ASTM, ISO, BS, EN testing methods
- VOC regulations, REACH, RoHS, environmental compliance
- Production: dispersion, grinding, let-down, tinting, color matching
- Rheology, color science, film formation, corrosion protection

Always respond naturally and helpfully. Use formatting when it adds clarity, but keep a human tone throughout.`;

        function palantirKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendPalantirMessage();
            }
        }

        function useSuggestion(text) {
            document.getElementById('palantir-input').value = text;
            sendPalantirMessage();
        }

        function sendPalantirMessage() {
            const input = document.getElementById('palantir-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            input.style.height = 'auto';

            // Append user message
            appendPalantirMessage('user', text);
            palantirHistory.push({ role: 'user', content: text });

            // Show typing indicator
            const typingId = showPalantirTyping();

            // Call Claude API
            callPalantirAPI(typingId);
        }

        function appendPalantirMessage(role, content) {
            const container = document.getElementById('palantir-messages');
            const isUser = role === 'user';

            const div = document.createElement('div');
            div.style.cssText = `display:flex; gap:14px; align-items:flex-start; animation:palantir-fadein 0.4s ease; justify-content:${isUser ? 'flex-end' : 'flex-start'};`;

            if (isUser) {
                div.innerHTML = `
                    <div style="background:linear-gradient(135deg, rgba(123,47,247,0.25), rgba(0,198,255,0.15)); border:1px solid rgba(123,47,247,0.4); border-radius:16px 4px 16px 16px; padding:14px 18px; max-width:600px; color:#e0e8f0; font-size:14px; line-height:1.6;">
                        ${escapeHtml(content)}
                    </div>
                    <div style="width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, #1a1a3a, #2a2a4a); border:1px solid rgba(123,47,247,0.4); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0;">üë§</div>
                `;
            } else {
                div.innerHTML = `
                    <div style="width:36px; height:36px; border-radius:50%; background:radial-gradient(circle at 35% 35%, #7b2ff7, #00c6ff); flex-shrink:0; box-shadow:0 0 15px rgba(123,47,247,0.5);"></div>
                    <div style="background:linear-gradient(135deg, #0f0f2a, #12122a); border:1px solid rgba(123,47,247,0.3); border-radius:4px 16px 16px 16px; padding:18px 22px; max-width:700px; color:#c8d0e0; font-size:14px; line-height:1.8;">
                        <div style="font-size:11px; font-weight:700; color:#7b2ff7; letter-spacing:2px; margin-bottom:10px;">PALANTIR</div>
                        <div class="palantir-response-content">${formatPalantirResponse(content)}</div>
                    </div>
                `;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function showPalantirTyping() {
            const container = document.getElementById('palantir-messages');
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.style.cssText = 'display:flex; gap:14px; align-items:flex-start; animation:palantir-fadein 0.3s ease;';
            div.innerHTML = `
                <div style="width:36px; height:36px; border-radius:50%; background:radial-gradient(circle at 35% 35%, #7b2ff7, #00c6ff); flex-shrink:0; box-shadow:0 0 15px rgba(123,47,247,0.5);"></div>
                <div style="background:linear-gradient(135deg, #0f0f2a, #12122a); border:1px solid rgba(123,47,247,0.3); border-radius:4px 16px 16px 16px; padding:18px 22px;">
                    <div style="font-size:11px; font-weight:700; color:#7b2ff7; letter-spacing:2px; margin-bottom:12px;">PALANTIR</div>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <div style="width:8px;height:8px;border-radius:50%;background:#7b2ff7;animation:palantir-typing 1.2s ease-in-out infinite;"></div>
                        <div style="width:8px;height:8px;border-radius:50%;background:#7b2ff7;animation:palantir-typing 1.2s ease-in-out infinite 0.2s;"></div>
                        <div style="width:8px;height:8px;border-radius:50%;background:#00c6ff;animation:palantir-typing 1.2s ease-in-out infinite 0.4s;"></div>
                        <span style="color:#5a6a8a; font-size:12px; margin-left:4px;">Analysing...</span>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        async function callPalantirAPI(typingId) {
            const proxyUrl = SCRIPT_URL;

            if (!proxyUrl) {
                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();
                appendPalantirMessage('assistant', 'I need a connection to work! Please configure your Apps Script URL in ‚öôÔ∏è Settings and add the Palantir function to your Apps Script code.');
                return;
            }

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                const params = new URLSearchParams({
                    action: 'palantir',
                    messages: JSON.stringify(palantirHistory),
                    t: Date.now()
                });

                const response = await fetch(proxyUrl + '?' + params.toString(), {
                    method: 'GET',
                    redirect: 'follow',
                    signal: controller.signal
                });
                clearTimeout(timeout);

                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();

                const text = await response.text();
                let json;
                try { json = JSON.parse(text); } catch(e) {
                    throw new Error('Could not parse server response');
                }

                if (json.status === 'ok' && json.reply) {
                    let finalReply = json.reply;
                    
                    // Handle case where reply is a raw Claude API response (JSON string)
                    if (typeof finalReply === 'string' && finalReply.startsWith('{')) {
                        try {
                            const inner = JSON.parse(finalReply);
                            // Extract text from Claude API response format
                            if (inner.content && inner.content[0] && inner.content[0].text) {
                                finalReply = inner.content[0].text;
                            } else if (inner.error) {
                                finalReply = 'API Error: ' + inner.error.message;
                            }
                        } catch(e) {
                            // keep as-is if can't parse
                        }
                    }
                    
                    palantirHistory.push({ role: 'assistant', content: finalReply });
                    appendPalantirMessage('assistant', finalReply);
                } else {
                    throw new Error(json.message || 'No reply received');
                }

            } catch (err) {
                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();
                const msg = err.name === 'AbortError'
                    ? 'Request timed out. Please try again.'
                    : `Connection issue: **${err.message}**\n\nMake sure your Apps Script has the Palantir function deployed.`;
                appendPalantirMessage('assistant', msg);
            }
        }

                function formatPalantirResponse(text) {
            return text
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#e0e8f0;">$1</strong>')
                // Headers
                .replace(/^### (.+)$/gm, '<div style="font-size:13px; font-weight:700; color:#00c6ff; letter-spacing:1px; margin:16px 0 8px; text-transform:uppercase;">$1</div>')
                .replace(/^## (.+)$/gm,  '<div style="font-size:15px; font-weight:700; color:#7b2ff7; margin:16px 0 8px;">$1</div>')
                .replace(/^# (.+)$/gm,   '<div style="font-size:17px; font-weight:800; color:#a78bfa; margin:16px 0 8px;">$1</div>')
                // Bullet points
                .replace(/^[\-\*] (.+)$/gm, '<div style="display:flex; gap:8px; margin:4px 0;"><span style="color:#7b2ff7; flex-shrink:0;">‚ñ∏</span><span>$1</span></div>')
                // Numbered lists
                .replace(/^\d+\. (.+)$/gm, '<div style="display:flex; gap:8px; margin:4px 0;"><span style="color:#00c6ff; flex-shrink:0; font-weight:700; font-size:12px;">‚óè</span><span>$1</span></div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background:rgba(123,47,247,0.2); color:#a78bfa; padding:2px 6px; border-radius:4px; font-family:monospace; font-size:12px;">$1</code>')
                // Line breaks
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // ==================== BATCH SEARCH ====================

        function initBatchSearch() {
            // Show all batches that have saved details as quick suggestions
            const savedBatches = Object.keys(allBatchData);
            const hint = document.getElementById('batch-search-hint');
            if (savedBatches.length > 0) {
                hint.innerHTML = `<span style="color:var(--accent-green)">‚úÖ ${savedBatches.length} batch(es) with saved details:</span> ` +
                    savedBatches.slice(0, 10).map(b =>
                        `<span onclick="document.getElementById('batch-search-input').value='${b}'; searchBatch();"
                            style="cursor:pointer; background:var(--bg-secondary); padding:3px 10px; border-radius:12px; margin:2px; display:inline-block; color:var(--accent-blue);">
                            #${b}
                        </span>`
                    ).join('') +
                    (savedBatches.length > 10 ? ` <span style="color:var(--text-secondary)">+${savedBatches.length - 10} more</span>` : '');
            } else {
                hint.innerHTML = 'No saved batch details yet. Save details via any batch link first.';
            }
        }

        function clearBatchSearch() {
            document.getElementById('batch-search-input').value = '';
            document.getElementById('batch-search-results').innerHTML = '';
            initBatchSearch();
        }

        function searchBatch() {
            const query = document.getElementById('batch-search-input').value.trim();
            const resultsDiv = document.getElementById('batch-search-results');

            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            // Find all matching rows in production data
            const matches = allProductionData.slice(1).filter(row =>
                row[2] && row[2].toString().toLowerCase().includes(query.toLowerCase())
            );

            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="card" style="text-align:center; padding:60px;">
                        <div style="font-size:60px; margin-bottom:15px;">üîç</div>
                        <h3 style="color:var(--text-secondary);">No batch found matching "${query}"</h3>
                        <p style="color:var(--text-secondary); margin-top:10px;">Check the batch number and try again</p>
                    </div>`;
                return;
            }

            resultsDiv.innerHTML = matches.map(row => buildBatchSearchCard(row)).join('');
        }

        function buildBatchSearchCard(row) {
            const batchNum   = (row[2] || '').toString().trim();
            const date       = formatDate(row[0]);
            const product    = row[1] || 'N/A';
            const weight     = row[3] || '-';
            const actual     = row[4] || '-';
            const yieldPct   = row[5] || '-';
            const verdict    = row[6] || '-';
            const vesselSheet = row[7] || '-';
            const sugMixers  = row[8] || '-';
            const sugGrinders = row[9] || '-';

            const details    = allBatchData[batchNum];
            const hasDetails = details && Object.keys(details).length > 0;

            // Vessel: prefer manually saved one
            const vessel = (hasDetails && details['Vessel Used']) ? details['Vessel Used'] : vesselSheet;

            // Filling data for this batch
            const fills = allFillingData.slice(1).filter(r =>
                r[2] && r[2].toString().trim() === batchNum
            );

            // Verdict color
            const verdictColor = verdict === 'Pass' ? 'var(--accent-green)' :
                                 verdict === 'Fail' ? '#ff4444' : 'var(--text-secondary)';

            // Problems
            let problemsHtml = '';
            if (hasDetails && details['Problems']) {
                try {
                    const probs = JSON.parse(details['Problems']);
                    if (probs && probs.length > 0) {
                        problemsHtml = `
                            <div style="margin-top:15px; padding:15px; background:rgba(255,68,68,0.08); border-left:4px solid #ff4444; border-radius:6px;">
                                <div style="font-weight:700; color:#ff4444; margin-bottom:10px;">‚ö†Ô∏è Problems Recorded (${probs.length})</div>
                                ${probs.map(p => `
                                    <div style="padding:8px 12px; background:var(--bg-primary); border-radius:6px; margin-bottom:6px; font-size:13px;">
                                        <span style="font-weight:600; color:var(--accent-yellow);">${p.type}</span>
                                        ${p.initialViscosity ? ` ‚Äî Initial: ${p.initialViscosity}, Final: ${p.finalViscosity}` : ''}
                                        ${p.expectedColor ? ` ‚Äî Expected: ${p.expectedColor}, Actual: ${p.actualColor}` : ''}
                                        ${p.correctionAction ? `<br><span style="color:var(--text-secondary);">Fix: ${p.correctionAction}</span>` : ''}
                                        ${p.expectedDrying ? ` ‚Äî Expected: ${p.expectedDrying}h, Actual: ${p.actualDrying}h` : ''}
                                        ${p.dryingSolution ? `<br><span style="color:var(--text-secondary);">Fix: ${p.dryingSolution}</span>` : ''}
                                        ${p.targetFineness ? ` ‚Äî Target: ${p.targetFineness}¬µm, Actual: ${p.actualFineness}¬µm` : ''}
                                        ${p.grindingAction ? `<br><span style="color:var(--text-secondary);">Fix: ${p.grindingAction}</span>` : ''}
                                        ${p.dispersingIssue ? `<br><span style="color:var(--text-secondary);">${p.dispersingIssue}</span>` : ''}
                                        ${p.damageCause ? ` ‚Äî Cause: ${p.damageCause}, Loss: ${p.lossAmount || 'N/A'}` : ''}
                                    </div>
                                `).join('')}
                            </div>`;
                    }
                } catch(e) {}
            }

            // Filling operations
            let fillingHtml = '';
            if (fills.length > 0) {
                fillingHtml = `
                    <div style="margin-top:15px;">
                        <div style="font-weight:700; color:var(--accent-green); margin-bottom:10px;">üì¶ Filling Operations</div>
                        ${fills.map(f => `
                            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:10px; padding:12px; background:var(--bg-secondary); border-radius:8px; margin-bottom:8px; font-size:13px;">
                                <div><span style="color:var(--text-secondary);">Type</span><br><strong>${f[3]||'-'}</strong></div>
                                <div><span style="color:var(--text-secondary);">Package</span><br><strong>${f[4]||'-'}</strong></div>
                                <div><span style="color:var(--text-secondary);">Quantity</span><br><strong>${f[5]||'-'}</strong></div>
                                <div><span style="color:var(--text-secondary);">Box Types</span><br><strong>${f[6]||'-'}</strong></div>
                                <div><span style="color:var(--text-secondary);">Box Qty</span><br><strong>${f[7]||'-'}</strong></div>
                                <div><span style="color:var(--text-secondary);">Start</span><br><strong>${formatTime(f[9])}</strong></div>
                                <div><span style="color:var(--text-secondary);">End</span><br><strong>${formatTime(f[10])}</strong></div>
                            </div>
                        `).join('')}
                    </div>`;
            }

            return `
                <div class="card" style="margin-bottom:20px; border-left: 5px solid ${hasDetails ? 'var(--accent-green)' : 'var(--border-color)'};">

                    <!-- Top header -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
                        <div>
                            <div style="font-size:28px; font-weight:800; color:var(--accent-blue);">Batch #${batchNum}</div>
                            <div style="font-size:16px; color:var(--text-primary); margin-top:4px;">${product}</div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:2px;">${date}</div>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            ${hasDetails
                                ? '<span style="background:rgba(0,255,136,0.15); color:var(--accent-green); padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">‚úÖ DETAILS SAVED</span>'
                                : '<span style="background:rgba(255,255,255,0.05); color:var(--text-secondary); padding:6px 14px; border-radius:20px; font-size:12px;">No saved details</span>'}
                            ${fills.length > 0
                                ? `<span style="background:rgba(0,180,255,0.15); color:var(--accent-blue); padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700;">üì¶ FILLED</span>`
                                : '<span style="background:rgba(255,193,7,0.1); color:#ffc107; padding:6px 14px; border-radius:20px; font-size:12px;">‚è≥ Not yet filled</span>'}
                            <button class="btn-secondary" onclick="showBatchDetails('${batchNum}')" style="padding:6px 16px; font-size:13px;">
                                ‚úèÔ∏è Edit Details
                            </button>
                        </div>
                    </div>

                    <!-- Production info grid -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px,1fr)); gap:12px; margin-bottom:5px;">
                        <div style="background:var(--bg-secondary); padding:12px; border-radius:8px;">
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">PLANNED WEIGHT</div>
                            <div style="font-size:18px; font-weight:700;">${weight}</div>
                        </div>
                        <div style="background:var(--bg-secondary); padding:12px; border-radius:8px;">
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">ACTUAL WEIGHT</div>
                            <div style="font-size:18px; font-weight:700;">${actual}</div>
                        </div>
                        <div style="background:var(--bg-secondary); padding:12px; border-radius:8px;">
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">YIELD</div>
                            <div style="font-size:18px; font-weight:700;">${yieldPct}</div>
                        </div>
                        <div style="background:var(--bg-secondary); padding:12px; border-radius:8px;">
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">VERDICT</div>
                            <div style="font-size:18px; font-weight:700; color:${verdictColor};">${verdict}</div>
                        </div>
                        <div style="background:var(--bg-secondary); padding:12px; border-radius:8px;">
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">VESSEL</div>
                            <div style="font-size:18px; font-weight:700;">${vessel}</div>
                        </div>
                    </div>

                    ${hasDetails ? `
                    <!-- Saved edits section -->
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border-color);">
                        <div style="font-weight:700; color:var(--accent-green); margin-bottom:12px; font-size:15px;">üìù Your Saved Edits</div>
                        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:10px;">
                            ${details['Vessel Used'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">VESSEL USED</div><div style="font-weight:600; margin-top:3px;">${details['Vessel Used']}</div></div>` : ''}
                            ${details['Mixer Used (Actual)'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">MIXER</div><div style="font-weight:600; margin-top:3px;">${details['Mixer Used (Actual)']}</div></div>` : ''}
                            ${details['Grinder Used (Actual)'] && details['Grinder Used (Actual)'] !== 'N/A' ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">GRINDER</div><div style="font-weight:600; margin-top:3px;">${details['Grinder Used (Actual)']}</div></div>` : ''}
                            ${details['Total Manpower'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">TOTAL MANPOWER</div><div style="font-weight:600; margin-top:3px;">${details['Total Manpower']}</div></div>` : ''}
                            ${details['Mixer/Grinder Operators'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">MIXER/GRINDER OPS</div><div style="font-weight:600; margin-top:3px;">${details['Mixer/Grinder Operators']}</div></div>` : ''}
                            ${details['Filling Operators'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">FILLING OPS</div><div style="font-weight:600; margin-top:3px;">${details['Filling Operators']}</div></div>` : ''}
                            ${details['Time on Mixer (min)'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">TIME ON MIXER</div><div style="font-weight:600; margin-top:3px;">${details['Time on Mixer (min)']} min</div></div>` : ''}
                            ${details['Time on Grinder (min)'] && details['Time on Grinder (min)'] !== '0' ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">TIME ON GRINDER</div><div style="font-weight:600; margin-top:3px;">${details['Time on Grinder (min)']} min</div></div>` : ''}
                            ${details['TOTAL PROCESS TIME (min)'] ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">TOTAL PROCESS TIME</div><div style="font-weight:600; margin-top:3px; color:var(--accent-green);">${details['TOTAL PROCESS TIME (min)']} min</div></div>` : ''}
                            ${details['Downtime (min)'] && details['Downtime (min)'] !== '0' ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px;"><div style="font-size:11px; color:var(--text-secondary);">DOWNTIME</div><div style="font-weight:600; margin-top:3px; color:#ff4444;">${details['Downtime (min)']} min</div></div>` : ''}
                            ${details['Reason of Downtime'] && details['Reason of Downtime'] !== 'N/A' ? `<div style="background:var(--bg-secondary); padding:10px; border-radius:8px; grid-column:span 2;"><div style="font-size:11px; color:var(--text-secondary);">DOWNTIME REASON</div><div style="font-weight:600; margin-top:3px;">${details['Reason of Downtime']}</div></div>` : ''}
                        </div>
                    </div>` : ''}

                    ${problemsHtml}
                    ${fillingHtml}
                </div>
            `;
        }

        // ==================== SETTINGS ====================
        function openSettings() {
            document.getElementById('settings-sheet-id').value   = SHEET_ID;
            document.getElementById('settings-api-key').value    = API_KEY;
            document.getElementById('settings-script-url').value = SCRIPT_URL;
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function saveSettings() {
            const sheetId   = document.getElementById('settings-sheet-id').value.trim();
            const apiKey    = document.getElementById('settings-api-key').value.trim();
            const scriptUrl = document.getElementById('settings-script-url').value.trim();

            if (!sheetId || !apiKey) {
                alert('Sheet ID and API Key are required.');
                return;
            }

            localStorage.setItem('sheetId',   sheetId);
            localStorage.setItem('apiKey',    apiKey);
            localStorage.setItem('scriptUrl', scriptUrl);

            SHEET_ID   = sheetId;
            API_KEY    = apiKey;
            SCRIPT_URL = scriptUrl;

            closeSettings();
            alert('‚úÖ Settings saved!\n\nReloading data...');
            loadAllData();
        }

        // ==================== VESSEL AVAILABILITY TRACKER ====================
        
        function refreshVesselTracker() {
            const vessels = getAllVessels();
            
            if (vessels.length === 0) {
                document.getElementById('vessel-cards-container').innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üè∫</div>
                        <h3 style="color: var(--text-secondary);">No Vessel Data Available</h3>
                        <p style="color: var(--text-secondary); margin-top: 10px;">Please configure vessels in the Mixer Map sheet</p>
                    </div>
                `;
                return;
            }
            
            // Analyze vessel status
            const vesselStatus = analyzeVesselAvailability(vessels);
            
            // Update summary cards
            document.getElementById('vessel-available-count').textContent = vesselStatus.available.length;
            document.getElementById('vessel-production-count').textContent = vesselStatus.inProduction.length;
            
            const utilizationRate = vessels.length > 0 ? 
                ((vesselStatus.inProduction.length / vessels.length) * 100).toFixed(0) : 0;
            document.getElementById('vessel-utilization').textContent = utilizationRate + '%';
            
            // Generate visual vessel cards
            generateVesselCards(vesselStatus);
            
            // Generate timeline
            generateVesselTimeline(vesselStatus);
            
            // Generate detailed table
            generateVesselTable(vesselStatus);
            
            // Generate history
            generateVesselHistory(vesselStatus);
        }
        
        function analyzeVesselAvailability(vessels) {
            const available = [];
            const inProduction = [];
            
            vessels.forEach(vessel => {
                // Find ALL production batches ever assigned to this vessel
                const allBatchesForVessel = [];
                
                allProductionData.slice(1).forEach(row => {
                    const batch = row[2];
                    if (!batch) return;
                    const batchDetails = allBatchData[batch];
                    const vesselUsed = (batchDetails && batchDetails['Vessel Used']) ?
                        batchDetails['Vessel Used'] : row[7];
                    
                    if (vesselUsed && vesselUsed.toLowerCase().trim() === vessel.name.toLowerCase().trim()) {
                        const date = parseDate(row[0]);
                        if (date) {
                            allBatchesForVessel.push({
                                batch: batch,
                                product: row[1],
                                date: date,
                                weight: row[3],
                                actualWeight: row[4],
                                vessel: vesselUsed,
                                hasFilling: hasFillingData(batch)
                            });
                        }
                    }
                });
                
                // Sort by date (newest first)
                allBatchesForVessel.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // CORE RULE: If ANY batch assigned to this vessel has NOT yet appeared
                // in the filling sheet ‚Üí vessel is UNAVAILABLE (still contains product)
                const unfilledBatch = allBatchesForVessel.find(b => !b.hasFilling);
                
                let status = 'available';
                let currentBatch = null;
                let expectedEnd = null;
                let startTime = null;
                let duration = 0;
                
                if (unfilledBatch) {
                    // Vessel is occupied ‚Äî batch is still in it, not yet filled
                    status = 'in-production';
                    currentBatch = unfilledBatch;
                    startTime = new Date(unfilledBatch.date);
                    
                    const weight = parseWeight(unfilledBatch.weight);
                    duration = Math.max(2, Math.ceil(weight / 500));
                    
                    expectedEnd = new Date(startTime);
                    expectedEnd.setHours(expectedEnd.getHours() + duration);
                }
                // else: all batches for this vessel have filling data ‚Üí vessel is empty & available
                
                const vesselInfo = {
                    ...vessel,
                    status: status,
                    currentBatch: currentBatch,
                    startTime: startTime,
                    expectedEnd: expectedEnd,
                    duration: duration,
                    todayUsageCount: allBatchesForVessel.filter(b => {
                        const today = new Date(); today.setHours(0,0,0,0);
                        const bd = new Date(b.date); bd.setHours(0,0,0,0);
                        return bd.getTime() === today.getTime();
                    }).length,
                    totalUsageCount: allBatchesForVessel.length,
                    recentBatches: allBatchesForVessel.slice(0, 5)
                };
                
                if (status === 'available') {
                    available.push(vesselInfo);
                } else {
                    inProduction.push(vesselInfo);
                }
            });
            
            return {
                available: available,
                inProduction: inProduction,
                all: [...available, ...inProduction]
            };
        }
        
        function hasFillingData(batchNumber) {
            return allFillingData.slice(1).some(row => {
                return row[2] && row[2].toString().trim() === batchNumber.toString().trim();
            });
        }
        
        function generateVesselCards(vesselStatus) {
            const container = document.getElementById('vessel-cards-container');
            
            const allVessels = [...vesselStatus.inProduction, ...vesselStatus.available];
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                    ${allVessels.map(vessel => {
                        const isAvailable = vessel.status === 'available';
                        const statusColor = isAvailable ? '#00ff88' : '#ffc107';
                        const statusBg = isAvailable ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 193, 7, 0.1)';
                        const statusIcon = isAvailable ? '‚úÖ' : '‚ö†Ô∏è';
                        const statusText = isAvailable ? 'AVAILABLE' : 'IN PRODUCTION';
                        
                        return `
                            <div class="card" style="position: relative; overflow: hidden; border-left: 5px solid ${statusColor};">
                                <!-- Status Badge -->
                                <div style="position: absolute; top: 15px; right: 15px; background: ${statusColor}; color: #0d1117; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold;">
                                    ${statusIcon} ${statusText}
                                </div>
                                
                                <!-- Vessel Info -->
                                <div style="margin-bottom: 20px;">
                                    <h2 style="font-size: 32px; margin-bottom: 5px; color: var(--text-primary);">${vessel.name}</h2>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${statusBg}; border: 3px solid ${statusColor};"></div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">Color</div>
                                            <div style="font-size: 14px; font-weight: bold; color: var(--text-primary);">${vessel.color}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${!isAvailable ? `
                                    <!-- Current Batch Info -->
                                    <div style="background: ${statusBg}; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">CURRENT BATCH</div>
                                        <div style="font-weight: bold; font-size: 18px; margin-bottom: 5px; color: ${statusColor};">#${vessel.currentBatch.batch}</div>
                                        <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">${vessel.currentBatch.product}</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary);">Started</div>
                                                <div style="font-size: 13px; font-weight: bold;">${vessel.startTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary);">Est. End</div>
                                                <div style="font-size: 13px; font-weight: bold;">${vessel.expectedEnd.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <!-- Available Message -->
                                    <div style="background: ${statusBg}; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">üéâ</div>
                                        <div style="font-weight: bold; color: ${statusColor};">Ready for Next Batch</div>
                                    </div>
                                `}
                                
                                <!-- Stats -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Today's Usage</div>
                                        <div style="font-size: 20px; font-weight: bold; color: var(--accent-blue);">${vessel.todayUsageCount}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Total Batches</div>
                                        <div style="font-size: 20px; font-weight: bold; color: var(--accent-green);">${vessel.totalUsageCount}</div>
                                    </div>
                                </div>
                                
                                <!-- Compatibility -->
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">COMPATIBLE EQUIPMENT</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        ${vessel.mixers.length > 0 ? vessel.mixers.map(m => 
                                            `<span style="background: rgba(0,255,136,0.2); color: var(--accent-green); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">${m}</span>`
                                        ).join('') : '<span style="color: var(--text-secondary); font-size: 11px;">Any mixer</span>'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function generateVesselTimeline(vesselStatus) {
            const container = document.getElementById('vessel-timeline');
            const inProd = vesselStatus.inProduction;
            
            if (inProd.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 50px; margin-bottom: 15px;">üè∫</div>
                        <p>No vessels currently in production</p>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            const startOfDay = new Date(now);
            startOfDay.setHours(6, 0, 0, 0);
            const endOfDay = new Date(now);
            endOfDay.setHours(18, 0, 0, 0);
            
            container.innerHTML = `
                <div style="position: relative; padding: 20px 0;">
                    <!-- Time markers -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text-secondary); font-size: 12px;">
                        ${Array.from({length: 13}, (_, i) => i + 6).map(hour => 
                            `<div>${hour}:00</div>`
                        ).join('')}
                    </div>
                    
                    <!-- Timeline bars -->
                    ${inProd.map(vessel => {
                        const startPercent = ((vessel.startTime - startOfDay) / (endOfDay - startOfDay)) * 100;
                        const endPercent = ((vessel.expectedEnd - startOfDay) / (endOfDay - startOfDay)) * 100;
                        const width = endPercent - startPercent;
                        
                        return `
                            <div style="position: relative; height: 60px; margin-bottom: 15px; background: var(--bg-secondary); border-radius: 8px; overflow: hidden;">
                                <!-- Vessel label -->
                                <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-weight: bold; z-index: 2;">
                                    ${vessel.name}
                                </div>
                                
                                <!-- Progress bar -->
                                <div style="position: absolute; left: ${startPercent}%; width: ${width}%; height: 100%; background: linear-gradient(90deg, #ffc107, #ff9500); opacity: 0.3;"></div>
                                
                                <!-- Batch info -->
                                <div style="position: absolute; left: ${startPercent + 2}%; top: 50%; transform: translateY(-50%); font-size: 12px; z-index: 2;">
                                    <span style="background: #ffc107; color: #0d1117; padding: 3px 8px; border-radius: 4px; font-weight: bold;">
                                        #${vessel.currentBatch.batch}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function generateVesselTable(vesselStatus) {
            const tbody = document.getElementById('vessel-status-tbody');
            const all = vesselStatus.all;
            
            if (all.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No vessel data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = all.map(vessel => {
                const isAvailable = vessel.status === 'available';
                const statusBadge = isAvailable ? 
                    '<span class="badge success">‚úÖ Available</span>' : 
                    '<span class="badge warning">‚ö†Ô∏è In Production</span>';
                
                return `
                    <tr>
                        <td><strong>${vessel.name}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${vessel.currentBatch ? '#' + vessel.currentBatch.batch : '-'}</td>
                        <td>${vessel.currentBatch ? vessel.currentBatch.product : '-'}</td>
                        <td>${vessel.startTime ? vessel.startTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
                        <td>${vessel.expectedEnd ? vessel.expectedEnd.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
                        <td>${vessel.duration ? vessel.duration + ' hrs' : '-'}</td>
                        <td>${vessel.color}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function generateVesselHistory(vesselStatus) {
            const container = document.getElementById('vessel-history');
            
            // Collect all recent activity
            const allActivity = [];
            
            vesselStatus.all.forEach(vessel => {
                vessel.recentBatches.forEach(batch => {
                    allActivity.push({
                        vessel: vessel.name,
                        batch: batch.batch,
                        product: batch.product,
                        date: new Date(batch.date),
                        weight: batch.weight,
                        hasFilling: batch.hasFilling,
                        color: vessel.color
                    });
                });
            });
            
            // Sort by date (newest first)
            allActivity.sort((a, b) => b.date - a.date);
            
            // Take top 10
            const recent = allActivity.slice(0, 10);
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No recent activity</p>';
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    ${recent.map(activity => `
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${activity.hasFilling ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                            <div style="flex: 0 0 80px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--accent-blue);">${activity.vessel}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${activity.color}</div>
                            </div>
                            <div style="flex: 1; padding: 0 20px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">Batch #${activity.batch}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${activity.product}</div>
                            </div>
                            <div style="flex: 0 0 120px; text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">
                                    ${activity.date.toLocaleDateString()}
                                </div>
                                <div>
                                    ${activity.hasFilling ? 
                                        '<span class="badge success">‚úÖ Completed</span>' : 
                                        '<span class="badge warning">‚è≥ In Progress</span>'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // ==================== VESSEL MANAGEMENT FUNCTIONS ====================
        
        function getVesselByName(vesselName) {
            if (!allVesselData || allVesselData.length < 2) return null;
            
            // Find vessel in data (skip header row)
            const vessel = allVesselData.slice(1).find(row => 
                row[0] && row[0].toString().trim().toLowerCase() === vesselName.toLowerCase()
            );
            
            if (!vessel) return null;
            
            return {
                name: vessel[0],
                color: vessel[1] || 'N/A',
                mixers: vessel[2] ? vessel[2].toString().split(',').map(m => m.trim()) : [],
                grinders: vessel[3] ? vessel[3].toString().split(',').map(g => g.trim()) : []
            };
        }
        
        function getAllVessels() {
            if (!allVesselData || allVesselData.length < 2) return [];
            
            return allVesselData.slice(1)
                .filter(row => row[0])
                .map(row => ({
                    name: row[0],
                    color: row[1] || 'N/A',
                    mixers: row[2] ? row[2].toString().split(',').map(m => m.trim()) : [],
                    grinders: row[3] ? row[3].toString().split(',').map(g => g.trim()) : []
                }));
        }
        
        function generateVesselOptions(suggestedVessel, selectedVessel) {
            const vessels = getAllVessels();
            
            if (vessels.length === 0) {
                return '<option value="">No vessels configured</option>';
            }

            // Build availability map for all vessels
            const availabilityMap = {};
            vessels.forEach(vessel => {
                // Find any unfilled batch for this vessel
                const unfilledBatch = allProductionData.slice(1).find(row => {
                    const batch = row[2];
                    if (!batch) return false;
                    const batchDetails = allBatchData[batch];
                    const vesselUsed = (batchDetails && batchDetails['Vessel Used']) ?
                        batchDetails['Vessel Used'] : row[7];
                    return vesselUsed &&
                           vesselUsed.toLowerCase().trim() === vessel.name.toLowerCase().trim() &&
                           !hasFillingData(batch);
                });
                availabilityMap[vessel.name] = unfilledBatch
                    ? { available: false, batch: unfilledBatch[2], product: unfilledBatch[1] }
                    : { available: true };
            });

            // Sort: available first, then unavailable
            const sorted = [...vessels].sort((a, b) => {
                const aAvail = availabilityMap[a.name]?.available ? 0 : 1;
                const bAvail = availabilityMap[b.name]?.available ? 0 : 1;
                return aAvail - bAvail;
            });

            return `<option value="">-- Select Vessel --</option>` +
                sorted.map(vessel => {
                    const isSelected = selectedVessel && vessel.name === selectedVessel;
                    const isSuggested = vessel.name === suggestedVessel;
                    const avail = availabilityMap[vessel.name];
                    
                    let label = vessel.name;
                    if (!avail.available) {
                        label += ` üî¥ UNAVAILABLE ‚Äî Batch #${avail.batch} (${avail.product || 'unknown'}) not filled yet`;
                    } else {
                        label += ' ‚úÖ Available';
                    }
                    if (isSuggested) label += ' ‚≠ê Suggested';

                    return `<option value="${vessel.name}" ${isSelected ? 'selected' : ''} 
                        style="color:${avail.available ? '#00ff88' : '#ff6b6b'}">
                        ${label}
                    </option>`;
                }).join('');
        }
        
        function updateEquipmentCompatibility() {
            const vesselSelect = document.getElementById('vessel-used');
            const vesselInfo = document.getElementById('vessel-info');
            const mixerSelect = document.getElementById('mixer-used');
            const grinderSelect = document.getElementById('grinder-used');
            const unavailWarning = document.getElementById('vessel-unavail-warning');
            
            if (!vesselSelect || !vesselSelect.value) {
                vesselInfo.style.display = 'none';
                if (unavailWarning) unavailWarning.style.display = 'none';
                return;
            }
            
            const vessel = getVesselByName(vesselSelect.value);
            
            if (!vessel) {
                vesselInfo.style.display = 'none';
                if (unavailWarning) unavailWarning.style.display = 'none';
                return;
            }

            // Check if vessel has any unfilled batch
            const unfilledRow = allProductionData.slice(1).find(row => {
                const batch = row[2];
                if (!batch) return false;
                const batchDetails = allBatchData[batch];
                const vesselUsed = (batchDetails && batchDetails['Vessel Used']) ?
                    batchDetails['Vessel Used'] : row[7];
                return vesselUsed &&
                       vesselUsed.toLowerCase().trim() === vessel.name.toLowerCase().trim() &&
                       !hasFillingData(batch);
            });

            if (unavailWarning) {
                if (unfilledRow) {
                    unavailWarning.style.display = 'block';
                    document.getElementById('vessel-unavail-batch').textContent =
                        `Batch #${unfilledRow[2]} (${unfilledRow[1] || 'unknown product'})`;
                } else {
                    unavailWarning.style.display = 'none';
                }
            }
            
            // Show vessel info
            vesselInfo.style.display = 'block';
            document.getElementById('vessel-color').textContent = vessel.color;
            document.getElementById('vessel-mixers').textContent = vessel.mixers.length > 0 ? vessel.mixers.join(', ') : 'Any mixer';
            document.getElementById('vessel-grinders').textContent = vessel.grinders.length > 0 ? vessel.grinders.join(', ') : 'Any grinder';
            
            // Populate mixer dropdown
            const currentMixer = mixerSelect.value;
            mixerSelect.innerHTML = '<option value="">-- Select Mixer --</option>';
            
            if (vessel.mixers.length > 0) {
                // Add compatible mixers first
                vessel.mixers.forEach(mixer => {
                    const option = document.createElement('option');
                    option.value = mixer;
                    option.textContent = `${mixer} ‚úì Compatible`;
                    option.style.color = '#00ff88';
                    mixerSelect.appendChild(option);
                });
                
                // Add separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                mixerSelect.appendChild(separator);
                
                // Add other mixers (from all equipment used historically)
                const allMixers = extractAllEquipment('mixer');
                allMixers.forEach(mixer => {
                    if (!vessel.mixers.includes(mixer)) {
                        const option = document.createElement('option');
                        option.value = mixer;
                        option.textContent = `${mixer} ‚ö†Ô∏è May not be compatible`;
                        option.style.color = '#ffc107';
                        mixerSelect.appendChild(option);
                    }
                });
            } else {
                // No restrictions - add all mixers
                const allMixers = extractAllEquipment('mixer');
                allMixers.forEach(mixer => {
                    const option = document.createElement('option');
                    option.value = mixer;
                    option.textContent = mixer;
                    mixerSelect.appendChild(option);
                });
            }
            
            // Restore selection if it exists
            if (currentMixer) {
                mixerSelect.value = currentMixer;
                checkMixerCompatibility();
            }
            
            // Populate grinder dropdown
            const currentGrinder = grinderSelect.value;
            grinderSelect.innerHTML = '<option value="">-- No Grinder / Select Grinder --</option>';
            
            if (vessel.grinders.length > 0) {
                // Add compatible grinders first
                vessel.grinders.forEach(grinder => {
                    const option = document.createElement('option');
                    option.value = grinder;
                    option.textContent = `${grinder} ‚úì Compatible`;
                    option.style.color = '#00ff88';
                    grinderSelect.appendChild(option);
                });
                
                // Add separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                grinderSelect.appendChild(separator);
                
                // Add other grinders
                const allGrinders = extractAllEquipment('grinder');
                allGrinders.forEach(grinder => {
                    if (!vessel.grinders.includes(grinder)) {
                        const option = document.createElement('option');
                        option.value = grinder;
                        option.textContent = `${grinder} ‚ö†Ô∏è May not be compatible`;
                        option.style.color = '#ffc107';
                        grinderSelect.appendChild(option);
                    }
                });
            } else {
                // No restrictions - add all grinders
                const allGrinders = extractAllEquipment('grinder');
                allGrinders.forEach(grinder => {
                    const option = document.createElement('option');
                    option.value = grinder;
                    option.textContent = grinder;
                    grinderSelect.appendChild(option);
                });
            }
            
            // Restore selection if it exists
            if (currentGrinder) {
                grinderSelect.value = currentGrinder;
                checkGrinderCompatibility();
            }
            
            // Add change listeners
            mixerSelect.onchange = checkMixerCompatibility;
            grinderSelect.onchange = checkGrinderCompatibility;
        }
        
        function checkMixerCompatibility() {
            const vesselSelect = document.getElementById('vessel-used');
            const mixerSelect = document.getElementById('mixer-used');
            const mixerWarning = document.getElementById('mixer-warning');
            
            if (!vesselSelect.value || !mixerSelect.value) {
                mixerWarning.style.display = 'none';
                return;
            }
            
            const vessel = getVesselByName(vesselSelect.value);
            if (!vessel || vessel.mixers.length === 0) {
                mixerWarning.style.display = 'none';
                return;
            }
            
            const isCompatible = vessel.mixers.includes(mixerSelect.value);
            mixerWarning.style.display = isCompatible ? 'none' : 'block';
        }
        
        function checkGrinderCompatibility() {
            const vesselSelect = document.getElementById('vessel-used');
            const grinderSelect = document.getElementById('grinder-used');
            const grinderWarning = document.getElementById('grinder-warning');
            
            if (!vesselSelect.value || !grinderSelect.value) {
                grinderWarning.style.display = 'none';
                return;
            }
            
            const vessel = getVesselByName(vesselSelect.value);
            if (!vessel || vessel.grinders.length === 0) {
                grinderWarning.style.display = 'none';
                return;
            }
            
            const isCompatible = vessel.grinders.includes(grinderSelect.value);
            grinderWarning.style.display = isCompatible ? 'none' : 'block';
        }
        
        function extractAllEquipment(type) {
            const equipment = new Set();
            const pattern = type === 'mixer' ? /MX\d+/g : /GR\d+/g;
            
            allProductionData.slice(1).forEach(row => {
                if (row[10]) {
                    const matches = row[10].toString().match(pattern);
                    if (matches) {
                        matches.forEach(eq => equipment.add(eq));
                    }
                }
            });
            
            return Array.from(equipment).sort();
        }
        
        // ==================== LIVE MONITOR FUNCTIONS ====================
        
        let liveMonitorInterval = null;
        
        function startLiveMonitor() {
            refreshLiveData();
            // Auto-refresh every 30 seconds
            if (liveMonitorInterval) clearInterval(liveMonitorInterval);
            liveMonitorInterval = setInterval(refreshLiveData, 30000);
        }
        
        function stopLiveMonitor() {
            if (liveMonitorInterval) {
                clearInterval(liveMonitorInterval);
                liveMonitorInterval = null;
            }
        }
        
        async function refreshLiveData() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let todayProduction = 0;
            let todayBatches = 0;
            let todayIssues = 0;
            let totalYield = 0;
            let yieldCount = 0;
            const recentBatches = [];
            const equipmentUsage = { mixers: {}, grinders: {} };
            const alerts = [];
            
            // Calculate today's stats
            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;
                
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                
                if (rowDate.getTime() === today.getTime()) {
                    const weight = parseWeight(row[3]);
                    todayProduction += weight;
                    todayBatches++;
                    
                    // Yield tracking
                    const yieldPercent = parseFloat(row[5]);
                    if (!isNaN(yieldPercent)) {
                        totalYield += yieldPercent;
                        yieldCount++;
                    }
                    
                    // Check for problems
                    const batch = row[2];
                    const batchDetails = allBatchData[batch];
                    if (batchDetails && batchDetails['Problems']) {
                        try {
                            const problems = JSON.parse(batchDetails['Problems']);
                            if (problems && problems.length > 0) {
                                todayIssues += problems.length;
                            }
                        } catch (e) {}
                    }
                    
                    // Collect recent batches
                    recentBatches.push({
                        batch: row[2],
                        product: row[1],
                        yield: row[5],
                        yieldVerdict: row[6],
                        hasProblems: batchDetails && batchDetails['Problems'] && batchDetails['Problems'] !== '[]',
                        time: date
                    });
                    
                    // Equipment tracking
                    const equipmentCell = (row[10] || '').toString().toUpperCase();
                    const mixers = equipmentCell.match(/MX\d+/g) || [];
                    const grinders = equipmentCell.match(/GR\d+/g) || [];
                    
                    mixers.forEach(mx => {
                        equipmentUsage.mixers[mx] = (equipmentUsage.mixers[mx] || 0) + 1;
                    });
                    grinders.forEach(gr => {
                        equipmentUsage.grinders[gr] = (equipmentUsage.grinders[gr] || 0) + 1;
                    });
                }
            });
            
            // Sort recent batches by time (newest first)
            recentBatches.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            // Update KPIs
            const targetWeight = 30000;
            const progressPercent = ((todayProduction / targetWeight) * 100).toFixed(1);
            
            document.getElementById('live-today-production').textContent = formatNumber(todayProduction) + ' KG';
            document.getElementById('live-today-progress').textContent = `${progressPercent}% of ${formatNumber(targetWeight)} KG target`;
            
            document.getElementById('live-batches-count').textContent = todayBatches;
            document.getElementById('live-batches-target').textContent = `Target: 15 batches`;
            
            document.getElementById('live-issues-count').textContent = todayIssues;
            
            const avgYield = yieldCount > 0 ? (totalYield / yieldCount).toFixed(1) : '0';
            document.getElementById('live-avg-yield').textContent = avgYield + '%';
            
            // Generate alerts
            if (progressPercent < 50 && new Date().getHours() > 14) {
                alerts.push({
                    level: 'warning',
                    message: `‚ö†Ô∏è Production behind schedule: Only ${progressPercent}% of target reached`
                });
            }
            if (todayIssues > 5) {
                alerts.push({
                    level: 'error',
                    message: `üö® High problem count today: ${todayIssues} issues reported`
                });
            }
            if (avgYield < 95 && yieldCount > 0) {
                alerts.push({
                    level: 'warning',
                    message: `‚ö†Ô∏è Below-target yield: Average ${avgYield}% (target: 95%+)`
                });
            }
            
            // Update alerts panel
            const alertsPanel = document.getElementById('live-alerts-panel');
            const alertsList = document.getElementById('live-alerts-list');
            if (alerts.length > 0) {
                alertsPanel.style.display = 'block';
                alertsList.innerHTML = alerts.map(alert => 
                    `<div style="padding: 10px; margin-bottom: 10px; background: ${alert.level === 'error' ? 'rgba(255,107,107,0.2)' : 'rgba(255,193,7,0.2)'}; border-radius: 4px; border-left: 4px solid ${alert.level === 'error' ? 'var(--accent-red)' : 'var(--accent-yellow)'};">${alert.message}</div>`
                ).join('');
            } else {
                alertsPanel.style.display = 'none';
            }
            
            // Update recent batches table
            const tbody = document.getElementById('live-batches-tbody');
            if (recentBatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No batches today yet</td></tr>';
            } else {
                tbody.innerHTML = recentBatches.slice(0, 5).map(batch => {
                    const problemBadge = batch.hasProblems ? '<span class="badge error">‚ö†Ô∏è Issues</span>' : '<span class="badge success">‚úì Clean</span>';
                    const yieldBadge = batch.yieldVerdict === 'EXCELLENT' ? 'success' : batch.yieldVerdict === 'GOOD' ? 'warning' : 'error';
                    
                    return `
                        <tr>
                            <td><strong>${batch.batch}</strong></td>
                            <td>${batch.product}</td>
                            <td><span class="badge success">Completed</span></td>
                            <td><span class="badge ${yieldBadge}">${batch.yield}%</span></td>
                            <td>${problemBadge}</td>
                            <td>${new Date(batch.time).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Update equipment status
            const mixersHtml = Object.keys(equipmentUsage.mixers).length > 0 ?
                Object.entries(equipmentUsage.mixers)
                    .sort((a, b) => b[1] - a[1])
                    .map(([mx, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 4px; border-left: 4px solid var(--accent-green);">
                            <strong>${mx}</strong>
                            <span>${count} batches today</span>
                        </div>
                    `).join('') :
                '<p style="color: var(--text-secondary);">No mixer usage today</p>';
            document.getElementById('live-mixers-status').innerHTML = mixersHtml;
            
            const grindersHtml = Object.keys(equipmentUsage.grinders).length > 0 ?
                Object.entries(equipmentUsage.grinders)
                    .sort((a, b) => b[1] - a[1])
                    .map(([gr, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 4px; border-left: 4px solid var(--accent-blue);">
                            <strong>${gr}</strong>
                            <span>${count} batches today</span>
                        </div>
                    `).join('') :
                '<p style="color: var(--text-secondary);">No grinder usage today</p>';
            document.getElementById('live-grinders-status').innerHTML = grindersHtml;
            
            // Update last refresh time
            document.getElementById('live-last-update').textContent = new Date().toLocaleTimeString();
            
            // Generate hourly production chart
            generateHourlyChart(today);
        }
        
        function generateHourlyChart(today) {
            const hourlyData = new Array(24).fill(0);
            
            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;
                
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                
                if (rowDate.getTime() === today.getTime()) {
                    // Try to extract hour from date if available
                    const hour = new Date(date).getHours();
                    if (!isNaN(hour)) {
                        const weight = parseWeight(row[3]);
                        hourlyData[hour] += weight;
                    }
                }
            });
            
            const ctx = document.getElementById('hourly-production-chart');
            if (!ctx) return;
            
            if (chartInstances['hourly-production']) {
                chartInstances['hourly-production'].destroy();
            }
            
            chartInstances['hourly-production'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Production (KG)',
                        data: hourlyData,
                        backgroundColor: 'rgba(0, 180, 255, 0.8)',
                        borderColor: 'rgba(0, 180, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...getChartOptions(),
                    scales: {
                        y: {
                            ...getChartOptions().scales.y,
                            title: {
                                display: true,
                                text: 'Production (KG)',
                                color: '#aab4be'
                            }
                        },
                        x: {
                            ...getChartOptions().scales.x,
                            title: {
                                display: true,
                                text: 'Hour of Day',
                                color: '#aab4be'
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== QUALITY CONTROL FUNCTIONS ====================
        
        function loadQualityData() {
            const period = document.getElementById('quality-period').value;
            const customDates = document.getElementById('quality-custom-dates');
            
            if (period === 'custom') {
                customDates.style.display = 'block';
                return;
            } else {
                customDates.style.display = 'none';
            }
            
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - parseInt(period));
            startDate.setHours(0, 0, 0, 0);
            
            analyzeQualityData(startDate, endDate);
        }
        
        function analyzeQualityData(startDate, endDate) {
            let totalBatches = 0;
            let batchesWithProblems = 0;
            let totalYield = 0;
            let yieldCount = 0;
            const problemTypes = {};
            const problemsByDate = {};
            const problemDetails = [];
            const productProblems = {};
            const yieldDistribution = { excellent: 0, good: 0, acceptable: 0, poor: 0 };
            const categoryQuality = {};
            const dailyQuality = {};
            
            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;
                
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                
                if (rowDate >= startDate && rowDate <= endDate) {
                    totalBatches++;
                    
                    const batch = row[2];
                    const product = row[1];
                    const category = detectCategory(product);
                    const yieldPercent = parseFloat(row[5]);
                    const yieldVerdict = row[6];
                    const dateKey = rowDate.toISOString().split('T')[0];
                    
                    // Yield tracking
                    if (!isNaN(yieldPercent)) {
                        totalYield += yieldPercent;
                        yieldCount++;
                        
                        // Yield distribution
                        if (yieldVerdict === 'EXCELLENT') yieldDistribution.excellent++;
                        else if (yieldVerdict === 'GOOD') yieldDistribution.good++;
                        else if (yieldVerdict === 'ACCEPTABLE') yieldDistribution.acceptable++;
                        else yieldDistribution.poor++;
                    }
                    
                    // Category quality
                    if (!categoryQuality[category]) {
                        categoryQuality[category] = { yield: 0, count: 0, problems: 0 };
                    }
                    categoryQuality[category].yield += yieldPercent || 0;
                    categoryQuality[category].count++;
                    
                    // Daily quality score
                    if (!dailyQuality[dateKey]) {
                        dailyQuality[dateKey] = { yield: 0, count: 0, problems: 0 };
                    }
                    dailyQuality[dateKey].yield += yieldPercent || 0;
                    dailyQuality[dateKey].count++;
                    
                    // Problem analysis
                    const batchDetails = allBatchData[batch];
                    if (batchDetails && batchDetails['Problems']) {
                        try {
                            const problems = JSON.parse(batchDetails['Problems']);
                            if (problems && problems.length > 0) {
                                batchesWithProblems++;
                                
                                problems.forEach(problem => {
                                    // Count by type
                                    problemTypes[problem.type] = (problemTypes[problem.type] || 0) + 1;
                                    
                                    // Count by date
                                    problemsByDate[dateKey] = (problemsByDate[dateKey] || 0) + 1;
                                    
                                    // Count by product
                                    productProblems[product] = (productProblems[product] || 0) + 1;
                                    
                                    // Category problems
                                    categoryQuality[category].problems++;
                                    
                                    // Daily problems
                                    dailyQuality[dateKey].problems++;
                                    
                                    // Store details
                                    problemDetails.push({
                                        date: date,
                                        batch: batch,
                                        product: product,
                                        type: problem.type,
                                        details: getProblemSummary(problem),
                                        downtime: batchDetails['Downtime (min)'] || 'N/A'
                                    });
                                });
                            }
                        } catch (e) {}
                    }
                }
            });
            
            // Calculate quality scores
            const avgYield = yieldCount > 0 ? (totalYield / yieldCount).toFixed(1) : 0;
            const cleanBatchPercent = totalBatches > 0 ? ((totalBatches - batchesWithProblems) / totalBatches * 100).toFixed(1) : 0;
            const qualityScore = (parseFloat(avgYield) * 0.6 + parseFloat(cleanBatchPercent) * 0.4).toFixed(1);
            
            // Update KPIs
            document.getElementById('quality-overall-score').textContent = qualityScore;
            document.getElementById('quality-score-change').innerHTML = `<span class="badge ${qualityScore >= 85 ? 'success' : qualityScore >= 70 ? 'warning' : 'error'}">${qualityScore >= 85 ? 'Excellent' : qualityScore >= 70 ? 'Good' : 'Needs Improvement'}</span>`;
            
            document.getElementById('quality-clean-batches').textContent = totalBatches - batchesWithProblems;
            document.getElementById('quality-clean-percent').textContent = `${cleanBatchPercent}% of ${totalBatches} batches`;
            
            document.getElementById('quality-avg-yield').textContent = avgYield + '%';
            document.getElementById('quality-yield-trend').innerHTML = avgYield >= 95 ? '<span class="badge success">On Target</span>' : '<span class="badge warning">Below Target</span>';
            
            // Generate charts
            generateProblemFrequencyChart(problemTypes);
            generateProblemTrendChart(problemsByDate, startDate, endDate);
            generateYieldDistributionChart(yieldDistribution);
            generateCategoryQualityChart(categoryQuality);
            generateSPCChart(dailyQuality);
            
            // Update problem details table
            updateProblemDetailsTable(problemDetails);
            
            // Update problem products list
            updateProblemProductsList(productProblems);
            
            // Generate root cause analysis
            generateRootCauseAnalysis(problemTypes, productProblems, categoryQuality);
        }
        
        function getProblemSummary(problem) {
            switch(problem.type) {
                case 'Viscosity':
                    return `${problem.initialViscosity} ‚Üí ${problem.finalViscosity} KU`;
                case 'Color':
                    return `Expected: ${problem.expectedColor}`;
                case 'Drying Time':
                    return `${problem.expectedDrying}h ‚Üí ${problem.actualDrying}h`;
                case 'Too much Grinding':
                    return `Target: ${problem.targetFineness}Œºm`;
                case 'Dispersing Problem':
                    return 'Dispersing issue';
                case 'Complete batch damaged':
                    return `Status: ${problem.batchStatus}`;
                default:
                    return 'See details';
            }
        }
        
        function generateProblemFrequencyChart(problemTypes) {
            const ctx = document.getElementById('problem-frequency-chart');
            if (!ctx) return;
            
            if (chartInstances['problem-frequency']) {
                chartInstances['problem-frequency'].destroy();
            }
            
            const sortedProblems = Object.entries(problemTypes).sort((a, b) => b[1] - a[1]);
            
            chartInstances['problem-frequency'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProblems.map(p => p[0]),
                    datasets: [{
                        label: 'Occurrences',
                        data: sortedProblems.map(p => p[1]),
                        backgroundColor: ['#ff6b6b', '#ffc107', '#00b4ff', '#00ff88', '#9c27b0', '#ff9500'],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ...getChartOptions().scales.y,
                            title: {
                                display: true,
                                text: 'Number of Occurrences',
                                color: '#aab4be'
                            }
                        }
                    }
                }
            });
        }
        
        function generateProblemTrendChart(problemsByDate, startDate, endDate) {
            const ctx = document.getElementById('problem-trend-chart');
            if (!ctx) return;
            
            if (chartInstances['problem-trend']) {
                chartInstances['problem-trend'].destroy();
            }
            
            const dates = [];
            const counts = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = d.toISOString().split('T')[0];
                dates.push(dateKey);
                counts.push(problemsByDate[dateKey] || 0);
            }
            
            chartInstances['problem-trend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Problems per Day',
                        data: counts,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: getChartOptions()
            });
        }
        
        function generateYieldDistributionChart(dist) {
            const ctx = document.getElementById('yield-distribution-chart');
            if (!ctx) return;
            
            if (chartInstances['yield-dist']) {
                chartInstances['yield-dist'].destroy();
            }
            
            chartInstances['yield-dist'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Excellent (>102%)', 'Good (98-102%)', 'Acceptable (95-98%)', 'Poor (<95%)'],
                    datasets: [{
                        data: [dist.excellent, dist.good, dist.acceptable, dist.poor],
                        backgroundColor: ['#00ff88', '#00b4ff', '#ffc107', '#ff6b6b']
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        ...getChartOptions().plugins,
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function generateCategoryQualityChart(categoryQuality) {
            const ctx = document.getElementById('category-quality-chart');
            if (!ctx) return;
            
            if (chartInstances['category-quality']) {
                chartInstances['category-quality'].destroy();
            }
            
            const categories = Object.keys(categoryQuality);
            const scores = categories.map(cat => {
                const avgYield = categoryQuality[cat].yield / categoryQuality[cat].count;
                const problemRate = categoryQuality[cat].problems / categoryQuality[cat].count;
                return (avgYield * 0.7 + (1 - problemRate) * 100 * 0.3).toFixed(1);
            });
            
            chartInstances['category-quality'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Quality Score',
                        data: scores,
                        backgroundColor: '#00b4ff',
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    scales: {
                        y: {
                            ...getChartOptions().scales.y,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Quality Score (0-100)',
                                color: '#aab4be'
                            }
                        }
                    }
                }
            });
        }
        
        function generateSPCChart(dailyQuality) {
            const ctx = document.getElementById('spc-chart');
            if (!ctx) return;
            
            if (chartInstances['spc']) {
                chartInstances['spc'].destroy();
            }
            
            const dates = Object.keys(dailyQuality).sort();
            const scores = dates.map(date => {
                const dq = dailyQuality[date];
                const avgYield = dq.yield / dq.count;
                const problemRate = dq.problems / dq.count;
                return (avgYield * 0.6 + (1 - problemRate) * 100 * 0.4).toFixed(1);
            });
            
            // Calculate control limits
            const mean = scores.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / scores.length;
            const stdDev = Math.sqrt(scores.reduce((sq, n) => sq + Math.pow(parseFloat(n) - mean, 2), 0) / scores.length);
            const ucl = mean + 2 * stdDev; // Upper control limit
            const lcl = Math.max(0, mean - 2 * stdDev); // Lower control limit
            
            chartInstances['spc'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Quality Score',
                            data: scores,
                            borderColor: '#00b4ff',
                            backgroundColor: 'rgba(0, 180, 255, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4
                        },
                        {
                            label: 'Mean',
                            data: new Array(dates.length).fill(mean),
                            borderColor: '#00ff88',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper Control Limit',
                            data: new Array(dates.length).fill(ucl),
                            borderColor: '#ffc107',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Control Limit',
                            data: new Array(dates.length).fill(lcl),
                            borderColor: '#ff6b6b',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    ...getChartOptions(),
                    scales: {
                        y: {
                            ...getChartOptions().scales.y,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Quality Score',
                                color: '#aab4be'
                            }
                        }
                    }
                }
            });
        }
        
        function updateProblemDetailsTable(problemDetails) {
            const tbody = document.getElementById('quality-problems-tbody');
            
            if (problemDetails.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No problems found in selected period</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            problemDetails.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = problemDetails.map(prob => `
                <tr>
                    <td>${new Date(prob.date).toLocaleDateString()}</td>
                    <td><strong>${prob.batch}</strong></td>
                    <td>${prob.product}</td>
                    <td><span class="badge error">${prob.type}</span></td>
                    <td>${prob.details}</td>
                    <td><span class="badge warning">Resolved</span></td>
                    <td>${prob.downtime} min</td>
                </tr>
            `).join('');
        }
        
        function updateProblemProductsList(productProblems) {
            const container = document.getElementById('quality-problem-products');
            
            if (Object.keys(productProblems).length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No problem patterns identified</p>';
                return;
            }
            
            const sorted = Object.entries(productProblems).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            container.innerHTML = `
                <div class="data-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Product</th>
                                <th>Problem Count</th>
                                <th>Risk Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(([ product, count], idx) => {
                                const riskLevel = count >= 5 ? 'HIGH' : count >= 3 ? 'MEDIUM' : 'LOW';
                                const riskBadge = count >= 5 ? 'error' : count >= 3 ? 'warning' : 'success';
                                return `
                                    <tr>
                                        <td><strong>${idx + 1}</strong></td>
                                        <td>${product}</td>
                                        <td><strong>${count}</strong></td>
                                        <td><span class="badge ${riskBadge}">${riskLevel}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateRootCauseAnalysis(problemTypes, productProblems, categoryQuality) {
            const container = document.getElementById('quality-root-cause');
            
            const insights = [];
            
            // Most common problem
            const topProblem = Object.entries(problemTypes).sort((a, b) => b[1] - a[1])[0];
            if (topProblem) {
                insights.push(`<strong>Most Frequent Issue:</strong> ${topProblem[0]} (${topProblem[1]} occurrences)`);
            }
            
            // Products with most issues
            const topProblemProduct = Object.entries(productProblems).sort((a, b) => b[1] - a[1])[0];
            if (topProblemProduct && topProblemProduct[1] >= 3) {
                insights.push(`<strong>High-Risk Product:</strong> ${topProblemProduct[0]} has recurring quality issues (${topProblemProduct[1]} problems)`);
            }
            
            // Category analysis
            const categoryIssues = Object.entries(categoryQuality)
                .map(([cat, data]) => ({
                    category: cat,
                    problemRate: (data.problems / data.count * 100).toFixed(1)
                }))
                .sort((a, b) => parseFloat(b.problemRate) - parseFloat(a.problemRate))[0];
            
            if (categoryIssues && parseFloat(categoryIssues.problemRate) > 20) {
                insights.push(`<strong>Category Alert:</strong> ${categoryIssues.category} has ${categoryIssues.problemRate}% problem rate`);
            }
            
            // Recommendations
            if (problemTypes['Viscosity'] >= 5) {
                insights.push(`<strong>Recommendation:</strong> High viscosity issues detected. Consider reviewing solvent ratios and mixer settings.`);
            }
            if (problemTypes['Color'] >= 3) {
                insights.push(`<strong>Recommendation:</strong> Color problems detected. Review pigment batches and color matching procedures.`);
            }
            if (problemTypes['Too much Grinding'] >= 3) {
                insights.push(`<strong>Recommendation:</strong> Over-grinding issues detected. Review grinder settings and operator training.`);
            }
            
            if (insights.length === 0) {
                insights.push('<strong>Status:</strong> No significant quality patterns detected. Continue monitoring.');
            }
            
            container.innerHTML = insights.map(insight => 
                `<div style="padding: 12px; margin-bottom: 10px; background: var(--bg-secondary); border-radius: 4px; border-left: 4px solid var(--accent-blue);">${insight}</div>`
            ).join('');
        }
        
        // PAGE 1: Daily View
        function updateDailyView() {
            const dateStr = currentViewDate.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('current-date-display').textContent = dateStr;

            const targetDate = new Date(currentViewDate);
            targetDate.setHours(0, 0, 0, 0);

            // Production Schedule Table
            const productionRows = allProductionData.slice(1).filter(row => {
                if (!row[0]) return false;
                const date = parseDate(row[0]);
                if (!date) return false;
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                return rowDate.getTime() === targetDate.getTime();
            });

            let todayWeight = 0;
            const tbody = document.getElementById('production-tbody');
            if (productionRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">No production data for this date</td></tr>';
            } else {
                tbody.innerHTML = productionRows.map(row => {
                    todayWeight += parseWeight(row[3]);
                    const batch = row[2] || '-';
                    const batchCell = batch !== '-' 
                        ? `<span class="batch-link" onclick="showBatchDetails('${batch}')">${batch}</span>`
                        : '-';
                    
                    // Normalize batch number for lookup (trim whitespace)
                    const normalizedBatch = batch !== '-' ? batch.toString().trim() : '-';
                    
                    // DEBUG: Extensive logging
                    if (normalizedBatch !== '-') {
                        console.log('üîç Looking for batch:', `"${normalizedBatch}"`, 'Length:', normalizedBatch.length);
                        console.log('üì¶ Available keys:', Object.keys(allBatchData));
                        console.log('üéØ Match exists?', allBatchData.hasOwnProperty(normalizedBatch));
                        if (allBatchData[normalizedBatch]) {
                            console.log('‚úÖ Found! Vessel:', allBatchData[normalizedBatch]['Vessel Used']);
                        }
                    }
                    
                    const batchDetails = allBatchData[normalizedBatch];
                    const vesselFromSheet = row[7] || '-';
                    const vesselFromBatch = (batchDetails && batchDetails['Vessel Used']) ? batchDetails['Vessel Used'] : null;
                    const vesselToShow = vesselFromBatch || vesselFromSheet;
                    
                    if (vesselFromBatch) {
                        console.log('üè∫ Batch', normalizedBatch, '- Using manual vessel:', vesselFromBatch, '(Sheet had:', vesselFromSheet + ')');
                    }
                    
                    return `
                        <tr>
                            <td>${formatDate(row[0])}</td>
                            <td>${row[1] || '-'}</td>
                            <td>${batchCell}</td>
                            <td>${row[3] || '-'}</td>
                            <td>${row[4] || '-'}</td>
                            <td>${row[5] || '-'}</td>
                            <td>${row[6] || '-'}</td>
                            <td>${vesselToShow}</td>
                            <td>${row[8] || '-'}</td>
                            <td>${row[9] || '-'}</td>
                            <td>${row[10] || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Filling Table
            const fillingRows = allFillingData.slice(1).filter(row => {
                if (!row[0]) return false;
                const date = parseDate(row[0]);
                if (!date) return false;
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                return rowDate.getTime() === targetDate.getTime();
            });

            const fillingTbody = document.getElementById('filling-tbody');
            if (fillingRows.length === 0) {
                fillingTbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">No filling data for this date</td></tr>';
            } else {
                fillingTbody.innerHTML = fillingRows.map(row => {
                    const batch = row[2] || '-';
                    const batchCell = batch !== '-' 
                        ? `<span class="batch-link" onclick="showBatchDetails('${batch}')">${batch}</span>`
                        : '-';
                    
                    return `
                        <tr>
                            <td>${formatDate(row[0])}</td>
                            <td>${row[1] || '-'}</td>
                            <td>${batchCell}</td>
                            <td>${row[3] || '-'}</td>
                            <td>${row[4] || '-'}</td>
                            <td>${row[5] || '-'}</td>
                            <td>${row[6] || '-'}</td>
                            <td>${row[7] || '-'}</td>
                            <td>${row[8] || '-'}</td>
                            <td>${formatTime(row[9])}</td>
                            <td>${formatTime(row[10])}</td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('today-production').textContent = formatNumber(todayWeight) + ' KG';
            document.getElementById('today-entries').textContent = productionRows.length + ' entries';
        }

        // Batch Detail Modal Functions
        async function showBatchDetails(batchNumber) {
            console.log('üîç Looking up batch:', batchNumber);
            
            // Find the batch in production data
            const batchRowIndex = allProductionData.slice(1).findIndex(row => {
                return row[2] && row[2].toString().trim() === batchNumber.toString().trim();
            });
            
            if (batchRowIndex === -1) {
                alert('Batch not found in Production Schedule: ' + batchNumber);
                return;
            }
            
            const batchData = allProductionData[batchRowIndex + 1];
            
            // Extract basic batch information from Production Schedule
            const date = formatDate(batchData[0]);
            const product = batchData[1] || 'N/A';
            const batch = batchData[2] || 'N/A';
            const plannedWeight = batchData[3] || 'N/A';
            const actualWeight = batchData[4] || 'N/A';
            const yieldPercent = batchData[5] || 'N/A';
            const yieldVerdict = batchData[6] || 'N/A';
            const vesselFromSheet = batchData[7] || 'N/A';
            const suggestedMixers = batchData[8] || 'N/A';
            const suggestedGrinders = batchData[9] || 'N/A';
            
            // Check if we have saved batch details
            const batchDetails = allBatchData[batchNumber];
            
            // Use manually selected vessel if it exists, otherwise use sheet vessel
            const vessel = (batchDetails && batchDetails['Vessel Used']) ? batchDetails['Vessel Used'] : vesselFromSheet;
            
            // Find filling information for this batch
            const fillingData = allFillingData.slice(1).filter(row => {
                return row[2] && row[2].toString().trim() === batchNumber.toString().trim();
            });
            
            let fillingInfo = '';
            if (fillingData.length > 0) {
                fillingInfo = `
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-green);">üì¶ Filling Operations</h3>
                    <div class="batch-info-grid">
                        ${fillingData.map(fill => `
                            <div class="batch-info-item">
                                <div class="batch-info-label">Filling Type</div>
                                <div class="batch-info-value">${fill[3] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Package Type</div>
                                <div class="batch-info-value">${fill[4] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Quantity</div>
                                <div class="batch-info-value">${fill[5] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Types of Boxes Used</div>
                                <div class="batch-info-value">${fill[6] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Quantity of Boxes</div>
                                <div class="batch-info-value">${fill[7] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Time per Package</div>
                                <div class="batch-info-value">${fill[8] || 'N/A'}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">Start Time</div>
                                <div class="batch-info-value">${formatTime(fill[9])}</div>
                            </div>
                            <div class="batch-info-item">
                                <div class="batch-info-label">End Time</div>
                                <div class="batch-info-value">${formatTime(fill[10])}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // If batch details exist, show them. Otherwise show input form
            console.log('üîç Checking if batch details exist for:', batch);
            console.log('   batchDetails?', batchDetails);
            console.log('   has keys?', batchDetails ? Object.keys(batchDetails).length : 0);
            
            if (batchDetails && Object.keys(batchDetails).length > 0) {
                console.log('‚úÖ Opening DETAILS VIEW (data exists)');
                showBatchDetailsView(batch, product, date, vessel, plannedWeight, actualWeight, yieldPercent, yieldVerdict, suggestedMixers, suggestedGrinders, batchDetails, fillingInfo);
            } else {
                console.log('üìù Opening INPUT FORM (no data yet)');
                showBatchInputForm(batch, product, date, vessel, plannedWeight, actualWeight, yieldPercent, yieldVerdict, suggestedMixers, suggestedGrinders, fillingInfo);
            }
        }

        // Show batch details if they exist
        function showBatchDetailsView(batch, product, date, vessel, plannedWeight, actualWeight, yieldPercent, yieldVerdict, suggestedMixers, suggestedGrinders, batchDetails, fillingInfo) {
            const vesselUsed = batchDetails['Vessel Used'] || vessel || 'N/A';
            const mixerUsedActual = batchDetails['Mixer Used (Actual)'] || 'N/A';
            const grinderUsedActual = batchDetails['Grinder Used (Actual)'] || 'N/A';
            const mixerGrinderOperators = batchDetails['Mixer/Grinder Operators'] || 'N/A';
            const fillingOperators = batchDetails['Filling Operators'] || 'N/A';
            const totalManpower = batchDetails['Total Manpower'] || 'N/A';
            const timeOnMixer = batchDetails['Time on Mixer (min)'] || 'N/A';
            const timeOnGrinder = batchDetails['Time on Grinder (min)'] || 'N/A';
            const downtime = batchDetails['Downtime (min)'] || 'N/A';
            const downtimeReason = batchDetails['Reason of Downtime'] || 'N/A';
            const totalProcessTime = batchDetails['TOTAL PROCESS TIME (min)'] || 'N/A';
            
            // Get vessel info
            const vesselInfo = getVesselByName(vesselUsed);
            const vesselDetailsHtml = vesselInfo ? `
                <div class="batch-info-item" style="border-left-color: var(--accent-blue);">
                    <div class="batch-info-label">Vessel Color</div>
                    <div class="batch-info-value">${vesselInfo.color}</div>
                </div>
                <div class="batch-info-item" style="border-left-color: var(--accent-green);">
                    <div class="batch-info-label">Vessel Compatible Mixers</div>
                    <div class="batch-info-value">${vesselInfo.mixers.length > 0 ? vesselInfo.mixers.join(', ') : 'Any mixer'}</div>
                </div>
                <div class="batch-info-item" style="border-left-color: var(--accent-blue);">
                    <div class="batch-info-label">Vessel Compatible Grinders</div>
                    <div class="batch-info-value">${vesselInfo.grinders.length > 0 ? vesselInfo.grinders.join(', ') : 'Any grinder'}</div>
                </div>
            ` : '';
            
            // Parse problems
            let problemsHtml = '';
            try {
                const problems = JSON.parse(batchDetails['Problems'] || '[]');
                
                if (problems.length > 0) {
                    problemsHtml = `
                        <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-red);">‚ö†Ô∏è Problems & Solutions</h3>
                        ${problems.map((problem, idx) => {
                            let detailsHtml = '';
                            
                            switch(problem.type) {
                                case 'Viscosity':
                                    detailsHtml = `
                                        <div class="batch-info-item"><div class="batch-info-label">Initial Viscosity (KU)</div><div class="batch-info-value">${problem.initialViscosity || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Final Viscosity (KU)</div><div class="batch-info-value">${problem.finalViscosity || 'N/A'}</div></div>
                                        ${problem.solvents && problem.solvents.length > 0 ? `
                                            <div class="batch-info-item" style="grid-column: span 2;">
                                                <div class="batch-info-label">Solvents Added</div>
                                                <div class="batch-info-value">
                                                    ${problem.solvents.map(s => `${s.type}: ${s.weight} KG`).join(' + ')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    `;
                                    break;
                                case 'Color':
                                    detailsHtml = `
                                        <div class="batch-info-item"><div class="batch-info-label">Expected Color</div><div class="batch-info-value">${problem.expectedColor || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Actual Color</div><div class="batch-info-value">${problem.actualColor || 'N/A'}</div></div>
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Correction Action</div><div class="batch-info-value">${problem.correctionAction || 'N/A'}</div></div>
                                    `;
                                    break;
                                case 'Drying Time':
                                    detailsHtml = `
                                        <div class="batch-info-item"><div class="batch-info-label">Expected Drying (hrs)</div><div class="batch-info-value">${problem.expectedDrying || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Actual Drying (hrs)</div><div class="batch-info-value">${problem.actualDrying || 'N/A'}</div></div>
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Solution</div><div class="batch-info-value">${problem.dryingSolution || 'N/A'}</div></div>
                                    `;
                                    break;
                                case 'Too much Grinding':
                                    detailsHtml = `
                                        <div class="batch-info-item"><div class="batch-info-label">Target Fineness (Œºm)</div><div class="batch-info-value">${problem.targetFineness || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Actual Fineness (Œºm)</div><div class="batch-info-value">${problem.actualFineness || 'N/A'}</div></div>
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Corrective Action</div><div class="batch-info-value">${problem.grindingAction || 'N/A'}</div></div>
                                    `;
                                    break;
                                case 'Dispersing Problem':
                                    detailsHtml = `
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Issue Description</div><div class="batch-info-value">${problem.dispersingIssue || 'N/A'}</div></div>
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Solution Applied</div><div class="batch-info-value">${problem.dispersingSolution || 'N/A'}</div></div>
                                    `;
                                    break;
                                case 'Complete batch damaged':
                                    detailsHtml = `
                                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Damage Cause</div><div class="batch-info-value">${problem.damageCause || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Batch Status</div><div class="batch-info-value">${problem.batchStatus || 'N/A'}</div></div>
                                        <div class="batch-info-item"><div class="batch-info-label">Loss Amount (KG)</div><div class="batch-info-value">${problem.lossAmount || 'N/A'}</div></div>
                                    `;
                                    break;
                            }
                            
                            return `
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-red); margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--accent-red);">Problem ${idx + 1}: ${problem.type}</h4>
                                    <div class="batch-info-grid">
                                        ${detailsHtml}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
            } catch (e) {
                console.warn('Could not parse problems:', e);
            }
            
            const modalContent = `
                <div style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-green)); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h2 style="margin: 0; font-size: 28px; color: var(--bg-primary);">Batch #${batch}</h2>
                    <p style="margin: 10px 0 0 0; color: var(--bg-primary); opacity: 0.9;">${product}</p>
                </div>
                
                <div style="text-align: right; margin-bottom: 15px;">
                    <button class="btn-secondary" onclick="showBatchInputForm('${batch}', '${product}', '${date}', '${vessel}', '${plannedWeight}', '${actualWeight}', '${yieldPercent}', '${yieldVerdict}', '${suggestedMixers}', '${suggestedGrinders}', \`${fillingInfo}\`, true)">
                        ‚úèÔ∏è EDIT DETAILS
                    </button>
                </div>
                
                <h3 style="margin-bottom: 15px; color: var(--accent-blue);">üìä Production Details</h3>
                <div class="batch-info-grid">
                    <div class="batch-info-item"><div class="batch-info-label">Production Date</div><div class="batch-info-value">${date}</div></div>
                    <div class="batch-info-item" style="border-left-color: var(--accent-blue);"><div class="batch-info-label">Vessel Used</div><div class="batch-info-value">${vesselUsed}</div></div>
                    ${vesselDetailsHtml}
                    <div class="batch-info-item"><div class="batch-info-label">Planned Weight</div><div class="batch-info-value">${plannedWeight}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Actual Weight</div><div class="batch-info-value">${actualWeight}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Yield %</div><div class="batch-info-value">${yieldPercent}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Yield Verdict</div><div class="batch-info-value">${yieldVerdict}</div></div>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-yellow);">‚öôÔ∏è Equipment Information</h3>
                <div class="batch-info-grid">
                    <div class="batch-info-item" style="border-left-color: var(--accent-green);"><div class="batch-info-label">Mixer Used (Actual)</div><div class="batch-info-value">${mixerUsedActual}</div></div>
                    <div class="batch-info-item" style="border-left-color: var(--accent-blue);"><div class="batch-info-label">Grinder Used (Actual)</div><div class="batch-info-value">${grinderUsedActual}</div></div>
                    <div class="batch-info-item" style="border-left-color: var(--accent-green);"><div class="batch-info-label">Suggested Mixers</div><div class="batch-info-value">${suggestedMixers}</div></div>
                    <div class="batch-info-item" style="border-left-color: var(--accent-blue);"><div class="batch-info-label">Suggested Grinders</div><div class="batch-info-value">${suggestedGrinders}</div></div>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-purple);">üë• Manpower & Operators</h3>
                <div class="batch-info-grid">
                    <div class="batch-info-item"><div class="batch-info-label">Mixer/Grinder Operators</div><div class="batch-info-value">${mixerGrinderOperators}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Filling Operators</div><div class="batch-info-value">${fillingOperators}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Total Manpower</div><div class="batch-info-value">${totalManpower}</div></div>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-green);">‚è±Ô∏è Time Tracking</h3>
                <div class="batch-info-grid">
                    <div class="batch-info-item"><div class="batch-info-label">Time on Mixer (min)</div><div class="batch-info-value">${timeOnMixer}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Time on Grinder (min)</div><div class="batch-info-value">${timeOnGrinder}</div></div>
                    <div class="batch-info-item"><div class="batch-info-label">Downtime (min)</div><div class="batch-info-value">${downtime}</div></div>
                    <div class="batch-info-item" style="border-left-color: var(--accent-yellow);"><div class="batch-info-label">Total Process Time (min)</div><div class="batch-info-value" style="font-size: 20px; color: var(--accent-yellow);">${totalProcessTime}</div></div>
                </div>
                
                ${problemsHtml}
                
                ${downtimeReason !== 'N/A' ? `
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--accent-orange);">‚öôÔ∏è Downtime</h3>
                    <div class="batch-info-grid">
                        <div class="batch-info-item" style="grid-column: span 2;"><div class="batch-info-label">Reason of Downtime</div><div class="batch-info-value">${downtimeReason}</div></div>
                    </div>
                ` : ''}
                
                ${fillingInfo}
            `;
            
            document.getElementById('batch-modal-body').innerHTML = modalContent;
            document.getElementById('batch-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Show input form to enter batch details
        function showBatchInputForm(batch, product, date, vessel, plannedWeight, actualWeight, yieldPercent, yieldVerdict, suggestedMixers, suggestedGrinders, fillingInfo, isEdit = false) {
            // Get existing data if editing
            const existing = isEdit ? allBatchData[batch] : {};
            
            const modalContent = `
                <div style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-green)); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h2 style="margin: 0; font-size: 28px; color: var(--bg-primary);">${isEdit ? '‚úèÔ∏è Edit' : '‚ûï Add'} Batch Details</h2>
                    <p style="margin: 10px 0 0 0; color: var(--bg-primary); opacity: 0.9;">Batch #${batch} - ${product}</p>
                </div>
                
                <form id="batch-detail-form" onsubmit="saveBatchDetails(event, '${batch}')">
                    <h3 style="margin-bottom: 15px; color: var(--accent-blue);">üè∫ Vessel Selection</h3>
                    <div class="form-group">
                        <label class="form-label">Vessel Used</label>
                        <select id="vessel-used" class="form-input" onchange="updateEquipmentCompatibility()">
                            <option value="">-- Select Vessel --</option>
                            ${generateVesselOptions(vessel, existing['Vessel Used'] || '')}
                        </select>
                        <div id="vessel-info" style="margin-top: 8px; padding: 10px; background: var(--bg-secondary); border-radius: 4px; display: none;">
                            <div style="margin-bottom: 5px;"><strong>Color:</strong> <span id="vessel-color">--</span></div>
                            <div style="margin-bottom: 5px;"><strong>Compatible Mixers:</strong> <span id="vessel-mixers" style="color: var(--accent-green);">--</span></div>
                            <div><strong>Compatible Grinders:</strong> <span id="vessel-grinders" style="color: var(--accent-blue);">--</span></div>
                        </div>
                        <div id="vessel-unavail-warning" style="display:none; margin-top:10px; padding:12px 16px; background:rgba(255,68,68,0.12); border:1px solid rgba(255,68,68,0.4); border-radius:8px; color:#ff6b6b; font-size:13px; line-height:1.6;">
                            üî¥ <strong>Vessel Unavailable</strong> ‚Äî This vessel still contains product from <span id="vessel-unavail-batch"></span>. It will become available once that batch appears in the Filling sheet.
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px; color: var(--accent-yellow);">‚öôÔ∏è Equipment Used</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mixer Used (Actual)</label>
                            <select id="mixer-used" class="form-input">
                                <option value="">-- Select Mixer --</option>
                            </select>
                            <div id="mixer-warning" style="margin-top: 5px; color: var(--accent-red); font-size: 12px; display: none;">
                                ‚ö†Ô∏è This mixer may not be compatible with selected vessel
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grinder Used (Actual) <span style="color: var(--text-secondary);">(Optional)</span></label>
                            <select id="grinder-used" class="form-input">
                                <option value="">-- No Grinder / Select Grinder --</option>
                            </select>
                            <div id="grinder-warning" style="margin-top: 5px; color: var(--accent-red); font-size: 12px; display: none;">
                                ‚ö†Ô∏è This grinder may not be compatible with selected vessel
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin: 25px 0 15px; color: var(--accent-purple);">üë• Manpower</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mixer/Grinder Operators</label>
                            <input type="number" id="mixer-grinder-ops" class="form-input" placeholder="Number of operators (optional)" value="${existing['Mixer/Grinder Operators'] || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Filling Operators</label>
                            <input type="number" id="filling-ops" class="form-input" placeholder="Number of operators (optional)" value="${existing['Filling Operators'] || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Manpower (Auto-calculated)</label>
                        <input type="number" id="total-manpower" class="form-input" readonly value="${existing['Total Manpower'] || ''}">
                    </div>
                    
                    <h3 style="margin: 25px 0 15px; color: var(--accent-green);">‚è±Ô∏è Time Tracking</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Time on Mixer (minutes)</label>
                            <input type="number" id="time-mixer" class="form-input" placeholder="Minutes (optional)" value="${existing['Time on Mixer (min)'] || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time on Grinder (minutes) <span style="color: var(--text-secondary);">(Optional)</span></label>
                            <input type="number" id="time-grinder" class="form-input" placeholder="Minutes" value="${existing['Time on Grinder (min)'] || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Downtime (minutes) <span style="color: var(--text-secondary);">(Optional)</span></label>
                        <input type="number" id="downtime" class="form-input" placeholder="Minutes" value="${existing['Downtime (min)'] || ''}">
                    </div>
                    
                    <div class="form-group" style="margin: 20px 0;">
                        <label class="form-label">Total Process Time (Auto-calculated)</label>
                        <div id="total-process-time" class="calculated-value">0 min</div>
                    </div>
                    
                    <h3 style="margin: 25px 0 15px; color: var(--accent-red);">‚ö†Ô∏è Problems & Solutions <span style="color: var(--text-secondary); font-size: 12px; font-weight: normal;">(Optional)</span></h3>
                    
                    <div id="problems-container" style="margin-bottom: 20px;">
                        <!-- Problem entries will be added here dynamically -->
                    </div>
                    
                    <button type="button" class="btn-secondary" onclick="addProblem()" style="width: 100%; margin-bottom: 20px;">
                        ‚ûï ADD PROBLEM
                    </button>
                    
                    <div class="form-group">
                        <label class="form-label">Reason of Downtime</label>
                        <input type="text" id="downtime-reason" class="form-input" placeholder="Reason for downtime" value="${existing['Reason of Downtime'] || ''}">
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn-success" style="flex: 1;">üíæ SAVE BATCH DETAILS</button>
                        <button type="button" class="btn-secondary" onclick="closeBatchModal()">CANCEL</button>
                    </div>
                </form>
            `;
            
            document.getElementById('batch-modal-body').innerHTML = modalContent;
            document.getElementById('batch-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            console.log('‚úÖ Batch input form created for batch:', batch);
            console.log('‚úÖ Form element exists?', document.getElementById('batch-detail-form') !== null);
            console.log('‚úÖ Save button exists?', document.querySelector('button[type="submit"]') !== null);
            
            // Load existing problems if editing
            if (existing['Problems']) {
                try {
                    const problems = JSON.parse(existing['Problems']);
                    problems.forEach(problem => {
                        addProblem(problem);
                    });
                } catch (e) {
                    console.warn('Could not parse existing problems');
                }
            }
            
            // Add event listeners for auto-calculation
            setupAutoCalculation();
        }

        // Counter for unique problem IDs
        let problemCounter = 0;

        // Add a problem entry
        function addProblem(existingData = null) {
            const problemId = 'problem-' + (++problemCounter);
            const container = document.getElementById('problems-container');
            
            const problemTypes = [
                'Viscosity',
                'Color', 
                'Drying Time',
                'Too much Grinding',
                'Dispersing Problem',
                'Complete batch damaged'
            ];
            
            const selectedType = existingData ? existingData.type : '';
            
            const problemHtml = `
                <div id="${problemId}" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 2px solid var(--accent-red); margin-bottom: 15px; position: relative;">
                    <button type="button" onclick="removeProblem('${problemId}')" style="position: absolute; top: 10px; right: 10px; background: var(--accent-red); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
                    
                    <div class="form-group">
                        <label class="form-label">Problem Type</label>
                        <select class="form-input problem-type-select" onchange="toggleProblemFields('${problemId}', this.value)" data-problem-id="${problemId}">
                            <option value="">-- Select Problem --</option>
                            ${problemTypes.map(type => `<option value="${type}" ${type === selectedType ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="${problemId}-fields" style="margin-top: 15px;">
                        <!-- Problem-specific fields will be inserted here -->
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', problemHtml);
            
            // If editing, populate fields
            if (existingData && existingData.type) {
                toggleProblemFields(problemId, existingData.type, existingData);
            }
        }

        // Remove a problem entry
        function removeProblem(problemId) {
            document.getElementById(problemId).remove();
        }

        // Show problem-specific fields based on type
        function toggleProblemFields(problemId, problemType, existingData = null) {
            const fieldsContainer = document.getElementById(problemId + '-fields');
            
            if (!problemType) {
                fieldsContainer.innerHTML = '';
                return;
            }
            
            let fieldsHtml = '';
            
            switch(problemType) {
                case 'Viscosity':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Initial Viscosity (KU)</label>
                            <input type="number" step="0.1" class="form-input" name="initial-viscosity" placeholder="e.g., 95" value="${existingData?.initialViscosity || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Final Acceptable Viscosity (KU)</label>
                            <input type="number" step="0.1" class="form-input" name="final-viscosity" placeholder="e.g., 85" value="${existingData?.finalViscosity || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Solvents Added</label>
                            <div id="${problemId}-solvents" style="margin-bottom: 10px;">
                                <!-- Solvents will be added here -->
                            </div>
                            <button type="button" class="btn-secondary" onclick="addSolvent('${problemId}')" style="width: 100%;">
                                ‚ûï Add Solvent
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'Color':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Expected Color</label>
                            <input type="text" class="form-input" name="expected-color" placeholder="e.g., RAL 9010" value="${existingData?.expectedColor || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Actual Color</label>
                            <input type="text" class="form-input" name="actual-color" placeholder="e.g., Slightly yellow" value="${existingData?.actualColor || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Correction Action</label>
                            <textarea class="form-input" name="correction-action" placeholder="What was done to fix the color?" rows="2">${existingData?.correctionAction || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'Drying Time':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Expected Drying Time (hours)</label>
                            <input type="number" step="0.5" class="form-input" name="expected-drying" placeholder="e.g., 4" value="${existingData?.expectedDrying || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Actual Drying Time (hours)</label>
                            <input type="number" step="0.5" class="form-input" name="actual-drying" placeholder="e.g., 6" value="${existingData?.actualDrying || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Solution Applied</label>
                            <textarea class="form-input" name="drying-solution" placeholder="What was done to fix it?" rows="2">${existingData?.dryingSolution || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'Too much Grinding':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Target Fineness (microns)</label>
                            <input type="number" step="0.1" class="form-input" name="target-fineness" placeholder="e.g., 50" value="${existingData?.targetFineness || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Actual Fineness (microns)</label>
                            <input type="number" step="0.1" class="form-input" name="actual-fineness" placeholder="e.g., 30" value="${existingData?.actualFineness || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Corrective Action</label>
                            <textarea class="form-input" name="grinding-action" placeholder="What was done?" rows="2">${existingData?.grindingAction || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'Dispersing Problem':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Issue Description</label>
                            <textarea class="form-input" name="dispersing-issue" placeholder="Describe the dispersing problem" rows="2">${existingData?.dispersingIssue || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Solution Applied</label>
                            <textarea class="form-input" name="dispersing-solution" placeholder="How was it resolved?" rows="2">${existingData?.dispersingSolution || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'Complete batch damaged':
                    fieldsHtml = `
                        <div class="form-group">
                            <label class="form-label">Damage Cause</label>
                            <textarea class="form-input" name="damage-cause" placeholder="What caused the damage?" rows="2">${existingData?.damageCause || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Batch Status</label>
                            <select class="form-input" name="batch-status">
                                <option value="">-- Select Status --</option>
                                <option value="Discarded" ${existingData?.batchStatus === 'Discarded' ? 'selected' : ''}>Discarded</option>
                                <option value="Reworked" ${existingData?.batchStatus === 'Reworked' ? 'selected' : ''}>Reworked</option>
                                <option value="Partial Loss" ${existingData?.batchStatus === 'Partial Loss' ? 'selected' : ''}>Partial Loss</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loss Amount (KG)</label>
                            <input type="number" step="0.1" class="form-input" name="loss-amount" placeholder="e.g., 150" value="${existingData?.lossAmount || ''}">
                        </div>
                    `;
                    break;
            }
            
            fieldsContainer.innerHTML = fieldsHtml;
            
            // If Viscosity problem and editing, add existing solvents
            if (problemType === 'Viscosity' && existingData?.solvents) {
                existingData.solvents.forEach(solvent => {
                    addSolvent(problemId, solvent);
                });
            }
        }

        // Counter for unique solvent IDs
        let solventCounter = 0;

        // Add solvent input for viscosity problem
        function addSolvent(problemId, existingData = null) {
            const solventId = 'solvent-' + (++solventCounter);
            const container = document.getElementById(problemId + '-solvents');
            
            const solventHtml = `
                <div id="${solventId}" style="background: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: var(--accent-yellow);">Solvent ${container.children.length + 1}</strong>
                        <button type="button" onclick="document.getElementById('${solventId}').remove()" style="background: var(--accent-red); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label" style="font-size: 11px;">Solvent Type</label>
                            <input type="text" class="form-input" name="solvent-type" placeholder="e.g., Xylene" value="${existingData?.type || ''}" style="padding: 8px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label" style="font-size: 11px;">Weight (KG)</label>
                            <input type="number" step="0.1" class="form-input" name="solvent-weight" placeholder="e.g., 30" value="${existingData?.weight || ''}" style="padding: 8px;">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', solventHtml);
        }

        // Setup auto-calculation for total manpower and process time
        function setupAutoCalculation() {
            const mixerGrinderOps = document.getElementById('mixer-grinder-ops');
            const fillingOps = document.getElementById('filling-ops');
            const totalManpower = document.getElementById('total-manpower');
            
            const timeMixer = document.getElementById('time-mixer');
            const timeGrinder = document.getElementById('time-grinder');
            const downtime = document.getElementById('downtime');
            const totalProcessTime = document.getElementById('total-process-time');
            
            function calculateTotals() {
                // Total Manpower
                const mgOps = parseInt(mixerGrinderOps.value) || 0;
                const fOps = parseInt(fillingOps.value) || 0;
                totalManpower.value = mgOps + fOps;
                
                // Total Process Time = Time on Mixer + Time on Grinder + Downtime
                const tMixer = parseInt(timeMixer.value) || 0;
                const tGrinder = parseInt(timeGrinder.value) || 0;
                const dt = parseInt(downtime.value) || 0;
                const total = tMixer + tGrinder + dt;
                totalProcessTime.textContent = total + ' min';
            }
            
            mixerGrinderOps.addEventListener('input', calculateTotals);
            fillingOps.addEventListener('input', calculateTotals);
            timeMixer.addEventListener('input', calculateTotals);
            timeGrinder.addEventListener('input', calculateTotals);
            downtime.addEventListener('input', calculateTotals);
            
            // Calculate on load
            calculateTotals();
        }

        // Save batch details to browser localStorage

        // Show loading state while fetching batch details
        function showLoadingModal(batch, product) {
            const loadingContent = `
                <div style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-green)); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h2 style="margin: 0; font-size: 28px; color: var(--bg-primary);">Batch #${batch}</h2>
                    <p style="margin: 10px 0 0 0; color: var(--bg-primary); opacity: 0.9;">${product}</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div style="width: 50px; height: 50px; border: 4px solid var(--accent-green); border-top-color: transparent; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                    <p style="color: var(--text-secondary);">üîÑ Fetching batch details...</p>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            document.getElementById('batch-modal-body').innerHTML = loadingContent;
            document.getElementById('batch-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Fetch batch details from a separate Google Sheet
        async function fetchBatchDetailsFromUrl(url) {
            // Extract Sheet ID from URL
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) {
                throw new Error('Invalid Google Sheets URL');
            }
            
            const sheetId = match[1];
            console.log('üìÑ Fetching from Sheet ID:', sheetId);
            
            // Fetch data from the batch detail sheet (columns A and C)
            const range = 'A:C';
            const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${API_KEY}`;
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to fetch batch details');
            }
            
            const data = await response.json();
            const values = data.values || [];
            
            console.log('üìä Fetched', values.length, 'rows from batch sheet');
            
            // Parse the vertical format (labels in column A, values in column C)
            const batchInfo = {};
            
            values.forEach((row, idx) => {
                const label = row[0] ? row[0].toString().trim() : '';
                const value = row[2] !== undefined ? row[2] : '';
                
                // Skip the batch number row
                if (label && label !== 'Batch Number:') {
                    const cleanLabel = label.replace(':', '').trim();
                    batchInfo[cleanLabel] = value;
                    console.log(`  ${cleanLabel}: ${value}`);
                }
            });
            
            return batchInfo;
        }
            

        function closeBatchModal(event) {
            // Only close if clicking the overlay (not the content)
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('batch-modal').classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeBatchModal();
            }
        });

        // PAGE 2: Equipment Analysis
        function runEquipmentAnalysis() {
            const startDate = document.getElementById('equip-start-date').valueAsDate;
            const endDate = document.getElementById('equip-end-date').valueAsDate;
            const equipmentCode = document.getElementById('equip-code').value.trim().toUpperCase();

            if (!startDate || !endDate || !equipmentCode) {
                alert('Please fill in all fields');
                return;
            }

            const endDateInclusive = new Date(endDate);
            endDateInclusive.setHours(23, 59, 59, 999);

            const categories = ['ENAMEL', 'EPOXY', 'PU', 'NC', 'BASE', 'SYNTHETIC'];
            const categoryWeights = {};
            categories.forEach(cat => categoryWeights[cat] = 0);
            let uncategorizedWeight = 0;
            let usageCount = 0;
            let totalWeight = 0;

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(12, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDateInclusive) {
                    const productName = (row[1] || '').toString().toUpperCase();
                    const weight = parseWeight(row[3]);
                    const equipmentCell = (row[10] || '').toString().toUpperCase();

                    if (equipmentCell.includes(equipmentCode)) {
                        usageCount++;
                        totalWeight += weight;

                        let categoryFound = false;
                        for (let cat of categories) {
                            if (productName.includes(cat)) {
                                categoryWeights[cat] += weight;
                                categoryFound = true;
                                break;
                            }
                        }
                        if (!categoryFound) {
                            uncategorizedWeight += weight;
                        }
                    }
                }
            });

            let categoryBreakdown = '';
            categories.forEach(cat => {
                if (categoryWeights[cat] > 0) {
                    categoryBreakdown += `<br><strong>${cat}:</strong> ${formatNumber(categoryWeights[cat])} kg`;
                }
            });
            if (uncategorizedWeight > 0) {
                categoryBreakdown += `<br><strong>Other:</strong> ${formatNumber(uncategorizedWeight)} kg`;
            }

            const resultText = `
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--accent-green); margin-bottom: 15px;">Equipment: ${equipmentCode}</h3>
                    <p style="line-height: 1.8;"><strong>Date Range:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
                    <p style="line-height: 1.8;"><strong>Times Used:</strong> ${usageCount} sessions</p>
                    <p style="line-height: 1.8;"><strong>Total Weight Processed:</strong> ${formatNumber(totalWeight)} kg</p>
                    <p style="line-height: 1.8;"><strong>Category Breakdown:</strong> ${categoryBreakdown || ' None'}</p>
                </div>
            `;

            document.getElementById('equipment-results').innerHTML = resultText;
            updateEquipmentChart(categoryWeights, uncategorizedWeight);
        }

        function updateEquipmentChart(categoryWeights, uncategorizedWeight) {
            const ctx = document.getElementById('equipment-chart');
            
            const labels = [];
            const values = [];
            
            Object.keys(categoryWeights).forEach(cat => {
                if (categoryWeights[cat] > 0) {
                    labels.push(cat);
                    values.push(categoryWeights[cat]);
                }
            });
            
            if (uncategorizedWeight > 0) {
                labels.push('Other');
                values.push(uncategorizedWeight);
            }

            destroyChart('equipment-chart');
            
            chartInstances['equipment-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // PAGE 3: Daily Report
        function generateDailyReport() {
            const reportDate = document.getElementById('daily-report-date').valueAsDate;
            if (!reportDate) {
                alert('Please select a date');
                return;
            }

            const targetDate = new Date(reportDate);
            targetDate.setHours(0, 0, 0, 0);

            let dailyKilos = 0;
            let dailyEntries = 0;
            const categories = {};
            const products = {};
            const equipmentUsage = { mixers: {}, grinders: {} };

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate.getTime() === targetDate.getTime()) {
                    const product = row[1];
                    const weight = parseWeight(row[3]);
                    const equipmentCell = (row[10] || '').toString().toUpperCase();
                    
                    dailyKilos += weight;
                    dailyEntries++;

                    const category = detectCategory(product);
                    categories[category] = (categories[category] || 0) + weight;
                    products[product] = (products[product] || 0) + weight;

                    // Equipment tracking
                    const mixers = equipmentCell.match(/MX\d+/g) || [];
                    const grinders = equipmentCell.match(/GR\d+/g) || [];
                    
                    mixers.forEach(mx => {
                        equipmentUsage.mixers[mx] = (equipmentUsage.mixers[mx] || 0) + 1;
                    });
                    grinders.forEach(gr => {
                        equipmentUsage.grinders[gr] = (equipmentUsage.grinders[gr] || 0) + 1;
                    });
                }
            });

            // Filling data
            const uniqueProducts = new Set();
            let fillingHours = 0;

            allFillingData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate.getTime() === targetDate.getTime()) {
                    const product = row[1];
                    const batch = row[2];
                    if (product) {
                        uniqueProducts.add(`${product}|${batch}`);
                    }

                    const startTime = row[9];
                    const endTime = row[10];
                    if (startTime && endTime) {
                        fillingHours += calculateHours(startTime, endTime);
                    }
                }
            });

            // Calculate KPI
            const targetWeight = 30000;
            const targetProducts = 15;
            const targetHours = 8;

            const weightScore = Math.min(100, (dailyKilos / targetWeight) * 100);
            const productScore = Math.min(100, (uniqueProducts.size / targetProducts) * 100);
            const fillingScore = Math.min(100, (fillingHours / targetHours) * 100);
            const kpiScore = (weightScore * 0.4 + productScore * 0.3 + fillingScore * 0.3).toFixed(1);

            const kpiBadge = kpiScore >= 80 ? 'success' : (kpiScore >= 60 ? 'warning' : 'error');
            const kpiText = kpiScore >= 80 ? 'EXCELLENT' : (kpiScore >= 60 ? 'GOOD' : 'NEEDS IMPROVEMENT');

            // Get most produced category
            let mostProducedCat = '';
            let maxWeight = 0;
            Object.entries(categories).forEach(([cat, weight]) => {
                if (weight > maxWeight) {
                    maxWeight = weight;
                    mostProducedCat = cat;
                }
            });
            const mostProducedText = mostProducedCat ? `${mostProducedCat} (${formatNumber(maxWeight)} KG)` : 'N/A';

            const reportHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: var(--accent-blue);">Report Date: ${targetDate.toLocaleDateString()}</h2>
                    <button class="btn-success" onclick="exportDailyReportToPDF()" style="padding: 12px 30px;">
                        üìÑ EXPORT TO PDF
                    </button>
                </div>
                
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Total Weight</div>
                        <div class="kpi-value">${formatNumber(dailyKilos)} KG</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Entries</div>
                        <div class="kpi-value">${dailyEntries}</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products Filled</div>
                        <div class="kpi-value">${uniqueProducts.size}</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Filling Hours</div>
                        <div class="kpi-value">${fillingHours.toFixed(1)} HRS</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Daily KPI Score</div>
                        <div class="kpi-value">${kpiScore}</div>
                        <div class="kpi-change"><span class="badge ${kpiBadge}">${kpiText}</span></div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Weight Score</div>
                        <div class="kpi-value" style="font-size: 24px;">${weightScore.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Product Score</div>
                        <div class="kpi-value" style="font-size: 24px;">${productScore.toFixed(1)}%</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Equipment Utilization Summary</h3>
                <div class="grid">
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-green);">Mixers Used</h4>
                        ${Object.keys(equipmentUsage.mixers).length > 0 ? 
                            Object.entries(equipmentUsage.mixers).map(([mx, count]) => 
                                `<p style="line-height: 1.8;"><strong>${mx}:</strong> ${count} sessions</p>`
                            ).join('') : 
                            '<p style="color: var(--text-secondary);">No mixer data</p>'
                        }
                    </div>
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">Grinders Used</h4>
                        ${Object.keys(equipmentUsage.grinders).length > 0 ? 
                            Object.entries(equipmentUsage.grinders).map(([gr, count]) => 
                                `<p style="line-height: 1.8;"><strong>${gr}:</strong> ${count} sessions</p>`
                            ).join('') : 
                            '<p style="color: var(--text-secondary);">No grinder data</p>'
                        }
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Category Breakdown</h3>
                <div class="data-table">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Weight (KG)</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(categories).map(cat => {
                                    const pct = dailyKilos > 0 ? ((categories[cat] / dailyKilos) * 100).toFixed(1) : '0';
                                    return `
                                        <tr>
                                            <td>${cat}</td>
                                            <td>${formatNumber(categories[cat])}</td>
                                            <td>${pct}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Top Products</h3>
                <div class="data-table">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Weight (KG)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(products)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 10)
                                    .map(([product, weight]) => `
                                        <tr>
                                            <td>${product}</td>
                                            <td>${formatNumber(weight)}</td>
                                        </tr>
                                    `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Category Visualization</h3>
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Breakdown (Pie Chart)</div>
                            <canvas id="daily-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Weights (Bar Chart)</div>
                            <canvas id="daily-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Daily Production Insights</h3>
                <div class="grid">
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-green);">Production Summary</h4>
                        <p style="line-height: 1.8;"><strong>Most Produced Category:</strong> ${mostProducedText}</p>
                        <p style="line-height: 1.8;"><strong>Number of Categories:</strong> ${Object.keys(categories).length}</p>
                        <p style="line-height: 1.8;"><strong>Average Weight per Product:</strong> ${Object.keys(products).length > 0 ? (dailyKilos / Object.keys(products).length).toFixed(2) : '0'} KG</p>
                    </div>
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">Efficiency Metrics</h4>
                        <p style="line-height: 1.8;"><strong>Products per Hour:</strong> ${fillingHours > 0 ? (uniqueProducts.size / fillingHours).toFixed(2) : '0'}</p>
                        <p style="line-height: 1.8;"><strong>KG per Hour:</strong> ${fillingHours > 0 ? (dailyKilos / fillingHours).toFixed(2) : '0'}</p>
                        <p style="line-height: 1.8;"><strong>Avg Filling Time:</strong> ${uniqueProducts.size > 0 ? (fillingHours / uniqueProducts.size).toFixed(2) : '0'} hrs/product</p>
                    </div>
                </div>
            `;

            document.getElementById('daily-report-content').innerHTML = reportHTML;
            
            // Store report data for PDF export
            currentReportData = {
                date: targetDate,
                dailyKilos,
                dailyEntries,
                uniqueProducts: uniqueProducts.size,
                fillingHours,
                kpiScore,
                kpiText,
                weightScore,
                productScore,
                fillingScore,
                categories,
                products,
                equipmentUsage,
                mostProducedText
            };
            
            // Show charts section
            document.getElementById('daily-charts-section').style.display = 'block';
            document.getElementById('daily-trend-charts').style.display = 'block';
            
            // Generate category charts
            generateDailyCategoryCharts(categories);
            
            // Generate equipment chart
            generateEquipmentUsageChart(equipmentUsage.mixers, equipmentUsage.grinders);
            
            // Generate trend charts (last 30 days)
            generateDailyTrendCharts(reportDate);
        }

        // Export Daily Report to Professional PDF
        async function exportDailyReportToPDF() {
            if (!currentReportData) {
                alert('Please generate a report first');
                return;
            }
            
            // Check if jsPDF is available
            if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
                alert('‚ö†Ô∏è PDF library is still loading or blocked.\n\nPlease:\n1. Wait a few seconds and try again\n2. Check your internet connection\n3. Disable any ad blockers temporarily\n4. Refresh the page');
                
                // Try to manually load it
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    alert('‚úÖ PDF library loaded! Please click Export again.');
                };
                script.onerror = () => {
                    alert('‚ùå Unable to load PDF library. Please check your internet connection or try a different browser.');
                };
                document.head.appendChild(script);
                
                return;
            }
            
            // Try to get jsPDF from different possible locations
            let jsPDF;
            try {
                jsPDF = window.jspdf?.jsPDF || window.jsPDF;
                if (!jsPDF) {
                    throw new Error('jsPDF constructor not found');
                }
            } catch (e) {
                alert('‚ùå PDF library initialization failed: ' + e.message);
                return;
            }
            
            // Show loading overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13,17,23,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column;';
            overlay.innerHTML = `
                <div style="width: 80px; height: 80px; border: 6px solid #00ff88; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <h2 style="color: #00ff88; margin-top: 30px; font-family: 'Space Grotesk', sans-serif;">üìÑ Generating Professional PDF Report</h2>
                <p style="color: #ccc; margin-top: 15px;">Creating multi-page report with charts...</p>
            `;
            document.body.appendChild(overlay);
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const data = currentReportData;
                const W = pdf.internal.pageSize.getWidth();
                const H = pdf.internal.pageSize.getHeight();
                const M = 15;
                let Y = M;
                
                // Dashboard colors
                const DARK_BG = [13, 17, 23];
                const DARKER_BG = [22, 26, 32];
                const CARD_BG = [30, 35, 43];
                const BORDER = [42, 48, 60];
                const TEXT_PRIMARY = [255, 255, 255];
                const TEXT_SECONDARY = [170, 180, 190];
                const BLUE = [0, 180, 255];
                const GREEN = [0, 255, 136];
                const YELLOW = [255, 193, 7];
                const RED = [255, 107, 107];
                const PURPLE = [156, 39, 176];
                
                // Helper to apply color
                function setFill(color) {
                    pdf.setFillColor(color[0], color[1], color[2]);
                }
                function setDraw(color) {
                    pdf.setDrawColor(color[0], color[1], color[2]);
                }
                function setText(color) {
                    pdf.setTextColor(color[0], color[1], color[2]);
                }
                
                function newPage() {
                    pdf.addPage();
                    Y = M;
                    // Dark background for new page
                    setFill(DARK_BG);
                    pdf.rect(0, 0, W, H, 'F');
                }
                
                function needSpace(h) {
                    if (Y + h > H - 20) {
                        newPage();
                        return true;
                    }
                    return false;
                }
                
                function addFooter() {
                    const pageNum = pdf.internal.getCurrentPageInfo().pageNumber;
                    pdf.setFontSize(8);
                    setText(TEXT_SECONDARY);
                    pdf.text(`Generated: ${new Date().toLocaleString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'})}`, M, H - 8);
                    pdf.text('Production Analytics Dashboard', W / 2, H - 8, { align: 'center' });
                    pdf.text(`Page ${pageNum}`, W - M, H - 8, { align: 'right' });
                }
                
                // ========== PAGE 1 ==========
                
                // Dark background
                setFill(DARK_BG);
                pdf.rect(0, 0, W, H, 'F');
                
                // Top accent line
                setFill(BLUE);
                pdf.rect(0, 0, W, 3, 'F');
                
                // Title
                setText(TEXT_PRIMARY);
                pdf.setFontSize(32);
                pdf.setFont(undefined, 'bold');
                pdf.text('DAILY PRODUCTION', W / 2, 30, { align: 'center' });
                pdf.text('REPORT', W / 2, 45, { align: 'center' });
                
                // Date
                pdf.setFontSize(13);
                setText(GREEN);
                const dateStr = data.date.toLocaleDateString('en-US', { 
                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
                });
                pdf.text(dateStr, W / 2, 58, { align: 'center' });
                
                // Separator line
                setDraw(BLUE);
                pdf.setLineWidth(0.5);
                pdf.line(M, 65, W - M, 65);
                
                Y = 75;
                
                // Executive Summary
                setFill(CARD_BG);
                pdf.rect(M, Y, W - 2 * M, 45, 'F');
                
                setText(BLUE);
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('EXECUTIVE SUMMARY', M + 5, Y + 8);
                
                setText(TEXT_PRIMARY);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                const summary = `Production for ${dateStr} generated ${formatNumber(data.dailyKilos)} KG across ${data.dailyEntries} batches. The facility processed ${data.uniqueProducts} unique products with ${data.fillingHours.toFixed(1)} hours of filling operations. Overall KPI: ${data.kpiScore} (${data.kpiText}).`;
                const lines = pdf.splitTextToSize(summary, W - 2 * M - 10);
                pdf.text(lines, M + 5, Y + 18);
                
                Y += 55;
                
                // KPI Score Card
                const kpiRGB = data.kpiScore >= 80 ? GREEN : data.kpiScore >= 60 ? YELLOW : RED;
                
                setFill(CARD_BG);
                pdf.rect(M, Y, W - 2 * M, 50, 'F');
                
                setDraw(kpiRGB);
                pdf.setLineWidth(2);
                pdf.rect(M, Y, W - 2 * M, 50, 'S');
                
                // KPI Label
                setText(TEXT_SECONDARY);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('OVERALL KPI SCORE', M + 5, Y + 12);
                
                // KPI Value (centered in card)
                setText(kpiRGB);
                pdf.setFontSize(48);
                pdf.setFont(undefined, 'bold');
                pdf.text(data.kpiScore.toString(), M + 5, Y + 30);
                
                // KPI Status (on separate line below the score)
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text(data.kpiText, M + 5, Y + 42);
                
                // Score Breakdown (removed as it's redundant with Key Metrics section)
                
                Y += 60;
                
                // Key Metrics
                setText(TEXT_PRIMARY);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('KEY METRICS', M, Y);
                Y += 8;
                
                const metrics = [
                    { label: 'Total Production', value: formatNumber(data.dailyKilos) + ' KG', color: BLUE },
                    { label: 'Batch Entries', value: data.dailyEntries.toString(), color: GREEN },
                    { label: 'Products Filled', value: data.uniqueProducts.toString(), color: YELLOW },
                    { label: 'Operating Hours', value: data.fillingHours.toFixed(1) + ' hrs', color: PURPLE }
                ];
                
                const cardW = (W - 2 * M - 8) / 2;
                const cardH = 28;
                
                metrics.forEach((m, i) => {
                    const row = Math.floor(i / 2);
                    const col = i % 2;
                    const x = M + col * (cardW + 8);
                    const y = Y + row * (cardH + 6);
                    
                    setFill(CARD_BG);
                    pdf.rect(x, y, cardW, cardH, 'F');
                    
                    setFill(m.color);
                    pdf.rect(x, y, 4, cardH, 'F');
                    
                    setText(TEXT_SECONDARY);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(m.label, x + 8, y + 10);
                    
                    setText(m.color);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(m.value, x + 8, y + 22);
                });
                
                addFooter();
                
                // ========== PAGE 2: CATEGORY ANALYSIS ==========
                newPage();
                
                // Section header
                setFill(BLUE);
                pdf.rect(0, Y, W, 12, 'F');
                setText(DARK_BG);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('CATEGORY & PRODUCT ANALYSIS', M, Y + 8);
                Y += 18;
                
                // Category Pie Chart
                try {
                    const pieCanvas = document.getElementById('daily-category-pie');
                    if (pieCanvas) {
                        setText(TEXT_PRIMARY);
                        pdf.setFontSize(11);
                        pdf.text('Category Distribution', M, Y);
                        Y += 5;
                        
                        const pieImg = pieCanvas.toDataURL('image/png', 1.0);
                        pdf.addImage(pieImg, 'PNG', M, Y, W - 2 * M, 70);
                        Y += 75;
                    }
                } catch (e) {}
                
                needSpace(60);
                
                // Category Table
                setText(TEXT_PRIMARY);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Category Breakdown', M, Y);
                Y += 8;
                
                // Table header
                setFill(BLUE);
                pdf.rect(M, Y, W - 2 * M, 10, 'F');
                setText(DARK_BG);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'bold');
                pdf.text('Category', M + 3, Y + 6);
                pdf.text('Weight (KG)', W / 2, Y + 6, { align: 'center' });
                pdf.text('Percentage', W - M - 3, Y + 6, { align: 'right' });
                Y += 10;
                
                // Table rows
                const cats = Object.entries(data.categories).sort((a, b) => b[1] - a[1]);
                pdf.setFont(undefined, 'normal');
                
                cats.forEach((cat, i) => {
                    needSpace(7);
                    
                    setFill(i % 2 === 0 ? CARD_BG : DARKER_BG);
                    pdf.rect(M, Y, W - 2 * M, 7, 'F');
                    
                    setText(TEXT_PRIMARY);
                    pdf.setFontSize(8);
                    pdf.text(cat[0].substring(0, 35), M + 3, Y + 5);
                    pdf.text(formatNumber(cat[1]), W / 2, Y + 5, { align: 'center' });
                    
                    const pct = data.dailyKilos > 0 ? ((cat[1] / data.dailyKilos) * 100).toFixed(1) : '0';
                    setText(BLUE);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${pct}%`, W - M - 3, Y + 5, { align: 'right' });
                    pdf.setFont(undefined, 'normal');
                    
                    Y += 7;
                });
                
                Y += 8;
                
                // Bar Chart
                needSpace(75);
                
                try {
                    const barCanvas = document.getElementById('daily-category-bar');
                    if (barCanvas) {
                        setText(TEXT_PRIMARY);
                        pdf.setFontSize(11);
                        pdf.setFont(undefined, 'bold');
                        pdf.text('Production by Weight', M, Y);
                        Y += 5;
                        
                        const barImg = barCanvas.toDataURL('image/png', 1.0);
                        pdf.addImage(barImg, 'PNG', M, Y, W - 2 * M, 70);
                        Y += 70;
                    }
                } catch (e) {}
                
                addFooter();
                
                // ========== PAGE 3: TOP PRODUCTS ==========
                newPage();
                
                setFill(GREEN);
                pdf.rect(0, Y, W, 12, 'F');
                setText(DARK_BG);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('TOP 10 PRODUCTS BY VOLUME', M, Y + 8);
                Y += 18;
                
                // Table header
                setFill(GREEN);
                pdf.rect(M, Y, W - 2 * M, 10, 'F');
                setText(DARK_BG);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'bold');
                pdf.text('#', M + 3, Y + 6);
                pdf.text('Product Name', M + 12, Y + 6);
                pdf.text('Weight (KG)', W - M - 3, Y + 6, { align: 'right' });
                Y += 10;
                
                const top10 = Object.entries(data.products).sort((a, b) => b[1] - a[1]).slice(0, 10);
                pdf.setFont(undefined, 'normal');
                
                top10.forEach((prod, i) => {
                    needSpace(9);
                    
                    setFill(i % 2 === 0 ? CARD_BG : DARKER_BG);
                    pdf.rect(M, Y, W - 2 * M, 9, 'F');
                    
                    // Rank
                    const rankColor = i < 3 ? YELLOW : TEXT_SECONDARY;
                    setText(rankColor);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'bold');
                    pdf.text((i + 1).toString(), M + 6, Y + 6, { align: 'center' });
                    
                    // Product
                    setText(TEXT_PRIMARY);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    const prodName = prod[0].length > 50 ? prod[0].substring(0, 47) + '...' : prod[0];
                    pdf.text(prodName, M + 12, Y + 6);
                    
                    // Weight
                    setText(GREEN);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(formatNumber(prod[1]), W - M - 3, Y + 6, { align: 'right' });
                    
                    Y += 9;
                });
                
                addFooter();
                
                // ========== PAGE 4: EQUIPMENT ==========
                newPage();
                
                setFill(PURPLE);
                pdf.rect(0, Y, W, 12, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('EQUIPMENT UTILIZATION', M, Y + 8);
                Y += 18;
                
                // Equipment Chart
                try {
                    const eqCanvas = document.getElementById('daily-equipment-chart');
                    if (eqCanvas) {
                        setText(TEXT_PRIMARY);
                        pdf.setFontSize(11);
                        pdf.text('Equipment Sessions', M, Y);
                        Y += 5;
                        
                        const eqImg = eqCanvas.toDataURL('image/png', 1.0);
                        pdf.addImage(eqImg, 'PNG', M, Y, W - 2 * M, 80);
                        Y += 85;
                    }
                } catch (e) {}
                
                needSpace(70);
                
                // Equipment Details
                const cW = (W - 2 * M - 8) / 2;
                const sY = Y;
                
                // MIXERS
                setFill(GREEN);
                pdf.rect(M, Y, cW, 10, 'F');
                setText(DARK_BG);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('MIXERS', M + 5, Y + 7);
                Y += 14;
                
                const mixers = Object.entries(data.equipmentUsage.mixers).sort((a, b) => b[1] - a[1]);
                
                if (mixers.length > 0) {
                    mixers.forEach(([mx, cnt]) => {
                        setFill(CARD_BG);
                        pdf.rect(M, Y, cW, 10, 'F');
                        
                        setText(TEXT_PRIMARY);
                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(mx, M + 5, Y + 6.5);
                        
                        setText(GREEN);
                        pdf.setFontSize(9);
                        pdf.text(`${cnt}x`, M + cW - 18, Y + 6.5, { align: 'center' });
                        
                        Y += 11;
                    });
                } else {
                    setText(TEXT_SECONDARY);
                    pdf.setFontSize(9);
                    pdf.text('No data', M + 5, Y);
                    Y += 10;
                }
                
                // GRINDERS
                Y = sY;
                const gX = M + cW + 8;
                
                setFill(BLUE);
                pdf.rect(gX, Y, cW, 10, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('GRINDERS', gX + 5, Y + 7);
                Y += 14;
                
                const grinders = Object.entries(data.equipmentUsage.grinders).sort((a, b) => b[1] - a[1]);
                
                if (grinders.length > 0) {
                    grinders.forEach(([gr, cnt]) => {
                        setFill(CARD_BG);
                        pdf.rect(gX, Y, cW, 10, 'F');
                        
                        setText(TEXT_PRIMARY);
                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(gr, gX + 5, Y + 6.5);
                        
                        setText(BLUE);
                        pdf.setFontSize(9);
                        pdf.text(`${cnt}x`, gX + cW - 18, Y + 6.5, { align: 'center' });
                        
                        Y += 11;
                    });
                } else {
                    setText(TEXT_SECONDARY);
                    pdf.setFontSize(9);
                    pdf.text('No data', gX + 5, Y);
                    Y += 10;
                }
                
                Y = sY + 14 + Math.max(mixers.length, grinders.length) * 11 + 10;
                
                addFooter();
                
                // ========== PAGE 5: TRENDS ==========
                newPage();
                
                setFill(YELLOW);
                pdf.rect(0, Y, W, 12, 'F');
                setText(DARK_BG);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('30-DAY PERFORMANCE TRENDS', M, Y + 8);
                Y += 18;
                
                // Charts
                const charts = [
                    { id: 'kpi-trend-chart', title: 'KPI Score Trend' },
                    { id: 'products-trend-chart', title: 'Products Filled' },
                    { id: 'weight-trend-chart', title: 'Production Weight' },
                    { id: 'hours-trend-chart', title: 'Filling Hours' }
                ];
                
                for (const chart of charts) {
                    try {
                        const canvas = document.getElementById(chart.id);
                        if (canvas) {
                            needSpace(60);
                            
                            setText(TEXT_PRIMARY);
                            pdf.setFontSize(10);
                            pdf.setFont(undefined, 'bold');
                            pdf.text(chart.title, M, Y);
                            Y += 5;
                            
                            const img = canvas.toDataURL('image/png', 1.0);
                            pdf.addImage(img, 'PNG', M, Y, W - 2 * M, 55);
                            Y += 60;
                        }
                    } catch (e) {}
                }
                
                addFooter();
                
                // ========== PAGE 6: INSIGHTS ==========
                if (pdf.internal.getCurrentPageInfo().pageNumber === 5) {
                    newPage();
                }
                
                setFill(BLUE);
                pdf.rect(0, Y, W, 12, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('OPERATIONAL INSIGHTS', M, Y + 8);
                Y += 18;
                
                const insights = [
                    { 
                        label: 'Products per Hour', 
                        value: data.fillingHours > 0 ? (data.uniqueProducts / data.fillingHours).toFixed(2) : '0',
                        color: GREEN
                    },
                    { 
                        label: 'Production Rate (KG/hr)', 
                        value: data.fillingHours > 0 ? (data.dailyKilos / data.fillingHours).toFixed(0) : '0',
                        color: BLUE
                    },
                    { 
                        label: 'Avg Filling Time (hrs/product)', 
                        value: data.uniqueProducts > 0 ? (data.fillingHours / data.uniqueProducts).toFixed(2) : '0',
                        color: PURPLE
                    }
                ];
                
                insights.forEach(ins => {
                    needSpace(22);
                    
                    setFill(CARD_BG);
                    pdf.rect(M, Y, W - 2 * M, 20, 'F');
                    
                    setFill(ins.color);
                    pdf.rect(M, Y, 4, 20, 'F');
                    
                    setText(TEXT_SECONDARY);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(ins.label, M + 8, Y + 9);
                    
                    setText(ins.color);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(ins.value, M + 8, Y + 17);
                    
                    Y += 24;
                });
                
                Y += 5;
                needSpace(20);
                
                // Most Produced
                setFill(CARD_BG);
                pdf.rect(M, Y, W - 2 * M, 18, 'F');
                
                setDraw(YELLOW);
                pdf.setLineWidth(1.5);
                pdf.rect(M, Y, W - 2 * M, 18, 'S');
                
                setText(TEXT_SECONDARY);
                pdf.setFontSize(9);
                pdf.text('Most Produced Category', M + 5, Y + 8);
                
                setText(YELLOW);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(data.mostProducedText, M + 5, Y + 14);
                
                addFooter();
                
                // Save
                const fn = `Production_Report_${data.date.toISOString().split('T')[0]}.pdf`;
                pdf.save(fn);
                
                document.body.removeChild(overlay);
                
                setTimeout(() => {
                    alert('‚úÖ Professional PDF report generated!\n\n' + 
                          '6 pages with dark theme matching your dashboard.');
                }, 200);
                
            } catch (err) {
                console.error('PDF error:', err);
                document.body.removeChild(overlay);
                alert('‚ùå Error generating PDF: ' + err.message);
            }
        }
        
        function generateDailyTrendCharts(selectedDate) {
            const endDate = new Date(selectedDate);
            endDate.setHours(23, 59, 59, 999);
            
            const startDate = new Date(selectedDate);
            startDate.setDate(startDate.getDate() - 29); // Last 30 days
            startDate.setHours(0, 0, 0, 0);

            // Data structures for trends
            const dailyData = {};
            const dates = [];
            
            // Initialize dates array
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = d.toISOString().split('T')[0];
                dates.push(dateKey);
                dailyData[dateKey] = {
                    weight: 0,
                    entries: 0,
                    products: new Set(),
                    fillingHours: 0,
                    kpiScore: 0
                };
            }

            // Process production data
            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const dateKey = rowDate.toISOString().split('T')[0];
                    if (dailyData[dateKey]) {
                        const weight = parseWeight(row[3]);
                        dailyData[dateKey].weight += weight;
                        dailyData[dateKey].entries++;
                    }
                }
            });

            // Process filling data
            allFillingData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const dateKey = rowDate.toISOString().split('T')[0];
                    if (dailyData[dateKey]) {
                        const product = row[1];
                        const batch = row[2];
                        if (product) {
                            dailyData[dateKey].products.add(`${product}|${batch}`);
                        }

                        const startTime = row[9];
                        const endTime = row[10];
                        if (startTime && endTime) {
                            dailyData[dateKey].fillingHours += calculateHours(startTime, endTime);
                        }
                    }
                }
            });

            // Calculate KPI for each day
            const targetWeight = 30000;
            const targetProducts = 15;
            const targetHours = 8;

            dates.forEach(dateKey => {
                const data = dailyData[dateKey];
                const productCount = data.products.size;
                
                const weightScore = Math.min(100, (data.weight / targetWeight) * 100);
                const productScore = Math.min(100, (productCount / targetProducts) * 100);
                const fillingScore = Math.min(100, (data.fillingHours / targetHours) * 100);
                
                data.kpiScore = (weightScore * 0.4 + productScore * 0.3 + fillingScore * 0.3);
            });

            // Prepare data arrays for charts
            const labels = dates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const kpiScores = dates.map(d => dailyData[d].kpiScore.toFixed(1));
            const productCounts = dates.map(d => dailyData[d].products.size);
            const weights = dates.map(d => dailyData[d].weight);
            const hours = dates.map(d => dailyData[d].fillingHours.toFixed(1));

            // Generate charts
            generateTrendChart('kpi-trend-chart', 'KPI Score', labels, kpiScores, '#00ff88', 100);
            generateTrendChart('products-trend-chart', 'Products Filled', labels, productCounts, '#00b4ff');
            generateTrendChart('weight-trend-chart', 'Weight (KG)', labels, weights, '#ffd93d');
            generateTrendChart('hours-trend-chart', 'Filling Hours', labels, hours, '#ff4757');
        }

        function generateTrendChart(canvasId, label, labels, data, color, maxY) {
            const ctx = document.getElementById(canvasId);
            destroyChart(canvasId);

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: `${color}33`, // 20% opacity
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: color,
                        pointBorderColor: '#0a0e17',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...getChartOptions(),
                    scales: {
                        ...getChartOptions().scales,
                        y: {
                            ...getChartOptions().scales.y,
                            beginAtZero: true,
                            max: maxY || undefined
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1f2e',
                            titleColor: '#e4e8f0',
                            bodyColor: '#e4e8f0',
                            borderColor: color,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false
                        }
                    }
                }
            };

            chartInstances[canvasId] = new Chart(ctx, config);
        }

        function getMostProducedCategory(categories) {
            let maxCat = '';
            let maxWeight = 0;
            Object.entries(categories).forEach(([cat, weight]) => {
                if (weight > maxWeight) {
                    maxWeight = weight;
                    maxCat = cat;
                }
            });
            return maxCat ? `${maxCat} (${formatNumber(maxWeight)} KG)` : 'N/A';
        }

        function generateDailyCategoryCharts(categories) {
            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            // Pie Chart
            const pieCtx = document.getElementById('daily-category-pie');
            destroyChart('daily-category-pie');
            
            chartInstances['daily-category-pie'] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('daily-category-bar');
            destroyChart('daily-category-bar');
            
            chartInstances['daily-category-bar'] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // Helper function to create equipment usage chart
        function generateEquipmentUsageChart(mixers, grinders) {
            const ctx = document.getElementById('daily-equipment-chart');
            if (!ctx) return;

            const mixerData = Object.values(mixers);
            const grinderData = Object.values(grinders);
            const mixerLabels = Object.keys(mixers);
            const grinderLabels = Object.keys(grinders);

            destroyChart('daily-equipment-chart');
            
            chartInstances['daily-equipment-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [...mixerLabels, ...grinderLabels],
                    datasets: [{
                        label: 'Sessions',
                        data: [...mixerData, ...grinderData],
                        backgroundColor: [...mixerData.map(() => '#00ff88'), ...grinderData.map(() => '#00b4ff')],
                        borderRadius: 6
                    }]
                },
                options: {
                    ...getChartOptions(),
                    indexAxis: 'y'
                }
            });
        }

        // PAGE 4: Product Analysis
        function analyzeProduct() {
            const productName = document.getElementById('product-name').value.trim();
            const startDate = document.getElementById('product-start-date').valueAsDate;
            const endDate = document.getElementById('product-end-date').valueAsDate;

            if (!productName || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
            }

            const normalizedSearch = normalizeProductName(productName);
            let totalWeight = 0;
            let batchCount = 0;
            const dailyWeights = {};

            allProductionData.slice(1).forEach(row => {
                if (!row[0] || !row[1]) return;
                
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const rowProduct = normalizeProductName(row[1]);
                    
                    if (rowProduct === normalizedSearch) {
                        const weight = parseWeight(row[3]);
                        totalWeight += weight;
                        batchCount++;

                        const dateKey = rowDate.toISOString().split('T')[0];
                        dailyWeights[dateKey] = (dailyWeights[dateKey] || 0) + weight;
                    }
                }
            });

            const avgBatch = batchCount > 0 ? totalWeight / batchCount : 0;

            document.getElementById('product-total-weight').textContent = formatNumber(totalWeight) + ' KG';
            document.getElementById('product-total-batches').textContent = batchCount;
            document.getElementById('product-avg-batch').textContent = formatNumber(avgBatch.toFixed(0)) + ' KG';

            updateProductTimelineChart(dailyWeights);
        }

        function updateProductTimelineChart(dailyWeights) {
            const ctx = document.getElementById('product-timeline-chart');
            
            const dates = Object.keys(dailyWeights).sort();
            const values = dates.map(date => dailyWeights[date]);
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            destroyChart('product-timeline-chart');

            chartInstances['product-timeline-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // PAGE 5: Auto Reports
        function applyQuickSelect() {
            const select = document.getElementById('quick-select-range');
            const value = select.value;
            const today = new Date();
            
            let startDate, endDate;
            
            switch(value) {
                case 'this-week':
                    startDate = getWeekStart(today);
                    endDate = getWeekEnd(startDate);
                    break;
                case 'last-week':
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(lastWeekEnd.getDate() - today.getDay());
                    lastWeekEnd.setDate(lastWeekEnd.getDate() - 1);
                    startDate = getWeekStart(lastWeekEnd);
                    endDate = getWeekEnd(startDate);
                    break;
                case 'this-month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'last-7-days':
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 6);
                    break;
                case 'last-30-days':
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 29);
                    break;
                case 'this-quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'this-year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                default:
                    return;
            }
            
            document.getElementById('custom-report-start').valueAsDate = startDate;
            document.getElementById('custom-report-end').valueAsDate = endDate;
        }

        function generateCustomReport() {
            const startDate = document.getElementById('custom-report-start').valueAsDate;
            const endDate = document.getElementById('custom-report-end').valueAsDate;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            // Get data for the custom range
            const customData = getDataForRange(startDate, endDate);
            
            // Calculate metrics
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const avgDaily = customData.totalKilos / daysDiff;
            
            // Update KPI cards
            document.getElementById('custom-total').textContent = formatNumber(customData.totalKilos) + ' KG';
            document.getElementById('custom-products').textContent = Object.keys(customData.products).length;
            document.getElementById('custom-avg').textContent = formatNumber(avgDaily.toFixed(0)) + ' KG/day';
            document.getElementById('custom-period').textContent = 
                startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' +
                endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Show section
            document.getElementById('custom-report-section').style.display = 'block';
            
            // Generate daily production chart
            updateChart('custom-period-chart', customData.dailyHistory, 'bar');
            
            // Generate category charts
            updateCustomCategoryCharts(customData.categories);
            
            // Generate top products table
            updateCustomProductsTable(customData.products, customData.totalKilos);
            
            // Scroll to results
            document.getElementById('custom-report-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateCustomCategoryCharts(categories) {
            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            // Pie Chart
            const pieCtx = document.getElementById('custom-category-pie');
            destroyChart('custom-category-pie');
            
            chartInstances['custom-category-pie'] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('custom-category-bar');
            destroyChart('custom-category-bar');
            
            chartInstances['custom-category-bar'] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        function updateCustomProductsTable(products, totalWeight) {
            const tbody = document.getElementById('custom-products-tbody');
            
            // Convert to array and sort
            const sortedProducts = Object.entries(products)
                .map(([name, data]) => ({
                    name: name,
                    weight: data.weight || data,
                    batches: data.batches || 1
                }))
                .sort((a, b) => b.weight - a.weight)
                .slice(0, 20);
            
            if (sortedProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No data for this period</td></tr>';
                return;
            }
            
            tbody.innerHTML = sortedProducts.map((product, index) => {
                const percentage = ((product.weight / totalWeight) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${product.name}</td>
                        <td>${formatNumber(product.weight)}</td>
                        <td>${percentage}%</td>
                        <td>${product.batches}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateAutoReports() {
            const today = new Date();
            
            const weekStart = getWeekStart(today);
            const weekEnd = getWeekEnd(weekStart);
            const weekData = getDataForRange(weekStart, weekEnd);
            
            document.getElementById('week-total').textContent = formatNumber(weekData.totalKilos) + ' KG';
            document.getElementById('week-products').textContent = Object.keys(weekData.products).length;
            document.getElementById('week-avg').textContent = formatNumber((weekData.totalKilos / 7).toFixed(0)) + ' KG';
            document.getElementById('week-dates').textContent = 
                weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' +
                weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            updateChart('weekly-chart', weekData.dailyHistory, 'line');

            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const monthData = getDataForRange(monthStart, monthEnd);
            
            document.getElementById('month-total').textContent = formatNumber(monthData.totalKilos) + ' KG';
            document.getElementById('month-products').textContent = Object.keys(monthData.products).length;
            const daysInMonth = monthEnd.getDate();
            document.getElementById('month-avg').textContent = formatNumber((monthData.totalKilos / daysInMonth).toFixed(0)) + ' KG';
            document.getElementById('month-name').textContent = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            updateChart('monthly-chart', monthData.dailyHistory, 'bar');
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1) - day;
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getWeekEnd(weekStart) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + 6);
            d.setHours(23, 59, 59, 999);
            return d;
        }

        function getDataForRange(startDate, endDate) {
            console.log(`üìä Analyzing range: ${startDate.toDateString()} to ${endDate.toDateString()}`);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            const data = {
                totalKilos: 0,
                entries: 0,
                products: {},
                categories: {},
                dailyHistory: {},
                rowDetails: [] // Track each matched row
            };

            let matchedRows = 0;

            allProductionData.slice(1).forEach((row, idx) => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const product = row[1];
                    const batch = row[2];
                    const weight = parseWeight(row[3]);
                    
                    matchedRows++;
                    
                    // Log each matched row
                    console.log(`  ‚úÖ Row ${idx + 2}: ${rowDate.toLocaleDateString()} | ${product} | Batch: ${batch} | ${weight} KG`);
                    
                    data.totalKilos += weight;
                    data.entries++;
                    
                    // Store row details
                    data.rowDetails.push({
                        rowNum: idx + 2,
                        date: rowDate.toLocaleDateString(),
                        product: product,
                        batch: batch,
                        weight: weight
                    });

                    const category = detectCategory(product);
                    data.categories[category] = (data.categories[category] || 0) + weight;
                    
                    // Track product weight and batches
                    if (!data.products[product]) {
                        data.products[product] = { weight: 0, batches: 0 };
                    }
                    data.products[product].weight += weight;
                    data.products[product].batches++;

                    const dateKey = rowDate.toISOString().split('T')[0];
                    data.dailyHistory[dateKey] = (data.dailyHistory[dateKey] || 0) + weight;
                }
            });

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`‚úÖ TOTAL MATCHED: ${matchedRows} rows`);
            console.log(`üí∞ TOTAL WEIGHT: ${data.totalKilos.toFixed(2)} KG`);
            console.log('üìÖ Daily breakdown:');
            Object.keys(data.dailyHistory).sort().forEach(dateKey => {
                const weight = data.dailyHistory[dateKey];
                const date = new Date(dateKey);
                console.log(`   ${date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}: ${weight.toFixed(0)} KG`);
            });
            
            // Check for potential duplicates
            const duplicates = findDuplicates(data.rowDetails);
            if (duplicates.length > 0) {
                console.warn('‚ö†Ô∏è POTENTIAL DUPLICATES FOUND:');
                duplicates.forEach(dup => {
                    console.warn(`   Rows ${dup.rows.join(', ')}: ${dup.product} (Batch: ${dup.batch}) - ${dup.count} times x ${dup.weight} KG = ${dup.count * dup.weight} KG`);
                });
            }
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            return data;
        }

        function findDuplicates(rowDetails) {
            const seen = {};
            const duplicates = [];
            
            rowDetails.forEach(row => {
                const key = `${row.date}|${row.product}|${row.batch}`;
                if (!seen[key]) {
                    seen[key] = {
                        product: row.product,
                        batch: row.batch,
                        weight: row.weight,
                        rows: [row.rowNum],
                        count: 1
                    };
                } else {
                    seen[key].rows.push(row.rowNum);
                    seen[key].count++;
                }
            });
            
            // Find entries that appear more than once
            Object.values(seen).forEach(entry => {
                if (entry.count > 1) {
                    duplicates.push(entry);
                }
            });
            
            return duplicates;
        }

        // Manual verification function - run this in console to check Excel totals
        window.verifyExcelTotal = function(month, year) {
            console.log(`üîç MANUAL VERIFICATION: ${month}/${year}`);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            let total = 0;
            let count = 0;
            const entries = [];
            
            allProductionData.slice(1).forEach((row, idx) => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;
                
                if (date.getMonth() + 1 === month && date.getFullYear() === year) {
                    const weight = parseWeight(row[3]);
                    total += weight;
                    count++;
                    entries.push({
                        row: idx + 2,
                        date: date.toLocaleDateString(),
                        product: row[1],
                        batch: row[2],
                        weight: weight
                    });
                }
            });
            
            console.log(`Found ${count} entries`);
            console.log(`Total: ${total.toFixed(2)} KG`);
            console.log('\nAll entries:');
            entries.forEach(e => {
                console.log(`  Row ${e.row}: ${e.date} | ${e.product} | Batch ${e.batch} | ${e.weight} KG`);
            });
            
            return { total, count, entries };
        };
        
        console.log('üí° TIP: Run verifyExcelTotal(1, 2026) in console to manually verify January 2026 total');

        // Export batch data as JSON file for backup
        window.exportBatchData = function() {
            const dataStr = JSON.stringify(allBatchData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `batch-details-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exported ${Object.keys(allBatchData).length} batch details to JSON file!`);
            console.log('‚úÖ Batch data exported');
        };

        // Import batch data from JSON file
        window.importBatchData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Merge with existing data
                    Object.assign(allBatchData, imported);
                    
                    // Save to localStorage
                    localStorage.setItem('batchDetailsData', JSON.stringify(allBatchData));
                    
                    alert(`‚úÖ Successfully imported ${Object.keys(imported).length} batch details!\n\nTotal batch details: ${Object.keys(allBatchData).length}`);
                    console.log('‚úÖ Batch data imported and merged');
                } catch (error) {
                    alert('‚ùå Error importing file: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset input so same file can be imported again
            event.target.value = '';
        };
        
        console.log('üí° TIP: Use exportBatchData() to backup your batch details');

        function updateChart(chartId, dailyHistory, type) {
            const ctx = document.getElementById(chartId);
            
            const dates = Object.keys(dailyHistory).sort();
            const values = dates.map(date => dailyHistory[date]);
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            destroyChart(chartId);

            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        borderColor: '#00ff88',
                        backgroundColor: type === 'line' ? 'rgba(0, 255, 136, 0.1)' : '#00b4ff',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: type === 'line',
                        borderRadius: type === 'bar' ? 6 : 0
                    }]
                },
                options: getChartOptions()
            };

            chartInstances[chartId] = new Chart(ctx, config);
        }

        // PAGE 6: Category Reports
        function generateCategoryReports() {
            const today = new Date();
            
            const weekStart = getWeekStart(today);
            const weekEnd = getWeekEnd(weekStart);
            const weekData = getDataForRange(weekStart, weekEnd);
            
            updateCategoryCharts('week', weekData.categories);

            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const monthData = getDataForRange(monthStart, monthEnd);
            
            updateCategoryCharts('month', monthData.categories);
            updateCategoryTable(weekData.categories, monthData.categories);
        }

        function updateCategoryCharts(period, categories) {
            const pieCtx = document.getElementById(`${period}-category-pie`);
            const barCtx = document.getElementById(`${period}-category-bar`);

            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            destroyChart(`${period}-category-pie`);
            destroyChart(`${period}-category-bar`);

            chartInstances[`${period}-category-pie`] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            chartInstances[`${period}-category-bar`] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        function updateCategoryTable(weekCategories, monthCategories) {
            const allCategories = new Set([
                ...Object.keys(weekCategories),
                ...Object.keys(monthCategories)
            ]);

            const weekTotal = Object.values(weekCategories).reduce((a, b) => a + b, 0);
            const monthTotal = Object.values(monthCategories).reduce((a, b) => a + b, 0);

            const tbody = document.getElementById('category-tbody');
            tbody.innerHTML = Array.from(allCategories).map(cat => {
                const weekWeight = weekCategories[cat] || 0;
                const monthWeight = monthCategories[cat] || 0;
                const weekPct = weekTotal > 0 ? ((weekWeight / weekTotal) * 100).toFixed(1) : '0';
                const monthPct = monthTotal > 0 ? ((monthWeight / monthTotal) * 100).toFixed(1) : '0';

                return `
                    <tr>
                        <td>${cat}</td>
                        <td>${formatNumber(weekWeight)}</td>
                        <td>${formatNumber(monthWeight)}</td>
                        <td>${weekPct}%</td>
                        <td>${monthPct}%</td>
                    </tr>
                `;
            }).join('');
        }

        // PAGE 7: Category Range
        function analyzeCategoryRange() {
            const startDate = document.getElementById('category-start-date').valueAsDate;
            const endDate = document.getElementById('category-end-date').valueAsDate;

            if (!startDate || !endDate) {
                alert('Please select both dates');
                return;
            }

            const categories = {};
            const categoryEntries = {};
            let totalWeight = 0;

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const product = row[1];
                    const weight = parseWeight(row[3]);
                    
                    const category = detectCategory(product);
                    categories[category] = (categories[category] || 0) + weight;
                    categoryEntries[category] = (categoryEntries[category] || 0) + 1;
                    totalWeight += weight;
                }
            });

            updateRangeCategoryCharts(categories);

            const tbody = document.getElementById('category-range-tbody');
            tbody.innerHTML = Object.keys(categories).map(cat => {
                const weight = categories[cat];
                const pct = totalWeight > 0 ? ((weight / totalWeight) * 100).toFixed(1) : '0';
                const entries = categoryEntries[cat];

                return `
                    <tr>
                        <td>${cat}</td>
                        <td>${formatNumber(weight)}</td>
                        <td>${pct}%</td>
                        <td>${entries}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateRangeCategoryCharts(categories) {
            const pieCtx = document.getElementById('range-category-pie');
            const barCtx = document.getElementById('range-category-bar');

            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            destroyChart('range-category-pie');
            destroyChart('range-category-bar');

            chartInstances['range-category-pie'] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            chartInstances['range-category-bar'] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // Utility Functions
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            // If it's already a Date object
            if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                return dateValue;
            }
            
            // Handle Google Sheets serial date numbers
            if (typeof dateValue === 'number') {
                // Google Sheets epoch: December 30, 1899
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                if (!isNaN(date.getTime())) {
                    console.log(`üìÖ Serial number ${dateValue} -> ${date.toDateString()}`);
                    return date;
                }
            }
            
            const dateStr = dateValue.toString().trim();
            
            // Parse dd/m/yy or dd/mm/yy format (e.g., 27/1/26 = Day 27, Month 1 (Jan), Year 2026)
            const dmyMatch = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if (dmyMatch) {
                let day = parseInt(dmyMatch[1]);
                let month = parseInt(dmyMatch[2]) - 1; // Month is MIDDLE number (1=Jan, 2=Feb, etc.)
                let year = parseInt(dmyMatch[3]);
                
                // Handle 2-digit years
                if (year < 100) {
                    // 26 -> 2026, 25 -> 2025
                    year += 2000;
                }
                
                // Create the date
                const date = new Date(year, month, day);
                
                // CRITICAL: Validate the date is what we expect
                // This prevents JavaScript from auto-correcting invalid dates
                // (e.g., Feb 30 becomes Mar 2)
                if (date.getFullYear() === year && 
                    date.getMonth() === month && 
                    date.getDate() === day) {
                    console.log(`‚úÖ Parsed "${dateStr}" -> ${date.toDateString()} (Day=${day}, Month=${month+1}, Year=${year})`);
                    return date;
                } else {
                    console.warn(`‚ö†Ô∏è Date mismatch: "${dateStr}" -> Expected ${year}-${month+1}-${day} but got ${date.toDateString()}`);
                    return null;
                }
            }
            
            // Try native Date parsing as last resort
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
                console.log(`üìÖ Native parse: "${dateValue}" -> ${date.toDateString()}`);
                return date;
            }
            
            console.warn(`‚ùå Could not parse date: "${dateValue}"`);
            return null;
        }

        function parseWeight(weightValue) {
            if (!weightValue) return 0;
            const cleanValue = weightValue.toString().replace(/[^\d.]/g, '');
            const weight = parseFloat(cleanValue);
            return isNaN(weight) ? 0 : weight;
        }

        function formatDate(dateValue) {
            const date = parseDate(dateValue);
            if (!date) return '-';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(timeValue) {
            if (!timeValue) return '-';
            if (typeof timeValue === 'string' && timeValue.includes(':')) return timeValue;
            if (timeValue instanceof Date) {
                return timeValue.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }
            return timeValue;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        function detectCategory(product) {
            if (!product) return 'OTHER';
            const name = product.toString().toUpperCase();
            
            if (/\bBASE\b/.test(name)) return 'BASE';
            if (/\bNC\b/.test(name)) return 'NC';
            if (/\bSYNTHETIC\b/.test(name)) return 'SYNTHETIC';
            if (/\bENAMEL\b/.test(name)) return 'ENAMEL';
            if (/\bPU\b/.test(name)) return 'PU';
            if (/\bEPOXY\b/.test(name)) return 'EPOXY';
            if (/\bHARDENER\b/.test(name)) return 'HARDENER';
            
            return 'OTHER';
        }

        function normalizeProductName(name) {
            if (!name) return '';
            return name.toString().toUpperCase().trim().split(/\s+/).filter(w => w.length > 0).sort().join(' ');
        }

        function calculateHours(startTime, endTime) {
            try {
                let start, end;
                
                if (typeof startTime === 'number') {
                    start = startTime * 24;
                } else if (typeof startTime === 'string') {
                    const parts = startTime.match(/(\d+):(\d+)/);
                    if (parts) {
                        start = parseInt(parts[1]) + parseInt(parts[2]) / 60;
                    } else return 0;
                } else if (startTime instanceof Date) {
                    start = startTime.getHours() + startTime.getMinutes() / 60;
                } else return 0;
                
                if (typeof endTime === 'number') {
                    end = endTime * 24;
                } else if (typeof endTime === 'string') {
                    const parts = endTime.match(/(\d+):(\d+)/);
                    if (parts) {
                        end = parseInt(parts[1]) + parseInt(parts[2]) / 60;
                    } else return 0;
                } else if (endTime instanceof Date) {
                    end = endTime.getHours() + endTime.getMinutes() / 60;
                } else return 0;
                
                let diff = end - start;
                if (diff < 0) diff += 24;
                return diff;
            } catch (err) {
                return 0;
            }
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { color: '#2a3142', drawBorder: false },
                        ticks: { color: '#8892a6', font: { size: 10, family: 'JetBrains Mono' } }
                    },
                    y: {
                        grid: { color: '#2a3142', drawBorder: false },
                        ticks: { color: '#8892a6', font: { size: 10, family: 'JetBrains Mono' } }
                    }
                }
            };
        }

        // Initialize
        try {
            console.log('Starting initialization...');
            init();
            console.log('Initialization successful!');
        } catch (error) {
            console.error('FATAL ERROR during initialization:', error);
            document.body.innerHTML = `
                <div style="padding: 40px; color: #ff4757; font-family: monospace;">
                    <h1>‚ùå Dashboard Error</h1>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Stack:</strong></p>
                    <pre style="background: #1a1f2e; padding: 20px; border-radius: 8px; overflow: auto;">${error.stack}</pre>
                    <button onclick="location.reload()" style="background: #00ff88; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px;">Reload Page</button>
                </div>
            `;
        }
    </script>
    
    <!-- Load PDF libraries asynchronously (non-blocking) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
</body>
</html>