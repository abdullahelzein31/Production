<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #141821;
            --bg-card: #1a1f2e;
            --border-color: #2a3142;
            --text-primary: #e4e8f0;
            --text-secondary: #8892a6;
            --accent-green: #00ff88;
            --accent-blue: #00b4ff;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --accent-purple: #a55eea;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            color: var(--bg-primary);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* Sidebar Navigation (YouTube Style) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: var(--sidebar-width);
            height: calc(100vh - 70px);
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
            z-index: 900;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(0, 180, 255, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: var(--accent-green);
            color: var(--accent-green);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 15px 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .col-3 { grid-column: span 3; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-8 { grid-column: span 8; }
        .col-12 { grid-column: span 12; }

        /* KPI Cards */
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .kpi-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .kpi-change {
            font-size: 12px;
            color: var(--accent-green);
            margin-top: 8px;
        }

        /* Date Navigator */
        .date-navigator {
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .date-display {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 700;
            flex: 1;
            text-align: center;
            color: var(--accent-green);
        }

        .btn-nav {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-nav:hover {
            border-color: var(--accent-blue);
            background: rgba(0, 180, 255, 0.1);
        }

        /* Improved Tables */
        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .table-title {
            background: var(--bg-secondary);
            padding: 20px 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border-color);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--bg-secondary);
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-primary);
        }

        .table tr:hover {
            background: rgba(0, 180, 255, 0.05);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            height: 400px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: rgba(0, 255, 136, 0.15); color: var(--accent-green); }
        .badge.warning { background: rgba(255, 217, 61, 0.15); color: var(--accent-yellow); }
        .badge.error { background: rgba(255, 71, 87, 0.15); color: var(--accent-red); }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Setup Panel */
        .setup-panel {
            background: var(--bg-card);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 40px;
            margin: 100px auto;
            max-width: 800px;
        }

        .setup-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-yellow);
        }

        .setup-instructions {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-blue);
            padding: 16px;
            margin: 20px 0;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        @media (max-width: 1200px) {
            .col-3, .col-4 { grid-column: span 6; }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .col-3, .col-4, .col-6, .col-8 {
                grid-column: span 12;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">PRODUCTION ANALYTICS</div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="status-text">LIVE</span>
            </div>
            <div class="status-indicator">
                <span id="last-update">--:--</span>
            </div>
            <button class="btn" onclick="loadAllData()">REFRESH</button>
        </div>
    </div>

    <!-- Sidebar Navigation (YouTube Style) -->
    <div class="sidebar">
        <div class="nav-item active" onclick="showPage('daily-view')">
            <div class="nav-icon">üìÖ</div>
            <div>Daily Production</div>
        </div>
        <div class="nav-item" onclick="showPage('equipment-analysis')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>Equipment Analysis</div>
        </div>
        <div class="nav-item" onclick="showPage('daily-report')">
            <div class="nav-icon">üìä</div>
            <div>Daily Report</div>
        </div>
        <div class="nav-item" onclick="showPage('product-search')">
            <div class="nav-icon">üîç</div>
            <div>Product Analysis</div>
        </div>
        
        <div class="nav-divider"></div>
        
        <div class="nav-item" onclick="showPage('auto-reports')">
            <div class="nav-icon">üìà</div>
            <div>Weekly/Monthly Reports</div>
        </div>
        <div class="nav-item" onclick="showPage('category-reports')">
            <div class="nav-icon">üìë</div>
            <div>Category Reports</div>
        </div>
        <div class="nav-item" onclick="showPage('category-range')">
            <div class="nav-icon">üìÜ</div>
            <div>Category by Date Range</div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div id="setup-container"></div>

        <div id="main-dashboard" style="display: none;">
            
            <!-- PAGE 1: Daily Production View -->
            <div id="daily-view" class="page-content active">
                <h1 class="page-title">Daily Production View</h1>
                
                <div class="date-navigator">
                    <button class="btn-nav" onclick="changeDate(-1)">‚óÄ Previous Day</button>
                    <div class="date-display" id="current-date-display">Today</div>
                    <button class="btn-nav" onclick="changeDate(1)">Next Day ‚ñ∂</button>
                    <button class="btn-nav" onclick="setToday()">Today</button>
                </div>

                <!-- Summary KPIs -->
                <div class="grid">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Weight Produced (All Time)</div>
                        <div class="kpi-value" id="total-weight-alltime">-</div>
                        <div class="kpi-change" id="total-entries">-- entries</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Products Filled (All Time)</div>
                        <div class="kpi-value" id="total-products-filled">-</div>
                        <div class="kpi-change">unique batches</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Today's Production</div>
                        <div class="kpi-value" id="today-production">-</div>
                        <div class="kpi-change" id="today-entries">-- entries</div>
                    </div>
                </div>

                <!-- Production Schedule Table -->
                <div class="data-table">
                    <div class="table-title">PRODUCTION SCHEDULE</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Product Name</th>
                                    <th>Batch</th>
                                    <th>Weight</th>
                                    <th>Actual Weight</th>
                                    <th>% Yield</th>
                                    <th>Yield Verdict</th>
                                    <th>Vessel</th>
                                    <th>Suggested Mixers</th>
                                    <th>Suggested Grinders</th>
                                    <th>Equipment</th>
                                </tr>
                            </thead>
                            <tbody id="production-tbody">
                                <tr><td colspan="11" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Filling Operations Table -->
                <div class="data-table">
                    <div class="table-title">FILLING OPERATIONS</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Product Name</th>
                                    <th>Batch</th>
                                    <th>Filling Type</th>
                                    <th>Package Type</th>
                                    <th>Quantity</th>
                                    <th>Operator</th>
                                    <th>Remarks</th>
                                    <th>Time per Package</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                </tr>
                            </thead>
                            <tbody id="filling-tbody">
                                <tr><td colspan="11" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: Equipment Analysis -->
            <div id="equipment-analysis" class="page-content">
                <h1 class="page-title">Equipment Usage Analysis</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="equip-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="equip-end-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Equipment Code</label>
                            <input type="text" id="equip-code" class="form-input" placeholder="e.g., MX05 or GR01">
                        </div>
                        <button class="btn" onclick="runEquipmentAnalysis()">ANALYZE</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Analysis Results</h3>
                    <div id="equipment-results">
                        <p style="color: var(--text-secondary);">Enter parameters above and click "ANALYZE"</p>
                    </div>
                </div>

                <div class="grid" style="margin-top: 20px;">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Equipment Usage by Category</div>
                            <canvas id="equipment-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: Daily Report -->
            <div id="daily-report" class="page-content">
                <h1 class="page-title">Daily Production Report</h1>
                
                <div class="grid">
                    <div class="card col-6">
                        <div class="form-group">
                            <label class="form-label">Select Report Date</label>
                            <input type="date" id="daily-report-date" class="form-input">
                        </div>
                        <button class="btn" onclick="generateDailyReport()">GENERATE REPORT</button>
                    </div>
                </div>

                <div id="daily-report-content"></div>
            </div>

            <!-- PAGE 4: Product Search -->
            <div id="product-search" class="page-content">
                <h1 class="page-title">Product Analysis</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Product Name</label>
                            <input type="text" id="product-name" class="form-input" placeholder="Enter product name">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="product-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="product-end-date" class="form-input">
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="analyzeProduct()">ANALYZE PRODUCT</button>

                <div class="grid" style="margin-top: 25px;">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Weight</div>
                        <div class="kpi-value" id="product-total-weight">-</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Total Batches</div>
                        <div class="kpi-value" id="product-total-batches">-</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Average Batch Size</div>
                        <div class="kpi-value" id="product-avg-batch">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production Weight</div>
                            <canvas id="product-timeline-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 5: Auto Reports -->
            <div id="auto-reports" class="page-content">
                <h1 class="page-title">Weekly & Monthly Reports</h1>
                
                <h2 style="margin: 30px 0 20px; color: var(--accent-green); font-size: 20px;">This Week</h2>
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Week Total</div>
                        <div class="kpi-value" id="week-total">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products</div>
                        <div class="kpi-value" id="week-products">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Daily Average</div>
                        <div class="kpi-value" id="week-avg">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Week Range</div>
                        <div class="kpi-value" id="week-dates" style="font-size: 14px;">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production This Week</div>
                            <canvas id="weekly-chart"></canvas>
                        </div>
                    </div>
                </div>

                <h2 style="margin: 30px 0 20px; color: var(--accent-blue); font-size: 20px;">This Month</h2>
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Month Total</div>
                        <div class="kpi-value" id="month-total">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products</div>
                        <div class="kpi-value" id="month-products">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Daily Average</div>
                        <div class="kpi-value" id="month-avg">-</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Current Month</div>
                        <div class="kpi-value" id="month-name" style="font-size: 16px;">-</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-title">Daily Production This Month</div>
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 6: Category Reports -->
            <div id="category-reports" class="page-content">
                <h1 class="page-title">Category Production Reports</h1>
                
                <h2 style="margin: 30px 0 20px; color: var(--accent-green); font-size: 20px;">This Week by Category</h2>
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Weekly Category Breakdown</div>
                            <canvas id="week-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Weekly Category Weights</div>
                            <canvas id="week-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <h2 style="margin: 30px 0 20px; color: var(--accent-blue); font-size: 20px;">This Month by Category</h2>
                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Monthly Category Breakdown</div>
                            <canvas id="month-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Monthly Category Weights</div>
                            <canvas id="month-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-title">CATEGORY COMPARISON</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>This Week (KG)</th>
                                    <th>This Month (KG)</th>
                                    <th>% of Week</th>
                                    <th>% of Month</th>
                                </tr>
                            </thead>
                            <tbody id="category-tbody">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAGE 7: Category by Date Range -->
            <div id="category-range" class="page-content">
                <h1 class="page-title">Category Production by Date Range</h1>
                
                <div class="grid">
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="category-start-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="category-end-date" class="form-input">
                        </div>
                    </div>
                    <div class="card col-4">
                        <button class="btn" onclick="analyzeCategoryRange()" style="margin-top: 28px;">GENERATE REPORT</button>
                    </div>
                </div>

                <div class="grid">
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Distribution</div>
                            <canvas id="range-category-pie"></canvas>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="chart-container">
                            <div class="chart-title">Category Weights</div>
                            <canvas id="range-category-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-title">CATEGORY BREAKDOWN</div>
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Weight (KG)</th>
                                    <th>Percentage</th>
                                    <th>Number of Entries</th>
                                </tr>
                            </thead>
                            <tbody id="category-range-tbody">
                                <tr><td colspan="4" class="loading">Select date range and click "GENERATE REPORT"</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Global variables
        let SHEET_ID = '';
        let API_KEY = '';
        let currentViewDate = new Date();
        let allProductionData = [];
        let allFillingData = [];
        let chartInstances = {};

        // Initialize
        function init() {
            SHEET_ID = localStorage.getItem('sheetId') || '';
            API_KEY = localStorage.getItem('apiKey') || '';

            if (!SHEET_ID || !API_KEY) {
                showSetupPanel();
            } else {
                document.getElementById('setup-container').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                loadAllData();
                setInterval(loadAllData, 300000);
            }

            const today = new Date();
            document.getElementById('daily-report-date').valueAsDate = today;
            document.getElementById('equip-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('equip-end-date').valueAsDate = today;
            document.getElementById('product-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('product-end-date').valueAsDate = today;
            document.getElementById('category-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('category-end-date').valueAsDate = today;
        }

        function showSetupPanel() {
            document.getElementById('setup-container').innerHTML = `
                <div class="setup-panel">
                    <div class="setup-title">üìä Dashboard Setup</div>
                    <p style="color: var(--text-secondary); margin-bottom: 30px;">
                        Connect your Google Sheet to start viewing real-time production analytics.
                    </p>

                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">
                        Google Sheet ID
                    </label>
                    <input type="text" id="input-sheet-id" class="form-input" 
                           placeholder="1V_2Cv61m2WSgZYUpCPAHJYdD9t_UKMJ-" value="${SHEET_ID}">

                    <label style="display: block; margin-bottom: 8px; margin-top: 20px; color: var(--text-primary); font-weight: 600;">
                        Google Sheets API Key
                    </label>
                    <input type="text" id="input-api-key" class="form-input" placeholder="AIzaSy...">

                    <div class="setup-instructions">
                        <strong>How to get your credentials:</strong><br><br>
                        <strong>1. Sheet ID:</strong> Copy from your Google Sheet URL<br>
                        <code>https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit</code><br><br>
                        
                        <strong>2. API Key:</strong> Go to Google Cloud Console ‚Üí Enable Google Sheets API ‚Üí Create API Key<br>
                        <strong>3.</strong> Make your Sheet publicly viewable (Share ‚Üí Anyone with link can view)
                    </div>

                    <button class="btn" onclick="saveSetup()">CONNECT DASHBOARD</button>
                    <button class="btn-nav" onclick="testConnection()" style="margin-left: 10px;">TEST CONNECTION</button>
                </div>
            `;
        }

        function saveSetup() {
            const sheetId = document.getElementById('input-sheet-id').value.trim();
            const apiKey = document.getElementById('input-api-key').value.trim();

            if (!sheetId || !apiKey) {
                alert('Please fill in both fields');
                return;
            }

            localStorage.setItem('sheetId', sheetId);
            localStorage.setItem('apiKey', apiKey);
            
            SHEET_ID = sheetId;
            API_KEY = apiKey;

            init();
        }

        async function testConnection() {
            const sheetId = document.getElementById('input-sheet-id').value.trim();
            const apiKey = document.getElementById('input-api-key').value.trim();

            if (!sheetId || !apiKey) {
                alert('Please fill in both fields');
                return;
            }

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Production Schedule!A1:D10?key=${apiKey}`
                );
                
                if (response.ok) {
                    alert('‚úÖ Connection successful! Click "CONNECT DASHBOARD" to continue.');
                } else {
                    const error = await response.json();
                    alert('‚ùå Connection failed: ' + (error.error?.message || 'Unknown error'));
                }
            } catch (err) {
                alert('‚ùå Connection failed: ' + err.message);
            }
        }

        // Navigation
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            switch(pageId) {
                case 'daily-view':
                    updateDailyView();
                    break;
                case 'auto-reports':
                    generateAutoReports();
                    break;
                case 'category-reports':
                    generateCategoryReports();
                    break;
            }
        }

        // Data Loading
        async function loadAllData() {
            try {
                updateStatus('loading');
                console.log('üîÑ Loading data...');

                const [productionData, fillingData] = await Promise.all([
                    fetchSheetData('Production Schedule!A:K'),
                    fetchSheetData('Filling!A:K')
                ]);

                allProductionData = productionData;
                allFillingData = fillingData;

                console.log('‚úÖ Loaded:', productionData.length, 'production rows,', fillingData.length, 'filling rows');

                updateDailyView();
                updateGlobalMetrics();
                updateStatus('live');
                updateTimestamp();
            } catch (error) {
                console.error('‚ùå Error:', error);
                updateStatus('error');
                alert('Error loading data: ' + error.message);
            }
        }

        async function fetchSheetData(range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch ${range}`);
            }
            
            const data = await response.json();
            return data.values || [];
        }

        function updateStatus(status) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.querySelector('.status-dot');
            
            if (status === 'loading') {
                statusText.textContent = 'LOADING';
                statusDot.style.background = '#ffd93d';
            } else if (status === 'error') {
                statusText.textContent = 'ERROR';
                statusDot.style.background = '#ff4757';
            } else {
                statusText.textContent = 'LIVE';
                statusDot.style.background = '#00ff88';
            }
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
        }

        // Date Navigation
        function changeDate(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            updateDailyView();
        }

        function setToday() {
            currentViewDate = new Date();
            updateDailyView();
        }

        // Global Metrics (All-Time)
        function updateGlobalMetrics() {
            let totalWeight = 0;
            let totalEntries = 0;
            const uniqueProducts = new Set();

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const weight = parseWeight(row[3]);
                totalWeight += weight;
                totalEntries++;
            });

            allFillingData.slice(1).forEach(row => {
                if (!row[0] || !row[1]) return;
                const product = row[1];
                const batch = row[2];
                uniqueProducts.add(`${product}|${batch}`);
            });

            document.getElementById('total-weight-alltime').textContent = formatNumber(totalWeight) + ' KG';
            document.getElementById('total-entries').textContent = formatNumber(totalEntries) + ' entries';
            document.getElementById('total-products-filled').textContent = formatNumber(uniqueProducts.size);
        }

        // PAGE 1: Daily View
        function updateDailyView() {
            const dateStr = currentViewDate.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('current-date-display').textContent = dateStr;

            const targetDate = new Date(currentViewDate);
            targetDate.setHours(0, 0, 0, 0);

            // Production Schedule Table
            const productionRows = allProductionData.slice(1).filter(row => {
                if (!row[0]) return false;
                const date = parseDate(row[0]);
                if (!date) return false;
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                return rowDate.getTime() === targetDate.getTime();
            });

            let todayWeight = 0;
            const tbody = document.getElementById('production-tbody');
            if (productionRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">No production data for this date</td></tr>';
            } else {
                tbody.innerHTML = productionRows.map(row => {
                    todayWeight += parseWeight(row[3]);
                    return `
                        <tr>
                            <td>${formatDate(row[0])}</td>
                            <td>${row[1] || '-'}</td>
                            <td>${row[2] || '-'}</td>
                            <td>${row[3] || '-'}</td>
                            <td>${row[4] || '-'}</td>
                            <td>${row[5] || '-'}</td>
                            <td>${row[6] || '-'}</td>
                            <td>${row[7] || '-'}</td>
                            <td>${row[8] || '-'}</td>
                            <td>${row[9] || '-'}</td>
                            <td>${row[10] || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Filling Table
            const fillingRows = allFillingData.slice(1).filter(row => {
                if (!row[0]) return false;
                const date = parseDate(row[0]);
                if (!date) return false;
                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);
                return rowDate.getTime() === targetDate.getTime();
            });

            const fillingTbody = document.getElementById('filling-tbody');
            if (fillingRows.length === 0) {
                fillingTbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">No filling data for this date</td></tr>';
            } else {
                fillingTbody.innerHTML = fillingRows.map(row => `
                    <tr>
                        <td>${formatDate(row[0])}</td>
                        <td>${row[1] || '-'}</td>
                        <td>${row[2] || '-'}</td>
                        <td>${row[3] || '-'}</td>
                        <td>${row[4] || '-'}</td>
                        <td>${row[5] || '-'}</td>
                        <td>${row[6] || '-'}</td>
                        <td>${row[7] || '-'}</td>
                        <td>${row[8] || '-'}</td>
                        <td>${formatTime(row[9])}</td>
                        <td>${formatTime(row[10])}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('today-production').textContent = formatNumber(todayWeight) + ' KG';
            document.getElementById('today-entries').textContent = productionRows.length + ' entries';
        }

        // PAGE 2: Equipment Analysis
        function runEquipmentAnalysis() {
            const startDate = document.getElementById('equip-start-date').valueAsDate;
            const endDate = document.getElementById('equip-end-date').valueAsDate;
            const equipmentCode = document.getElementById('equip-code').value.trim().toUpperCase();

            if (!startDate || !endDate || !equipmentCode) {
                alert('Please fill in all fields');
                return;
            }

            const endDateInclusive = new Date(endDate);
            endDateInclusive.setHours(23, 59, 59, 999);

            const categories = ['ENAMEL', 'EPOXY', 'PU', 'NC', 'BASE', 'SYNTHETIC'];
            const categoryWeights = {};
            categories.forEach(cat => categoryWeights[cat] = 0);
            let uncategorizedWeight = 0;
            let usageCount = 0;
            let totalWeight = 0;

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(12, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDateInclusive) {
                    const productName = (row[1] || '').toString().toUpperCase();
                    const weight = parseWeight(row[3]);
                    const equipmentCell = (row[10] || '').toString().toUpperCase();

                    if (equipmentCell.includes(equipmentCode)) {
                        usageCount++;
                        totalWeight += weight;

                        let categoryFound = false;
                        for (let cat of categories) {
                            if (productName.includes(cat)) {
                                categoryWeights[cat] += weight;
                                categoryFound = true;
                                break;
                            }
                        }
                        if (!categoryFound) {
                            uncategorizedWeight += weight;
                        }
                    }
                }
            });

            let categoryBreakdown = '';
            categories.forEach(cat => {
                if (categoryWeights[cat] > 0) {
                    categoryBreakdown += `<br><strong>${cat}:</strong> ${formatNumber(categoryWeights[cat])} kg`;
                }
            });
            if (uncategorizedWeight > 0) {
                categoryBreakdown += `<br><strong>Other:</strong> ${formatNumber(uncategorizedWeight)} kg`;
            }

            const resultText = `
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--accent-green); margin-bottom: 15px;">Equipment: ${equipmentCode}</h3>
                    <p style="line-height: 1.8;"><strong>Date Range:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
                    <p style="line-height: 1.8;"><strong>Times Used:</strong> ${usageCount} sessions</p>
                    <p style="line-height: 1.8;"><strong>Total Weight Processed:</strong> ${formatNumber(totalWeight)} kg</p>
                    <p style="line-height: 1.8;"><strong>Category Breakdown:</strong> ${categoryBreakdown || ' None'}</p>
                </div>
            `;

            document.getElementById('equipment-results').innerHTML = resultText;
            updateEquipmentChart(categoryWeights, uncategorizedWeight);
        }

        function updateEquipmentChart(categoryWeights, uncategorizedWeight) {
            const ctx = document.getElementById('equipment-chart');
            
            const labels = [];
            const values = [];
            
            Object.keys(categoryWeights).forEach(cat => {
                if (categoryWeights[cat] > 0) {
                    labels.push(cat);
                    values.push(categoryWeights[cat]);
                }
            });
            
            if (uncategorizedWeight > 0) {
                labels.push('Other');
                values.push(uncategorizedWeight);
            }

            destroyChart('equipment-chart');
            
            chartInstances['equipment-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // PAGE 3: Daily Report
        function generateDailyReport() {
            const reportDate = document.getElementById('daily-report-date').valueAsDate;
            if (!reportDate) {
                alert('Please select a date');
                return;
            }

            const targetDate = new Date(reportDate);
            targetDate.setHours(0, 0, 0, 0);

            let dailyKilos = 0;
            let dailyEntries = 0;
            const categories = {};
            const products = {};
            const equipmentUsage = { mixers: {}, grinders: {} };

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate.getTime() === targetDate.getTime()) {
                    const product = row[1];
                    const weight = parseWeight(row[3]);
                    const equipmentCell = (row[10] || '').toString().toUpperCase();
                    
                    dailyKilos += weight;
                    dailyEntries++;

                    const category = detectCategory(product);
                    categories[category] = (categories[category] || 0) + weight;
                    products[product] = (products[product] || 0) + weight;

                    // Equipment tracking
                    const mixers = equipmentCell.match(/MX\d+/g) || [];
                    const grinders = equipmentCell.match(/GR\d+/g) || [];
                    
                    mixers.forEach(mx => {
                        equipmentUsage.mixers[mx] = (equipmentUsage.mixers[mx] || 0) + 1;
                    });
                    grinders.forEach(gr => {
                        equipmentUsage.grinders[gr] = (equipmentUsage.grinders[gr] || 0) + 1;
                    });
                }
            });

            // Filling data
            const uniqueProducts = new Set();
            let fillingHours = 0;

            allFillingData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate.getTime() === targetDate.getTime()) {
                    const product = row[1];
                    const batch = row[2];
                    if (product) {
                        uniqueProducts.add(`${product}|${batch}`);
                    }

                    const startTime = row[9];
                    const endTime = row[10];
                    if (startTime && endTime) {
                        fillingHours += calculateHours(startTime, endTime);
                    }
                }
            });

            // Calculate KPI
            const targetWeight = 30000;
            const targetProducts = 15;
            const targetHours = 8;

            const weightScore = Math.min(100, (dailyKilos / targetWeight) * 100);
            const productScore = Math.min(100, (uniqueProducts.size / targetProducts) * 100);
            const fillingScore = Math.min(100, (fillingHours / targetHours) * 100);
            const kpiScore = (weightScore * 0.4 + productScore * 0.3 + fillingScore * 0.3).toFixed(1);

            const kpiBadge = kpiScore >= 80 ? 'success' : (kpiScore >= 60 ? 'warning' : 'error');
            const kpiText = kpiScore >= 80 ? 'EXCELLENT' : (kpiScore >= 60 ? 'GOOD' : 'NEEDS IMPROVEMENT');

            const reportHTML = `
                <div class="grid">
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Total Weight</div>
                        <div class="kpi-value">${formatNumber(dailyKilos)} KG</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Entries</div>
                        <div class="kpi-value">${dailyEntries}</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Products Filled</div>
                        <div class="kpi-value">${uniqueProducts.size}</div>
                    </div>
                    <div class="kpi-card col-3">
                        <div class="kpi-label">Filling Hours</div>
                        <div class="kpi-value">${fillingHours.toFixed(1)} HRS</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Daily KPI Score</div>
                        <div class="kpi-value">${kpiScore}</div>
                        <div class="kpi-change"><span class="badge ${kpiBadge}">${kpiText}</span></div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Weight Score</div>
                        <div class="kpi-value" style="font-size: 24px;">${weightScore.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card col-4">
                        <div class="kpi-label">Product Score</div>
                        <div class="kpi-value" style="font-size: 24px;">${productScore.toFixed(1)}%</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Equipment Utilization Summary</h3>
                <div class="grid">
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-green);">Mixers Used</h4>
                        ${Object.keys(equipmentUsage.mixers).length > 0 ? 
                            Object.entries(equipmentUsage.mixers).map(([mx, count]) => 
                                `<p style="line-height: 1.8;"><strong>${mx}:</strong> ${count} sessions</p>`
                            ).join('') : 
                            '<p style="color: var(--text-secondary);">No mixer data</p>'
                        }
                    </div>
                    <div class="card col-6">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">Grinders Used</h4>
                        ${Object.keys(equipmentUsage.grinders).length > 0 ? 
                            Object.entries(equipmentUsage.grinders).map(([gr, count]) => 
                                `<p style="line-height: 1.8;"><strong>${gr}:</strong> ${count} sessions</p>`
                            ).join('') : 
                            '<p style="color: var(--text-secondary);">No grinder data</p>'
                        }
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Category Breakdown</h3>
                <div class="data-table">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Weight (KG)</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(categories).map(cat => {
                                    const pct = dailyKilos > 0 ? ((categories[cat] / dailyKilos) * 100).toFixed(1) : '0';
                                    return `
                                        <tr>
                                            <td>${cat}</td>
                                            <td>${formatNumber(categories[cat])}</td>
                                            <td>${pct}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Top Products</h3>
                <div class="data-table">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Weight (KG)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(products)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 10)
                                    .map(([product, weight]) => `
                                        <tr>
                                            <td>${product}</td>
                                            <td>${formatNumber(weight)}</td>
                                        </tr>
                                    `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('daily-report-content').innerHTML = reportHTML;
        }

        // PAGE 4: Product Analysis
        function analyzeProduct() {
            const productName = document.getElementById('product-name').value.trim();
            const startDate = document.getElementById('product-start-date').valueAsDate;
            const endDate = document.getElementById('product-end-date').valueAsDate;

            if (!productName || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
            }

            const normalizedSearch = normalizeProductName(productName);
            let totalWeight = 0;
            let batchCount = 0;
            const dailyWeights = {};

            allProductionData.slice(1).forEach(row => {
                if (!row[0] || !row[1]) return;
                
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const rowProduct = normalizeProductName(row[1]);
                    
                    if (rowProduct === normalizedSearch) {
                        const weight = parseWeight(row[3]);
                        totalWeight += weight;
                        batchCount++;

                        const dateKey = rowDate.toISOString().split('T')[0];
                        dailyWeights[dateKey] = (dailyWeights[dateKey] || 0) + weight;
                    }
                }
            });

            const avgBatch = batchCount > 0 ? totalWeight / batchCount : 0;

            document.getElementById('product-total-weight').textContent = formatNumber(totalWeight) + ' KG';
            document.getElementById('product-total-batches').textContent = batchCount;
            document.getElementById('product-avg-batch').textContent = formatNumber(avgBatch.toFixed(0)) + ' KG';

            updateProductTimelineChart(dailyWeights);
        }

        function updateProductTimelineChart(dailyWeights) {
            const ctx = document.getElementById('product-timeline-chart');
            
            const dates = Object.keys(dailyWeights).sort();
            const values = dates.map(date => dailyWeights[date]);
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            destroyChart('product-timeline-chart');

            chartInstances['product-timeline-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // PAGE 5: Auto Reports
        function generateAutoReports() {
            const today = new Date();
            
            const weekStart = getWeekStart(today);
            const weekEnd = getWeekEnd(weekStart);
            const weekData = getDataForRange(weekStart, weekEnd);
            
            document.getElementById('week-total').textContent = formatNumber(weekData.totalKilos) + ' KG';
            document.getElementById('week-products').textContent = Object.keys(weekData.products).length;
            document.getElementById('week-avg').textContent = formatNumber((weekData.totalKilos / 7).toFixed(0)) + ' KG';
            document.getElementById('week-dates').textContent = 
                weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' +
                weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            updateChart('weekly-chart', weekData.dailyHistory, 'line');

            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const monthData = getDataForRange(monthStart, monthEnd);
            
            document.getElementById('month-total').textContent = formatNumber(monthData.totalKilos) + ' KG';
            document.getElementById('month-products').textContent = Object.keys(monthData.products).length;
            const daysInMonth = monthEnd.getDate();
            document.getElementById('month-avg').textContent = formatNumber((monthData.totalKilos / daysInMonth).toFixed(0)) + ' KG';
            document.getElementById('month-name').textContent = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            updateChart('monthly-chart', monthData.dailyHistory, 'bar');
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1) - day;
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getWeekEnd(weekStart) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + 6);
            d.setHours(23, 59, 59, 999);
            return d;
        }

        function getDataForRange(startDate, endDate) {
            const data = {
                totalKilos: 0,
                entries: 0,
                products: {},
                categories: {},
                dailyHistory: {}
            };

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const product = row[1];
                    const weight = parseWeight(row[3]);
                    
                    data.totalKilos += weight;
                    data.entries++;

                    const category = detectCategory(product);
                    data.categories[category] = (data.categories[category] || 0) + weight;
                    data.products[product] = (data.products[product] || 0) + weight;

                    const dateKey = rowDate.toISOString().split('T')[0];
                    data.dailyHistory[dateKey] = (data.dailyHistory[dateKey] || 0) + weight;
                }
            });

            return data;
        }

        function updateChart(chartId, dailyHistory, type) {
            const ctx = document.getElementById(chartId);
            
            const dates = Object.keys(dailyHistory).sort();
            const values = dates.map(date => dailyHistory[date]);
            const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            destroyChart(chartId);

            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        borderColor: '#00ff88',
                        backgroundColor: type === 'line' ? 'rgba(0, 255, 136, 0.1)' : '#00b4ff',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: type === 'line',
                        borderRadius: type === 'bar' ? 6 : 0
                    }]
                },
                options: getChartOptions()
            };

            chartInstances[chartId] = new Chart(ctx, config);
        }

        // PAGE 6: Category Reports
        function generateCategoryReports() {
            const today = new Date();
            
            const weekStart = getWeekStart(today);
            const weekEnd = getWeekEnd(weekStart);
            const weekData = getDataForRange(weekStart, weekEnd);
            
            updateCategoryCharts('week', weekData.categories);

            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const monthData = getDataForRange(monthStart, monthEnd);
            
            updateCategoryCharts('month', monthData.categories);
            updateCategoryTable(weekData.categories, monthData.categories);
        }

        function updateCategoryCharts(period, categories) {
            const pieCtx = document.getElementById(`${period}-category-pie`);
            const barCtx = document.getElementById(`${period}-category-bar`);

            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            destroyChart(`${period}-category-pie`);
            destroyChart(`${period}-category-bar`);

            chartInstances[`${period}-category-pie`] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            chartInstances[`${period}-category-bar`] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        function updateCategoryTable(weekCategories, monthCategories) {
            const allCategories = new Set([
                ...Object.keys(weekCategories),
                ...Object.keys(monthCategories)
            ]);

            const weekTotal = Object.values(weekCategories).reduce((a, b) => a + b, 0);
            const monthTotal = Object.values(monthCategories).reduce((a, b) => a + b, 0);

            const tbody = document.getElementById('category-tbody');
            tbody.innerHTML = Array.from(allCategories).map(cat => {
                const weekWeight = weekCategories[cat] || 0;
                const monthWeight = monthCategories[cat] || 0;
                const weekPct = weekTotal > 0 ? ((weekWeight / weekTotal) * 100).toFixed(1) : '0';
                const monthPct = monthTotal > 0 ? ((monthWeight / monthTotal) * 100).toFixed(1) : '0';

                return `
                    <tr>
                        <td>${cat}</td>
                        <td>${formatNumber(weekWeight)}</td>
                        <td>${formatNumber(monthWeight)}</td>
                        <td>${weekPct}%</td>
                        <td>${monthPct}%</td>
                    </tr>
                `;
            }).join('');
        }

        // PAGE 7: Category Range
        function analyzeCategoryRange() {
            const startDate = document.getElementById('category-start-date').valueAsDate;
            const endDate = document.getElementById('category-end-date').valueAsDate;

            if (!startDate || !endDate) {
                alert('Please select both dates');
                return;
            }

            const categories = {};
            const categoryEntries = {};
            let totalWeight = 0;

            allProductionData.slice(1).forEach(row => {
                if (!row[0]) return;
                const date = parseDate(row[0]);
                if (!date) return;

                const rowDate = new Date(date);
                rowDate.setHours(0, 0, 0, 0);

                if (rowDate >= startDate && rowDate <= endDate) {
                    const product = row[1];
                    const weight = parseWeight(row[3]);
                    
                    const category = detectCategory(product);
                    categories[category] = (categories[category] || 0) + weight;
                    categoryEntries[category] = (categoryEntries[category] || 0) + 1;
                    totalWeight += weight;
                }
            });

            updateRangeCategoryCharts(categories);

            const tbody = document.getElementById('category-range-tbody');
            tbody.innerHTML = Object.keys(categories).map(cat => {
                const weight = categories[cat];
                const pct = totalWeight > 0 ? ((weight / totalWeight) * 100).toFixed(1) : '0';
                const entries = categoryEntries[cat];

                return `
                    <tr>
                        <td>${cat}</td>
                        <td>${formatNumber(weight)}</td>
                        <td>${pct}%</td>
                        <td>${entries}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateRangeCategoryCharts(categories) {
            const pieCtx = document.getElementById('range-category-pie');
            const barCtx = document.getElementById('range-category-bar');

            const labels = Object.keys(categories);
            const values = Object.values(categories);
            const colors = ['#00ff88', '#00b4ff', '#ffd93d', '#ff4757', '#a55eea', '#26de81', '#fd79a8'];

            destroyChart('range-category-pie');
            destroyChart('range-category-bar');

            chartInstances['range-category-pie'] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions(),
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e4e8f0',
                                font: { size: 11, family: 'JetBrains Mono' }
                            }
                        }
                    }
                }
            });

            chartInstances['range-category-bar'] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (KG)',
                        data: values,
                        backgroundColor: '#00b4ff',
                        borderRadius: 6
                    }]
                },
                options: getChartOptions()
            });
        }

        // Utility Functions
        function parseDate(dateValue) {
            if (!dateValue) return null;
            if (dateValue instanceof Date && !isNaN(dateValue.getTime())) return dateValue;
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                if (!isNaN(date.getTime())) return date;
            }
            
            const dateStr = dateValue.toString().trim();
            const dmyMatch = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if (dmyMatch) {
                let day = parseInt(dmyMatch[1]);
                let month = parseInt(dmyMatch[2]) - 1;
                let year = parseInt(dmyMatch[3]);
                if (year < 100) year += 2000;
                return new Date(year, month, day);
            }
            
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) return date;
            return null;
        }

        function parseWeight(weightValue) {
            if (!weightValue) return 0;
            const cleanValue = weightValue.toString().replace(/[^\d.]/g, '');
            const weight = parseFloat(cleanValue);
            return isNaN(weight) ? 0 : weight;
        }

        function formatDate(dateValue) {
            const date = parseDate(dateValue);
            if (!date) return '-';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(timeValue) {
            if (!timeValue) return '-';
            if (typeof timeValue === 'string' && timeValue.includes(':')) return timeValue;
            if (timeValue instanceof Date) {
                return timeValue.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }
            return timeValue;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        function detectCategory(product) {
            if (!product) return 'OTHER';
            const name = product.toString().toUpperCase();
            
            if (/\bBASE\b/.test(name)) return 'BASE';
            if (/\bNC\b/.test(name)) return 'NC';
            if (/\bSYNTHETIC\b/.test(name)) return 'SYNTHETIC';
            if (/\bENAMEL\b/.test(name)) return 'ENAMEL';
            if (/\bPU\b/.test(name)) return 'PU';
            if (/\bEPOXY\b/.test(name)) return 'EPOXY';
            if (/\bHARDENER\b/.test(name)) return 'HARDENER';
            
            return 'OTHER';
        }

        function normalizeProductName(name) {
            if (!name) return '';
            return name.toString().toUpperCase().trim().split(/\s+/).filter(w => w.length > 0).sort().join(' ');
        }

        function calculateHours(startTime, endTime) {
            try {
                let start, end;
                
                if (typeof startTime === 'number') {
                    start = startTime * 24;
                } else if (typeof startTime === 'string') {
                    const parts = startTime.match(/(\d+):(\d+)/);
                    if (parts) {
                        start = parseInt(parts[1]) + parseInt(parts[2]) / 60;
                    } else return 0;
                } else if (startTime instanceof Date) {
                    start = startTime.getHours() + startTime.getMinutes() / 60;
                } else return 0;
                
                if (typeof endTime === 'number') {
                    end = endTime * 24;
                } else if (typeof endTime === 'string') {
                    const parts = endTime.match(/(\d+):(\d+)/);
                    if (parts) {
                        end = parseInt(parts[1]) + parseInt(parts[2]) / 60;
                    } else return 0;
                } else if (endTime instanceof Date) {
                    end = endTime.getHours() + endTime.getMinutes() / 60;
                } else return 0;
                
                let diff = end - start;
                if (diff < 0) diff += 24;
                return diff;
            } catch (err) {
                return 0;
            }
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { color: '#2a3142', drawBorder: false },
                        ticks: { color: '#8892a6', font: { size: 10, family: 'JetBrains Mono' } }
                    },
                    y: {
                        grid: { color: '#2a3142', drawBorder: false },
                        ticks: { color: '#8892a6', font: { size: 10, family: 'JetBrains Mono' } }
                    }
                }
            };
        }

        // Initialize
        init();
    </script>
</body>
</html>